<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="theme-color" content="#0b0c0f">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫ ‚Äî —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞</title>

<style>
  :root{
    --vh: 1vh;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);

    --bg:#0b0c0f;
    --panel:#0f1114;
    --muted:#9aa0a6;
    --accent:#ff6b3d;
    --accent-2:#ff3b30;
    --glass: rgba(255,255,255,0.03);
    --success:#59e391;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, 'Helvetica Neue', Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; background:linear-gradient(180deg,var(--bg),#071014); color:#e6eef3; display:flex; align-items:stretch; justify-content:center;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    background-attachment: fixed;
  }
  .app{
    width:100%; max-width:420px; height:720px; margin:24px; border-radius:20px; overflow:hidden; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2)); box-shadow:0 8px 30px rgba(0,0,0,0.7);
    display:flex; flex-direction:column;
  }
  header{
    padding:18px 18px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
  }
  header h1{font-size:16px; margin:0}
  .top-actions{display:flex; gap:8px; align-items:center}
  button.icon-btn{background:var(--glass); border:1px solid rgba(255,255,255,0.03); color:var(--muted); padding:8px 10px; border-radius:10px; display:inline-flex; gap:8px; align-items:center; cursor:pointer}
  main{flex:1; overflow:auto; padding-bottom: 96px; padding:16px}

  .habit-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); padding:14px; border-radius:14px; border:1px solid rgba(255,255,255,0.03); margin-bottom:12px}
  .habit-title{display:flex; align-items:center; gap:12px}
  .color-dot{width:12px; height:12px; border-radius:4px}
  .progress{margin-top:12px}
  .bar{height:12px; background:rgba(255,255,255,0.04); border-radius:8px; overflow:hidden}
  .bar > i{display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); width:0%}
  .sub{font-size:12px; color:var(--muted); margin-top:6px}

  .calendar{margin-top:14px;}
  .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
  .cal-cell{background:rgba(255,255,255,0.02); border-radius:8px; min-height:56px; padding:6px; display:flex; flex-direction:column; justify-content:space-between}
  .cal-cell .day{font-weight:600}
  .cal-cell.done{background:linear-gradient(180deg, rgba(89,227,145,0.08), rgba(0,0,0,0.04)); border:1px solid rgba(89,227,145,0.12)}
  .cal-head{display:flex; justify-content:space-between; align-items:center}

  .today-task{margin-top:14px; display:flex; gap:10px; align-items:center}
  .check{width:48px; height:48px; border-radius:12px; display:grid; place-items:center; cursor:pointer; border:1px solid rgba(255,255,255,0.03); background:var(--panel)}
  .task-info{flex:1}
  .complete{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff}

  .chat{display:flex; flex-direction:column; height:100%}
  .messages{flex:1; overflow:auto; padding:8px; display:flex; flex-direction:column; gap:10px}
  .bubble{max-width:78%; padding:10px 12px; border-radius:12px}
  .bubble.bot{align-self:flex-start; background:rgba(255,255,255,0.03)}
  .bubble.you{align-self:flex-end; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#000}
  .chat-input{display:flex; gap:8px; padding:12px}
  input[type=text]{flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}

  .profile{display:flex; flex-direction:column; align-items:center; gap:12px}
  .avatar{width:120px; height:120px; border-radius:50%; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); display:grid; place-items:center; overflow:hidden; border:2px solid rgba(255,255,255,0.03)}
  .avatar img{width:100%; height:100%; object-fit:cover}
  .name{font-weight:700; font-size:18px}
  .streak{font-size:14px; color:var(--muted)}
  .medals{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; justify-content:center}
  .medal{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); border-radius:12px; padding:10px; width:120px; text-align:center; border:1px solid rgba(255,255,255,0.03)}
  .medal small{display:block; color:var(--muted); font-size:12px; margin-top:8px}

  nav.bottom{position:sticky; bottom:0; z-index:100; pointer-events:auto; height:78px; display:flex; align-items:center; justify-content:space-around; gap:10px; padding:12px; border-top:1px solid rgba(255,255,255,0.02); background:linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.06))}
  .nav-btn{cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:6px; color:var(--muted); position:relative}
  .nav-btn.active{color:var(--accent)}
  .nav-badge{position:absolute; right:10px; top:4px; font-size:12px;}

  .muted{color:var(--muted)}
  .hidden{display:none}
  .flex{display:flex}

  .today-check{
    transition: background 0.15s ease, box-shadow 0.15s ease;
    border-radius: 10px;
    padding: 6px 10px;
  }
  .today-check.done{
    background: #06d6a0;
    box-shadow: 0 2px 8px rgba(6,214,160,0.25);
  }

  * { scrollbar-width: none; }
  *::-webkit-scrollbar { width: 0; height: 0; display: none; }
  html, body { -ms-overflow-style: none; }

  .series-chip-gold{ white-space:nowrap; }
  .series-chip-gold .series-text{ display:inline !important; font-weight:800; font-size:13px; letter-spacing:.2px; color:#1a1400 !important; text-shadow:0 1px 0 rgba(255,255,255,.35); }
  .series-chip-gold .flame{ font-size:16px; line-height:1; }

  .series-chip-gold{
    font-size:13px !important;
    line-height:1.1 !important;
    min-height:28px;
    padding:6px 10px !important;
    display:inline-flex !important;
    align-items:center !important;
    gap:8px !important;
    white-space:nowrap !important;
  }
  .series-chip-gold *{
    font-size:13px !important;
    line-height:1.1 !important;
    color:#1a1400 !important;
  }
  .series-chip-gold .series-text{
    display:inline !important;
    visibility:visible !important;
    opacity:1 !important;
  }

  .habit-card.done-today, .habit-card.habit-done {
    opacity: 0.6;
    background: linear-gradient(180deg, rgba(89,227,145,0.08), rgba(0,0,0,0.05));
    border: 1px solid rgba(89,227,145,0.15);
    transition: all 0.3s ease;
  }
  .habit-card.done-today:hover, .habit-card.habit-done:hover {
    opacity: 0.9;
    transform: scale(1.02);
  }

  .habit-done .today-task { display: none !important; }

  .badge .value{ white-space: nowrap; display:block; }
  .badge .label{ display:block; }

  .color-dot{display:none!important}

  @media (max-width: 1024px){
    .app{
      max-width: 100% !important;
      width: 100% !important;
      height: calc(var(--vh, 1vh) * 100) !important;
      margin: 0 !important;
      border-radius: 0 !important;
    }
    nav.bottom{
      position: fixed !important;
      left: 0; right: 0; bottom: 0;
      width: 100%;
      z-index: 1000;
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)) !important;
      background: linear-gradient(180deg, var(--bg), #071014) !important;
      border-top: 1px solid rgba(255,255,255,0.06) !important;
    }
    main{
      padding-bottom: calc(110px + env(safe-area-inset-bottom, 0px)) !important;
    }
  }

  @media (max-width: 600px) {
    body{ background-attachment: fixed; }
    .app{ max-width: 100%; width: 100%; height: calc(var(--vh, 1vh) * 100); margin: 0; border-radius: 0; }
    header{ padding-top: calc(14px + var(--safe-top)); padding-left: max(12px, var(--safe-left)); padding-right: max(12px, var(--safe-right)); }
    main{ padding: 12px 12px 96px; }
    nav.bottom{ height: auto; min-height: 66px; padding-bottom: calc(12px + var(--safe-bottom)); padding-left: max(8px, var(--safe-left)); padding-right: max(8px, var(--safe-right)); gap: 14px; }
    .nav-btn{ font-size: 12px; }
    .nav-btn svg{ width: 22px; height: 22px; }
    .habit-card{ padding: 12px; border-radius: 16px; }
    .habit-title{ gap: 10px; }
    .today-task{ gap: 10px; }
    .check{ width: 48px; height: 48px; }
    button.icon-btn{ padding: 10px 12px; border-radius: 12px; }
    input[type=text]{ padding: 12px; font-size: 16px; }
    .chat-input{ padding: 12px; }
    .messages{ padding: 8px; }
    .bubble{ font-size: 15px; }
    .cal-grid{ gap: 6px; }
    .cal-cell{ min-height: 44px; padding: 6px; }
    .cal-cell .day{ font-size: 13px; }
  }

  @media (max-width: 360px) {
    .cal-cell{ min-height: 40px; }
    .check{ width: 44px; height: 44px; }
    .habit-card{ padding: 10px; }
    header h1{ font-size: 15px; }
  }

  @media (prefers-reduced-motion: reduce) {
    *{ animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: .01ms !important; scroll-behavior: auto !important; }
  }
</style>

<script>
  // 100dvh fix for iOS Safari
  (function(){
    function setVH(){
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', vh + 'px');
    }
    setVH();
    window.addEventListener('resize', setVH, {passive:true});
    window.addEventListener('orientationchange', setVH, {passive:true});
  })();
</script>

</head>
<body data-avatar-ready="1">
<div class="app" role="application">
  <header>
    <h1 id="header-title">–ü—Ä–∏–≤—ã—á–∫–∏</h1>
  </header>
  <main>
    <section class="view" id="view-habit">
      <div id="habit-list"></div>
      <div class="habit-card" id="trash-panel" style="display:none;">
        <div style="font-weight:700; margin-bottom:8px">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div class="sub" id="trash-list">–ü—É—Å—Ç–æ</div>
      </div>
    </section>

    <section class="view hidden" id="view-chat">
      <div class="chat" style="height:100%">
        <div class="messages" id="messages"></div>
        <div class="chat-input">
          <input autocomplete="off" id="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." type="text"/>
          <button class="icon-btn" id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="habit-card" id="trash-panel-chat" style="margin-top:12px; display:none;">
        <div style="font-weight:700; margin-bottom:8px">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div class="sub" id="trash-list-chat">–ü—É—Å—Ç–æ</div>
      </div>
    </section>

    <section class="view hidden" id="view-profile">
      <div class="profile">
        <label class="avatar" id="avatar-label">
          <img alt="avatar" class="hidden" id="avatar-img" src=""/>
          <div id="avatar-placeholder">üë§</div>
          <input accept="image/*" id="avatar-input" style="display:none" type="file"/>
        </label>
        <div>
          <div class="name" id="profile-name">–ì–æ—Å—Ç—å</div>
          <div class="streak" id="profile-streak">Streak: 0</div>
        </div>
        <h3 style="margin-top:16px">–ù–∞–≥—Ä–∞–¥—ã</h3>
        <div class="medals" id="medals"></div>
      </div>
    </section>
  </main>

  <nav class="bottom">
    <div class="nav-btn active" data-view="view-habit" id="nav-1">
      <svg fill="none" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"></path><path d="M5 12h14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"></path></svg>
      <div style="font-size:12px">–ó–∞–¥–∞–Ω–∏—è</div>
      <span class="nav-badge">‚úì</span>
    </div>
    <div class="nav-btn" data-view="view-chat" id="nav-2">
      <svg fill="none" height="22" viewBox="0 0 24 24" width="22"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4"></path></svg>
      <div style="font-size:12px">–ß–∞—Ç</div>
    </div>
    <div class="nav-btn" data-view="view-profile" id="nav-3">
      <svg fill="none" height="22" viewBox="0 0 24 24" width="22"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4"></path><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.4"></circle></svg>
      <div style="font-size:12px">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>
  </nav>
</div>

<script>
(function(){
  const STORAGE_KEY = 'habit_traker_demo_v3';
  function isoDate(d){ const t=new Date(d.getFullYear(), d.getMonth(), d.getDate()); return t.toISOString().slice(0,10); }
  function daysBetween(a,b){ const ms = (new Date(b) - new Date(a)); return Math.max(0, Math.round(ms/86400000)+1); }

  const defaultState = { profile: {name:'–ì–æ—Å—Ç—å', avatar: '', streak:0}, habits: [], trash: [], currentHabitId: null };

  function saveState(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){} }
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return JSON.parse(JSON.stringify(defaultState));
      const s = JSON.parse(raw);
      if(!('trash' in s)) s.trash = [];
      return s;
    }catch(e){ return JSON.parse(JSON.stringify(defaultState)); }
  }

  // DOM
  const views = Array.from(document.querySelectorAll('.view'));
  const navBtns = Array.from(document.querySelectorAll('.nav-btn'));
  const headerTitle = document.getElementById('header-title');
  const listRoot = document.getElementById('habit-list');
  const trashPanel = document.getElementById('trash-panel');
  const trashList = document.getElementById('trash-list');

  const sendBtn = document.getElementById('send-btn');
  const chatInput = document.getElementById('chat-input');
  const messages = document.getElementById('messages');

  const profileNameEl = document.getElementById('profile-name');
  const profileStreakEl = document.getElementById('profile-streak');
  const avatarImg = document.getElementById('avatar-img');
  const avatarPlaceholder = document.getElementById('avatar-placeholder');
  const avatarInput = document.getElementById('avatar-input');
  const avatarLabel = document.getElementById('avatar-label');

  let state = loadState();
  if(!('pending' in state)) state.pending = null;

  // === Mistral integration (via your backend /api/mistral) ===
  const API_URL = '/api/mistral';
  const SYSTEM_PROMPT = `
–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫.
–°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π –ø—Ä–∞–≤–∏–ª–∞–º:
1) –°–Ω–∞—á–∞–ª–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ —Å –∏–∑–º–µ—Ä–∏–º–æ–π —Ü–µ–ª—å—é.
2) –£—Ç–æ—á–Ω—è–µ—Ç—Å—è —Å—Ä–æ–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è (‚â•1 –º–µ—Å—è—Ü; –¥–ª—è –æ—Ç–∫–∞–∑–∞ –æ—Ç –≤—Ä–µ–¥–Ω–æ–π ‚Äî ‚â•2 –º–µ—Å—è—Ü–∞).
3) –£—Ç–æ—á–Ω—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
4) –°–æ—Å—Ç–∞–≤—å –ø–æ–º–æ–¥–Ω–µ–≤–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ –≤–µ—Å—å —Å—Ä–æ–∫, –¥–µ–ª—è –Ω–∞ 4 —á–µ—Ç–≤–µ—Ä—Ç–∏:
   Q1: 15‚Äì20% —Ü–µ–ª–∏; Q2: 40‚Äì45%; Q3: 70‚Äì75%; Q4: 75‚Äì100% (–ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å = 100%).
   ‚Ä¢ 1-—è –Ω–µ–¥–µ–ª—è ¬´—Å–º–µ—à–Ω–æ –ª—ë–≥–∫–∞—è¬ª, –ø–µ—Ä–≤—ã–µ 2‚Äì3 –¥–Ω—è ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞.
   ‚Ä¢ –ö–∞–∂–¥—ã–π –¥–µ–Ω—å —É–Ω–∏–∫–∞–ª–µ–Ω.
   ‚Ä¢ –†–æ—Å—Ç –ø–ª–∞–≤–Ω—ã–π: —Å–Ω–∞—á–∞–ª–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø—Ä–∏–±–∞–≤–∫–∏, –≤ –∫–æ–Ω—Ü–µ –±–æ–ª—å—à–µ.
   ‚Ä¢ –¢–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã.
5) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–¥ —Å–≤–æ—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.
6) –í –≠–¢–û–ú –í–´–í–û–î–ï —Å–æ–≤–µ—Ç–æ–≤ –Ω–µ –¥–∞–≤–∞—Ç—å.

–í—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û JSON —Å—Ç—Ä–æ–≥–æ —ç—Ç–æ–≥–æ –≤–∏–¥–∞ (–±–µ–∑ —Ç–µ–∫—Å—Ç–∞/markdown):
{
  "habit": "—Å—Ç—Ä–æ–∫–∞",
  "duration_days": <—á–∏—Å–ª–æ>,
  "start_date": "YYYY-MM-DD",
  "plan": [
    { "day": 1, "task": "—Å—Ç—Ä–æ–∫–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–Ω—è 1" },
    ...
    { "day": <duration_days>, "task": "..." }
  ]
}
`;

  function parseMaybeJSON(s){
    try { return JSON.parse(s); } catch(e){}
    const m = String(s||'').match(/\{[\s\S]*\}$/);
    if(m){ try { return JSON.parse(m[0]); } catch(e){} }
    return null;
  }

  async function generatePlanForHabit(h){
    if(!h || !h.targetDays) return;
    const payloadForUser = {
      habit: h.name,
      duration_days: h.targetDays,
      baseline: h.baseline || null,
      locale: "ru-RU"
    };

    let r=null, j=null, data=null;
    try{
      r = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ system: SYSTEM_PROMPT, user: JSON.stringify(payloadForUser) })
      });
      j = await r.json();
      data = parseMaybeJSON(j?.content);
    }catch(e){}

    if(data && Array.isArray(data.plan)){
      h.plan = {
        start: h.start,
        items: data.plan
          .filter(x => Number.isFinite(x.day) && x.task)
          .map(x => ({ day: Number(x.day), text: String(x.task).trim() }))
          .slice(0, h.targetDays)
      };
      saveState(state); renderAll();
    } else {
      // fallback
      h.plan = {
        start: h.start,
        items: Array.from({length: h.targetDays}, (_,i)=>({ day: i+1, text: `–ú–∏–Ω–∏-—à–∞–≥ ‚Ññ${i+1} –¥–ª—è ¬´${h.name}¬ª` }))
      };
      saveState(state); renderAll();
    }
  }

  function getTodayTaskText(h){
    if(!h || !h.plan || !Array.isArray(h.plan.items)) return '';
    const today = new Date();
    const dayIdx = Math.max(1, Math.min(
      h.targetDays || h.plan.items.length,
      (Math.round((new Date(today.getFullYear(), today.getMonth(), today.getDate()) - new Date(h.start))/86400000)+1)
    ));
    const it = h.plan.items.find(x=>x.day===dayIdx);
    return it?.text || '';
  }

  const COLOR_PALETTE = ['#ff6b3d', '#ff3b30', '#59e391', '#4da3ff', '#c792ea', '#ffd166', '#06d6a0', '#f469a9'];
  function uid(){ return 'h' + Math.random().toString(36).slice(2,9); }
  function pickColor(){
    const used = state.habits.map(h=>h.color).filter(Boolean);
    for(const c of COLOR_PALETTE){ if(!used.includes(c)) return c; }
    return COLOR_PALETTE[Math.floor(Math.random()*COLOR_PALETTE.length)];
  }

  function createHabit(name){
    if(state.pending && state.pending.type==='duration') state.pending = null;
    const n = (name||'–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞').trim();
    const id = uid();
    const h = {
      id, name: n, color: pickColor(),
      start: isoDate(new Date()),
      days: [],
      targetDays: null,
      baseline: null,
      plan: null
    };
    state.habits.unshift(h);
    state.currentHabitId = id;
    saveState(state);
    renderAll();
    return h;
  }

  function showView(id){
    views.forEach(v=> v.id===id? v.classList.remove('hidden') : v.classList.add('hidden'));
    navBtns.forEach(b=> b.dataset.view===id ? b.classList.add('active') : b.classList.remove('active'));
    if(id==='view-habit') headerTitle.textContent = '–ü—Ä–∏–≤—ã—á–∫–∏';
    else if(id==='view-chat') headerTitle.textContent = '–ß–∞—Ç';
    else if(id==='view-profile') headerTitle.textContent = '–ü—Ä–æ—Ñ–∏–ª—å';
  }

  function renderCalendar(h, wrapper, ym){
    wrapper.innerHTML = '';
    const head = document.createElement('div'); head.className='cal-head';
    const monthLabel = document.createElement('div'); monthLabel.className='muted';
    const ctrls = document.createElement('div'); ctrls.style.display='flex'; ctrls.style.gap='8px';
    const prev = document.createElement('button'); prev.className='icon-btn'; prev.textContent='‚óÄ';
    const next = document.createElement('button'); next.className='icon-btn'; next.textContent='‚ñ∂';
    ctrls.appendChild(prev); ctrls.appendChild(next);
    head.appendChild(monthLabel); head.appendChild(ctrls);
    const grid = document.createElement('div'); grid.className='cal-grid';
    wrapper.appendChild(head); wrapper.appendChild(grid);

    const base = ym || { y:new Date().getFullYear(), m:new Date().getMonth() };
    let Y = base.y, M = base.m;

    function draw(y, m){
      grid.innerHTML='';
      const first = new Date(y,m,1);
      const last = new Date(y,m+1,0);
      monthLabel.textContent = first.toLocaleString('ru-RU', {month:'long', year:'numeric'});
      const wk=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
      wk.forEach(w=>{ const el=document.createElement('div'); el.className='cal-cell'; el.style.background='transparent'; el.style.minHeight='18px'; el.style.padding='6px 0'; el.style.display='flex'; el.style.alignItems='center'; el.style.justifyContent='center'; el.style.fontSize='12px'; el.textContent=w; grid.appendChild(el); });
      let startDay = first.getDay(); startDay = startDay===0?7:startDay;
      for(let i=1;i<startDay;i++){ const el=document.createElement('div'); el.className='cal-cell'; el.style.opacity=.1; grid.appendChild(el); }
      const todayKey = isoDate(new Date());
      for(let d=1; d<=last.getDate(); d++){
        const dateStr = isoDate(new Date(y,m,d));
        const cell=document.createElement('div'); cell.className='cal-cell';
        const top=document.createElement('div'); top.className='day'; top.textContent=d; cell.appendChild(top);
        const dot=document.createElement('div'); dot.style.height='8px'; dot.style.width='8px'; dot.style.borderRadius='6px'; dot.style.marginTop='6px';
        if(h.days.includes(dateStr)){ cell.classList.add('done'); dot.style.background='var(--success)'; } else { dot.style.background='transparent'; }
        cell.appendChild(dot);
        if(dateStr === todayKey){
          cell.style.cursor='pointer'; cell.title='–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è';
          cell.addEventListener('click', ()=>{
            if(h.days.includes(todayKey)){ h.days = h.days.filter(x=>x!==todayKey); } else { h.days.push(todayKey); }
            saveState(state); draw(y,m); renderAll();
          });
        } else {
          cell.style.pointerEvents='none'; cell.title='–ú–æ–∂–Ω–æ –æ—Ç–º–µ—á–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å'; cell.style.opacity = 0.85;
        }
        grid.appendChild(cell);
      }
    }
    draw(Y,M);
    prev.addEventListener('click', ()=>{ M--; if(M<0){M=11; Y--;} draw(Y,M); });
    next.addEventListener('click', ()=>{ M++; if(M>11){M=0; Y++;} draw(Y,M); });
  }

  function computeStreak(){
    let streak = 0;
    if(!state.habits || state.habits.length === 0) return 0;
    const d = new Date();
    while(true){
      const key = isoDate(d);
      const anyDone = state.habits.some(h => Array.isArray(h.days) && h.days.includes(key));
      if(anyDone){ streak++; d.setDate(d.getDate()-1); } else { break; }
    }
    return streak;
  }

  function renderProfile(){
    try{
      profileNameEl.textContent = state?.profile?.name || '–ì–æ—Å—Ç—å';
      const src = state?.profile?.avatar || '';
      if(src){
        avatarImg.src = src;
        avatarImg.classList.remove('hidden');
        avatarPlaceholder.style.display = 'none';
      } else {
        avatarImg.src = '';
        avatarImg.classList.add('hidden');
        avatarPlaceholder.style.display = 'grid';
      }
      const s = computeStreak();
      state.profile.streak = s;
      saveState(state);
      profileStreakEl.textContent = 'Streak: ' + s;
    }catch(e){}
  }

  function computeProgress(h){
    const elapsed = Math.max(1, daysBetween(h.start, isoDate(new Date())));
    const total = h.targetDays ? Math.max(1, h.targetDays) : elapsed;
    const done = Math.min(h.days.length, total);
    const pct = Math.min(100, Math.round(done/total*100));
    return {elapsed, total, done, pct};
  }

  function setNavBadge(doneToday){
    const navBadge = document.querySelector('#nav-1 .nav-badge'); if(!navBadge) return;
    try{
      const today=isoDate(new Date());
      const lit = sessionStorage.getItem('badgeLitDate') === today;
      navBadge.style.display = (doneToday && lit) ? 'block' : 'none';
    } catch(e){
      navBadge.style.display = doneToday ? 'block' : 'none';
    }
  }

  function renderTrash(){
    if(!trashPanel || !trashList) return;
    if(!state.trash || state.trash.length===0){
      trashPanel.style.display='none';
      trashList.textContent='–ü—É—Å—Ç–æ';
      return;
    }
    trashPanel.style.display='block';
    trashList.innerHTML='';
    state.trash.forEach(h=>{
      const row = document.createElement('div');
      row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 0';
      const left = document.createElement('div'); left.textContent = h.name; left.className='sub';
      const btn = document.createElement('button'); btn.className='icon-btn'; btn.textContent='–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
      btn.addEventListener('click', ()=> restoreHabit(h.id));
      row.appendChild(left); row.appendChild(btn);
      trashList.appendChild(row);
    });
  }

  function deleteHabit(id){
    const idx = state.habits.findIndex(h=>h.id===id);
    if(idx<0) return;
    const [removed] = state.habits.splice(idx,1);
    state.trash.unshift(removed);
    state.currentHabitId = state.habits.length ? state.habits[0].id : null;
    saveState(state);
    renderAll(); renderTrash();
  }
  function restoreHabit(id){
    const idx = state.trash.findIndex(h=>h.id===id);
    if(idx<0) return;
    const [restored] = state.trash.splice(idx,1);
    state.habits.unshift(restored);
    state.currentHabitId = restored.id;
    saveState(state);
    renderAll(); renderTrash();
  }

  function renderAll(){
    listRoot.innerHTML='';
    if(!state.habits.length){
      const empty = document.createElement('div');
      empty.className='sub';
      empty.textContent='–ù–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫. –î–æ–±–∞–≤—å—Ç–µ —á–µ—Ä–µ–∑ —á–∞—Ç –Ω–∏–∂–µ: –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∑–∞—Ç–µ–º —É–∫–∞–∂–∏—Ç–µ —Å—Ä–æ–∫ (–≤ –¥–Ω—è—Ö).';
      listRoot.appendChild(empty);
      setNavBadge(false);
      renderTrash();
      return;
    }

    let anyDoneToday = false;
    function isCompleted(h){
      return !!(h && typeof h.targetDays==='number' && Array.isArray(h.days) && h.days.length >= Math.max(1, h.targetDays));
    }
    const incomplete = state.habits.filter(h => !isCompleted(h));
    const complete   = state.habits.filter(h =>  isCompleted(h));

    [...incomplete, ...complete].forEach(h=>{
      const {total, done, pct} = computeProgress(h);
      const card = document.createElement('div'); card.className='habit-card';
      if(isCompleted(h)){ card.classList.add('done-today','habit-done'); }

      // Title
      const title = document.createElement('div'); title.className='habit-title';
      const titleWrap = document.createElement('div'); titleWrap.style.flex='1';
      const nameEl = document.createElement('div'); nameEl.style.fontWeight='700'; nameEl.style.fontSize='16px'; nameEl.textContent = h.name;
      const durationEl = document.createElement('div'); durationEl.className='sub'; durationEl.textContent = `–°—Ä–æ–∫: ${total} –¥–Ω.`;
      titleWrap.appendChild(nameEl); titleWrap.appendChild(durationEl);
      const right = document.createElement('div'); right.style.textAlign='right';
      const subProg = document.createElement('div'); subProg.className='sub'; subProg.textContent='–ü—Ä–æ–≥—Ä–µ—Å—Å';
      const pctEl = document.createElement('div'); pctEl.className='sub'; pctEl.textContent = pct+'%';
      right.appendChild(subProg); right.appendChild(pctEl);
      const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.title='–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É'; delBtn.textContent='üóëÔ∏è';
      delBtn.style.marginLeft='8px';
      delBtn.addEventListener('click', ()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É –≤ –∫–æ—Ä–∑–∏–Ω—É?')) deleteHabit(h.id); });
      title.appendChild(titleWrap); title.appendChild(right); title.appendChild(delBtn);
      card.appendChild(title);

      // Progress bar
      const progress = document.createElement('div'); progress.className='progress';
      const bar = document.createElement('div'); bar.className='bar';
      const fill = document.createElement('i'); fill.style.width = pct+'%';
      bar.appendChild(fill);
      const sub = document.createElement('div'); sub.className='sub'; sub.textContent = `${done} / ${total} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`;
      progress.appendChild(bar); progress.appendChild(sub);
      card.appendChild(progress);

      // === Today row (fixed) ===
      const todayRow = document.createElement('div'); todayRow.className='today-task';
      const todayKey = isoDate(new Date());
      const doneToday = h.days.includes(todayKey); if(doneToday) anyDoneToday = true;

      const check = document.createElement('div');
      check.className = 'check today-check' + (doneToday ? ' done' : '');
      check.textContent = '‚úî';
      check.addEventListener('click', ()=>{
        if(h.days.includes(todayKey)){ h.days = h.days.filter(d=>d!==todayKey); } else { h.days.push(todayKey); }
        saveState(state); renderAll();
      });

      const ti = document.createElement('div'); ti.className = 'task-info';
      const todayIdx = Math.max(1, Math.min(total, daysBetween(h.start, todayKey)));
      const todayText = getTodayTaskText(h);

      const tt = document.createElement('div'); tt.style.fontWeight='700'; tt.textContent = todayText || '–°–µ–≥–æ–¥–Ω—è';
      const ts = document.createElement('div'); ts.className='sub'; ts.textContent = `–î–µ–Ω—å ${todayIdx} –∏–∑ ${total}`;

      ti.appendChild(tt);
      ti.appendChild(ts);

      const muted = document.createElement('div'); muted.className='muted'; muted.textContent = doneToday ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ';

      todayRow.appendChild(check); todayRow.appendChild(ti); todayRow.appendChild(muted);
      card.appendChild(todayRow);

      // Toggle calendar
      const toggleWrap = document.createElement('div'); toggleWrap.style.marginTop='10px'; toggleWrap.style.display='flex'; toggleWrap.style.gap='8px';
      const toggleBtn = document.createElement('button'); toggleBtn.className='icon-btn'; toggleBtn.textContent='–ö–∞–ª–µ–Ω–¥–∞—Ä—å';
      toggleWrap.appendChild(toggleBtn);
      card.appendChild(toggleWrap);

      const cal = document.createElement('div'); cal.className='calendar hidden';
      card.appendChild(cal);

      let calRendered = false;
      toggleBtn.addEventListener('click', ()=>{
        cal.classList.toggle('hidden');
        if(!calRendered){ renderCalendar(h, cal); calRendered = true; }
      });

      listRoot.appendChild(card);
    });

    setNavBadge(anyDoneToday);
    renderTrash();
    renderProfile();
  }

  function pushMsg(text, from='you'){
    const b = document.createElement('div');
    b.className = from==='you' ? 'bubble you' : 'bubble bot';
    b.textContent = text;
    messages.appendChild(b);
    messages.scrollTop = messages.scrollHeight;
  }

  function parseHabitIntent(text){
    const t = text.trim();
    let clean = t.replace(/\s+/g,' ').trim();
    const numMatch = clean.match(/(\d{1,3})/);
    const days = numMatch ? Math.max(1, Math.min(365, parseInt(numMatch[1],10))) : null;

    let name = clean
      .replace(/^(–¥–æ–±–∞–≤(—å|–∏)|–¥–æ–±–∞–≤–∏—Ç—å|—Å–æ–∑–¥–∞–π|—Å–æ–∑–¥–∞—Ç—å|–ø—Ä–∏–±–∞–≤—å|—Å–¥–µ–ª–∞–π)\s*/i,'')
      .replace(/\b–Ω–∞\s+\d{1,3}\s*(–¥–Ω(—è|–µ–π)?|–¥–Ω—è|–¥–Ω–µ–π)?\b/gi,'')
      .replace(/\b\d{1,3}\s*(–¥–Ω(—è|–µ–π)?|–¥–Ω—è|–¥–Ω–µ–π)?\b/gi,'')
      .replace(/\b–¥–Ω(—è|–µ–π)?\b/gi,'')
      .replace(/\b–¥–µ–Ω—å\b/gi,'')
      .replace(/\s+/g,' ').trim();

    const looksLikeName = /^[\w–ê-–Ø–∞-—è–Å—ë\s.,!()\-\u2013\u2014]{2,40}$/.test(name || '') && !/–¥–Ω|–¥–Ω–µ–π|day|days/i.test(name || '');
    if(looksLikeName){ return { name, days }; }
    const asName = /^[\w–ê-–Ø–∞-—è–Å—ë\s.,!()\-\u2013\u2014]{2,40}$/.test(clean) && !/–¥–Ω|–¥–Ω–µ–π|day|days/i.test(clean);
    if(asName){ return { name: clean, days }; }
    return null;
  }

  async function botReply(q){
    const text = q.trim();

    // –æ–∂–∏–¥–∞–Ω–∏–µ —Å—Ä–æ–∫–∞
    if(state.pending && state.pending.type==='duration' && state.pending.habitId){
      const num = (text.match(/(\d{1,3})/)||[])[1];
      if(num){
        const n = Math.max(1, Math.min(365, parseInt(num,10)));
        const h = state.habits.find(x=>x.id===state.pending.habitId);
        if(h){ h.targetDays = n; saveState(state); renderAll(); }
        pushMsg(`–û–∫, —Å—Ä–æ–∫: ${n} –¥–Ω–µ–π. –°–∫–∞–∂–∏ —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: —Å–∫–æ–ª—å–∫–æ —Ç—ã –¥–µ–ª–∞–µ—à—å —Å–µ–π—á–∞—Å (—á–∏—Å–ª–æ + –µ–¥–∏–Ω–∏—Ü–∞)?`, 'bot');
        state.pending = { type:'baseline', habitId: state.pending.habitId }; saveState(state);
        return;
      } else {
        pushMsg('–ù–∞–ø–∏—à–∏ —á–∏—Å–ª–æ –¥–Ω–µ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä: 30', 'bot'); return;
      }
    }

    // –æ–∂–∏–¥–∞–Ω–∏–µ baseline
    if(state.pending && state.pending.type==='baseline' && state.pending.habitId){
      const h = state.habits.find(x=>x.id===state.pending.habitId);
      if(h){
        h.baseline = text.trim();
        saveState(state);
        pushMsg('–°—É–ø–µ—Ä! –ü–ª–∞–Ω —Å—Ñ–æ—Ä–º–∏—Ä—É—é –∏ –¥–æ–±–∞–≤–ª—é –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å.', 'bot');
        generatePlanForHabit(h); // –º–æ–ª—á–∞ –≥–µ–Ω–µ—Ä–∏–º –∏ –ø–∏—à–µ–º –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
      }
      state.pending = null; saveState(state);
      showView('view-habit');
      return;
    }

    // –±—ã—Å—Ç—Ä—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
    const parsed = parseHabitIntent(text);
    if(parsed && parsed.name){
      const h = createHabit(parsed.name);
      if(parsed.days){
        h.targetDays = parsed.days;
        pushMsg('–ö–∞–∫–æ–π —É —Ç–µ–±—è —Å–µ–π—á–∞—Å —É—Ä–æ–≤–µ–Ω—å –ø–æ —ç—Ç–æ–π –ø—Ä–∏–≤—ã—á–∫–µ (—á–∏—Å–ª–æ + –µ–¥–∏–Ω–∏—Ü–∞)?', 'bot');
        state.pending = { type:'baseline', habitId: h.id }; saveState(state);
        return;
      } else {
        pushMsg(`–î–æ–±–∞–≤–∏–ª: ¬´${h.name}¬ª. –ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–ª–∞–Ω–∏—Ä—É–µ—à—å? –ù–∞–ø–∏—à–∏ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 30`, 'bot');
        state.pending = { type:'duration', habitId: h.id }; saveState(state);
        return;
      }
    }

    if(state.pending && state.pending.type==='name'){
      const name = text.replace(/^–ø—Ä–∏–≤—ã—á(–∫–∞|–∫—É)?\s*/i, '').trim() || '–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞';
      const h = createHabit(name);
      pushMsg(`–î–æ–±–∞–≤–∏–ª: ¬´${h.name}¬ª. –ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–ª–∞–Ω–∏—Ä—É–µ—à—å? –ù–∞–ø–∏—à–∏ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 30`, 'bot');
      state.pending = { type:'duration', habitId: h.id }; saveState(state);
      return;
    }

    const numInline = (text.match(/(\d{1,3})/)||[])[1];
    if(numInline){
      const h = state.habits[0];
      if(h){
        const n = Math.max(1, Math.min(365, parseInt(numInline,10)));
        h.targetDays = n; saveState(state); renderAll();
        pushMsg(`–û–∫, —Å—Ä–æ–∫ –¥–ª—è ¬´${h.name}¬ª: ${n} –¥–Ω–µ–π.`, 'bot');
        return;
      }
    }

    const looksLikeName = /^[\w–ê-–Ø–∞-–Ø–Å—ë\s.,!()\-\u2013\u2014]{2,40}$/i.test(text) && !/–¥–Ω|–¥–Ω–µ–π|day|days/i.test(text);
    if(looksLikeName){
      const h = createHabit(text);
      pushMsg(`–î–æ–±–∞–≤–∏–ª: ¬´${h.name}¬ª. –ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–ª–∞–Ω–∏—Ä—É–µ—à—å? –ù–∞–ø–∏—à–∏ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 30`, 'bot');
      state.pending = { type:'duration', habitId: h.id }; saveState(state);
      return;
    }

    if(!state.habits || state.habits.length===0){
      pushMsg('–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–∏–≤—ã—á–∫–∏? –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ü–∏—Ç—å –≤–æ–¥—É¬ª.', 'bot');
      state.pending = { type:'name' }; saveState(state);
    } else {
      pushMsg('–ù–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏, –∫–æ—Ç–æ—Ä—É—é –¥–æ–±–∞–≤–∏—Ç—å. –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É —É–∫–∞–∑–∞—Ç—å —Å—Ä–æ–∫: ¬´–ü–∏—Ç—å –≤–æ–¥—É 30¬ª.', 'bot');
      state.pending = { type:'name' }; saveState(state);
    }
  }

  function send(){
    const t = (chatInput?.value||'').trim();
    if(!t) return;
    pushMsg(t, 'you'); chatInput.value='';
    botReply(t);
  }
  sendBtn?.addEventListener('click', send);
  chatInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });

  // Avatar upload
  if(avatarLabel && avatarInput){
    avatarLabel.addEventListener('click', ()=> avatarInput.click());
    avatarInput.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        try{ state.profile.avatar = dataUrl; saveState(state); }catch(err){}
        renderProfile();
      };
      reader.readAsDataURL(file);
    });
  }

  // Nav
  document.addEventListener('click', (ev)=>{
    const navBtn = ev.target.closest('.nav-btn');
    if(navBtn && navBtn.dataset && navBtn.dataset.view) showView(navBtn.dataset.view);
  });

  // Init
  renderAll();
  showView('view-habit');
  renderProfile();

  try{
    const askedKey = 'profile_name_asked_v1';
    const askedBefore = localStorage.getItem(askedKey) === '1';
    if(!askedBefore){
      const nm = prompt('–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?');
      if(nm && nm.trim()){
        state.profile.name = nm.trim();
        saveState(state);
      }
      localStorage.setItem(askedKey, '1');
      renderProfile();
    }
  }catch(e){}

  try{
    const welcomedKey = 'habit_welcome_shown';
    const was = sessionStorage.getItem(welcomedKey);
    if(!was){
      pushMsg('–ü—Ä–∏–≤–µ—Ç! –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ ‚Äî —è –¥–æ–±–∞–≤–ª—é –µ—ë –∏ —Å–ø—Ä–æ—à—É —Å—Ä–æ–∫ (–≤ –¥–Ω—è—Ö).', 'bot');
      sessionStorage.setItem(welcomedKey, '1');
    }
  }catch(e){}

  // Debug badge
  try{
    const badge = document.createElement('div');
    badge.textContent = 'JS OK';
    badge.style.position='fixed'; badge.style.right='10px'; badge.style.bottom='10px';
    badge.style.background='rgba(0,0,0,0.5)'; badge.style.padding='6px 10px'; badge.style.borderRadius='8px'; badge.style.fontSize='12px';
    badge.style.zIndex='9999';
    document.body.appendChild(badge);
    setTimeout(()=>badge.remove(), 1500);
  }catch(e){}
})();
</script>

<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –Ω–∞–≥—Ä–∞–¥/—á–∏–ø–æ–≤/–º–æ–¥–∞–ª–æ–∫ –∏–∑ —Ç–≤–æ–µ–π –≤–µ—Ä—Å–∏–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –±—ã–ª–∏,
     –æ–Ω–∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–æ–π. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã ‚Äî –≤—Å—Ç–∞–≤—å –Ω–∏–∂–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ.
     –Ø –æ–ø—É—Å—Ç–∏–ª –∏—Ö –∑–¥–µ—Å—å, —á—Ç–æ–±—ã —Ñ–∞–π–ª –±—ã–ª –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –∏ –Ω–µ –±—ã–ª–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π. -->

<script>
/* visualViewport & kb fixes, —á—Ç–æ–±—ã —á–∞—Ç –Ω–µ –¥—Ä–æ–∂–∞–ª –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
(function(){
  function setVH(){
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setVH();
  window.addEventListener('resize', setVH, {passive:true});
  window.addEventListener('orientationchange', setVH, {passive:true});

  function isInput(el){ return el && (el.tagName==='INPUT' || el.tagName==='TEXTAREA' || el.isContentEditable); }
  function toggleKB(open){
    document.body.classList.toggle('kb-open', !!open);
    if(open){
      try{ const messages = document.getElementById('messages'); if(messages){ messages.scrollTop = messages.scrollHeight; } }catch(e){}
    }
  }

  var vv = window.visualViewport;
  function updateKB(){
    if(!vv){ return; }
    var kb = Math.max(0, window.innerHeight - (vv.height + vv.offsetTop));
    document.documentElement.style.setProperty('--kb', kb + 'px');
    toggleKB(kb > 0);
  }
  if(vv){
    vv.addEventListener('resize', updateKB, {passive:true});
    vv.addEventListener('scroll', updateKB, {passive:true});
    updateKB();
  }
  document.addEventListener('focusin', function(e){ if(isInput(e.target)){ setTimeout(updateKB, 50); setTimeout(updateKB, 250); } }, {passive:true});
  document.addEventListener('focusout', function(e){ if(isInput(e.target)){ setTimeout(updateKB, 50); setTimeout(updateKB, 250); } }, {passive:true});
})();
</script>

<style>.bottom *{pointer-events:auto !important;}</style>
<input type="file" id="avatarFile" accept="image/*" capture="user" style="position:absolute;left:-9999px;opacity:0;width:1px;height:1px;" aria-hidden="true">

</body>
</html>
