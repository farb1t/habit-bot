<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="theme-color" content="#0b0c0f">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Трекер привычек</title>

<style>
  :root{
    --vh: 1vh;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --bg:#0b0c0f;
    --panel:#0f1114;
    --muted:#9aa0a6;
    --accent:#ff6b3d;
    --accent-2:#ff3b30;
    --glass: rgba(255,255,255,0.03);
    --success:#59e391;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, 'Helvetica Neue', Arial;
  }
  
  *{box-sizing:border-box; margin:0; padding:0;}
  
  body{
    min-height:100vh; 
    background:linear-gradient(180deg,var(--bg),#071014); 
    color:#e6eef3; 
    display:flex; 
    align-items:stretch; 
    justify-content:center;
    -webkit-font-smoothing:antialiased; 
    -moz-osx-font-smoothing:grayscale;
    background-attachment: fixed;
  }
  
  .app{
    width:100%; 
    max-width:420px; 
    height:720px; 
    margin:24px; 
    border-radius:20px; 
    overflow:hidden; 
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2)); 
    box-shadow:0 8px 30px rgba(0,0,0,0.7);
    display:flex; 
    flex-direction:column;
  }
  
  header{
    padding:18px 18px 12px; 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    gap:12px; 
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
  }
  
  header h1{font-size:16px; margin:0}
  
  button.icon-btn{
    background:var(--glass); 
    border:1px solid rgba(255,255,255,0.03); 
    color:var(--muted); 
    padding:8px 10px; 
    border-radius:10px; 
    display:inline-flex; 
    gap:8px; 
    align-items:center; 
    cursor:pointer;
    transition: all 0.2s ease;
  }
  
  button.icon-btn:active {
    transform: scale(0.95);
  }
  
  main{
    flex:1; 
    overflow:auto; 
    padding:16px;
    padding-bottom: 96px;
  }

  .habit-card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); 
    padding:14px; 
    border-radius:14px; 
    border:1px solid rgba(255,255,255,0.03); 
    margin-bottom:12px;
    transition: all 0.3s ease;
  }
  
  .habit-title{display:flex; align-items:center; gap:12px}
  
  .progress{margin-top:12px}
  .bar{
    height:12px; 
    background:rgba(255,255,255,0.04); 
    border-radius:8px; 
    overflow:hidden
  }
  .bar > i{
    display:block; 
    height:100%; 
    background:linear-gradient(90deg,var(--accent),var(--accent-2)); 
    width:0%;
    transition: width 0.5s ease;
  }
  .sub{font-size:12px; color:var(--muted); margin-top:6px}

  .today-task{
    margin-top:14px; 
    display:flex; 
    gap:10px; 
    align-items:center
  }
  
  .check{
    width:48px; 
    height:48px; 
    border-radius:12px; 
    display:grid; 
    place-items:center; 
    cursor:pointer; 
    border:1px solid rgba(255,255,255,0.03); 
    background:var(--panel);
    transition: all 0.2s ease;
  }
  
  .task-info{flex:1}
  .complete{
    background:linear-gradient(90deg,var(--accent),var(--accent-2)); 
    color:#fff
  }

  .chat{display:flex; flex-direction:column; height:100%}
  .messages{
    flex:1; 
    overflow:auto; 
    padding:8px; 
    display:flex; 
    flex-direction:column; 
    gap:10px
  }
  .bubble{
    max-width:78%; 
    padding:10px 12px; 
    border-radius:12px;
    animation: fadeIn 0.3s ease;
  }
  .bubble.bot{
    align-self:flex-start; 
    background:rgba(255,255,255,0.03)
  }
  .bubble.you{
    align-self:flex-end; 
    background:linear-gradient(90deg,var(--accent),var(--accent-2)); 
    color:#000
  }
  
  .chat-input{
    display:flex; 
    gap:8px; 
    padding:12px;
    background: rgba(0,0,0,0.1);
  }
  
  input[type=text]{
    flex:1; 
    padding:10px 12px; 
    border-radius:12px; 
    border:1px solid rgba(255,255,255,0.04); 
    background:transparent; 
    color:inherit;
    font-size: 14px;
  }

  input[type=text]:focus {
    outline: none;
    border-color: rgba(255,107,61,0.3);
  }

  .profile{display:flex; flex-direction:column; align-items:center; gap:12px}
  .avatar{
    width:120px; 
    height:120px; 
    border-radius:50%; 
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); 
    display:grid; 
    place-items:center; 
    overflow:hidden; 
    border:2px solid rgba(255,255,255,0.03);
    cursor: pointer;
  }
  
  .avatar img{width:100%; height:100%; object-fit:cover}
  .name{font-weight:700; font-size:18px}
  .streak{font-size:14px; color:var(--muted)}
  .medals{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; justify-content:center}
  .medal{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); 
    border-radius:12px; 
    padding:10px; 
    width:120px; 
    text-align:center; 
    border:1px solid rgba(255,255,255,0.03)
  }

  nav.bottom{
    position:sticky; 
    bottom:0; 
    z-index:100; 
    pointer-events:auto; 
    height:78px; 
    display:flex; 
    align-items:center; 
    justify-content:space-around; 
    gap:10px; 
    padding:12px; 
    border-top:1px solid rgba(255,255,255,0.02); 
    background:linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.06));
    backdrop-filter: blur(10px);
  }
  
  .nav-btn{
    cursor:pointer; 
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    gap:6px; 
    color:var(--muted); 
    position:relative;
    transition: all 0.2s ease;
    padding: 8px;
    border-radius: 8px;
  }
  
  .nav-btn.active{color:var(--accent)}
  .nav-badge{
    position:absolute; 
    right:10px; 
    top:4px; 
    font-size:12px;
    background: var(--accent);
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .muted{color:var(--muted)}
  .hidden{display:none}
  .flex{display:flex}

  .today-check{
    transition: background 0.15s ease, box-shadow 0.15s ease;
    border-radius: 10px;
  }
  
  .today-check.done{
    background: #06d6a0;
    box-shadow: 0 2px 8px rgba(6,214,160,0.25);
  }

  .habit-card.done-today, .habit-card.habit-done {
    opacity: 0.6;
    background: linear-gradient(180deg, rgba(89,227,145,0.08), rgba(0,0,0,0.05));
    border: 1px solid rgba(89,227,145,0.15);
  }
  
  .habit-card.done-today:hover, .habit-card.habit-done:hover {
    opacity: 0.9;
    transform: scale(1.02);
  }

  .habit-done .today-task { display: none !important; }

  /* Убираем скроллбары */
  * { scrollbar-width: none; }
  *::-webkit-scrollbar { width: 0; height: 0; display: none; }
  html, body { -ms-overflow-style: none; }

  /* Анимации */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Адаптивность */
  @media (max-width: 1024px){
    .app{
      max-width: 100% !important;
      width: 100% !important;
      height: calc(var(--vh, 1vh) * 100) !important;
      margin: 0 !important;
      border-radius: 0 !important;
    }
    nav.bottom{
      position: fixed !important;
      left: 0; right: 0; bottom: 0;
      width: 100%;
      z-index: 1000;
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)) !important;
      background: linear-gradient(180deg, var(--bg), #071014) !important;
      border-top: 1px solid rgba(255,255,255,0.06) !important;
    }
    main{
      padding-bottom: calc(110px + env(safe-area-inset-bottom, 0px)) !important;
    }
  }

  @media (max-width: 600px) {
    body{ background-attachment: fixed; }
    .app{ 
      max-width: 100%; 
      width: 100%; 
      height: calc(var(--vh, 1vh) * 100); 
      margin: 0; 
      border-radius: 0; 
    }
    header{ 
      padding-top: calc(14px + var(--safe-top)); 
      padding-left: max(12px, var(--safe-left)); 
      padding-right: max(12px, var(--safe-right)); 
    }
    main{ 
      padding: 12px 12px 96px; 
    }
    nav.bottom{ 
      height: auto; 
      min-height: 66px; 
      padding-bottom: calc(12px + var(--safe-bottom)); 
      padding-left: max(8px, var(--safe-left)); 
      padding-right: max(8px, var(--safe-right)); 
      gap: 14px; 
    }
    .nav-btn{ font-size: 12px; }
    .nav-btn svg{ width: 22px; height: 22px; }
    .habit-card{ padding: 12px; border-radius: 16px; }
    .habit-title{ gap: 10px; }
    .today-task{ gap: 10px; }
    .check{ width: 48px; height: 48px; }
    button.icon-btn{ padding: 10px 12px; border-radius: 12px; }
    input[type=text]{ padding: 12px; font-size: 16px; }
    .chat-input{ padding: 12px; }
    .messages{ padding: 8px; }
    .bubble{ font-size: 15px; }
  }

  @media (max-width: 360px) {
    .check{ width: 44px; height: 44px; }
    .habit-card{ padding: 10px; }
    header h1{ font-size: 15px; }
  }

  @media (prefers-reduced-motion: reduce) {
    *{ 
      animation-duration: .01ms !important; 
      animation-iteration-count: 1 !important; 
      transition-duration: .01ms !important; 
      scroll-behavior: auto !important; 
    }
  }
</style>
</head>
<body>
<div class="app" role="application">
  <header>
    <h1 id="header-title">Привычки</h1>
  </header>
  
  <main>
    <section class="view" id="view-habit">
      <div id="habit-list">
        <div class="sub">Загрузка...</div>
      </div>
    </section>

    <section class="view hidden" id="view-chat">
      <div class="chat" style="height:100%">
        <div class="messages" id="messages"></div>
        <div class="chat-input">
          <input autocomplete="off" id="chat-input" placeholder="Напишите сообщение..." type="text"/>
          <button class="icon-btn" id="send-btn">➤</button>
        </div>
      </div>
    </section>

    <section class="view hidden" id="view-profile">
      <div class="profile">
        <label class="avatar" id="avatar-label">
          <img alt="avatar" class="hidden" id="avatar-img" src=""/>
          <div id="avatar-placeholder">👤</div>
          <input accept="image/*" id="avatar-input" style="display:none" type="file"/>
        </label>
        <div>
          <div class="name" id="profile-name">Гость</div>
          <div class="streak" id="profile-streak">Серия: 0 дней</div>
        </div>
      </div>
    </section>
  </main>

  <nav class="bottom">
    <div class="nav-btn active" data-view="view-habit" id="nav-1">
      <svg fill="none" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2v20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"></path>
        <path d="M5 12h14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"></path>
      </svg>
      <div style="font-size:12px">Задания</div>
    </div>
    <div class="nav-btn" data-view="view-chat" id="nav-2">
      <svg fill="none" height="22" viewBox="0 0 24 24" width="22">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4"></path>
      </svg>
      <div style="font-size:12px">Чат</div>
    </div>
    <div class="nav-btn" data-view="view-profile" id="nav-3">
      <svg fill="none" height="22" viewBox="0 0 24 24" width="22">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4"></path>
        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.4"></circle>
      </svg>
      <div style="font-size:12px">Профиль</div>
    </div>
  </nav>
</div>

<script>
(function(){
  // Упрощенная версия без лишних функций
  const STORAGE_KEY = 'habit_tracker_simple_v1';
  
  function isoDate(d){ 
    return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10); 
  }
  
  const defaultState = { 
    profile: {name:'Гость', avatar: '', streak:0}, 
    habits: [] 
  };

  function saveState(s){ 
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){} 
  }
  
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(defaultState));
    }catch(e){ 
      return JSON.parse(JSON.stringify(defaultState)); 
    }
  }

  // DOM элементы
  const views = document.querySelectorAll('.view');
  const navBtns = document.querySelectorAll('.nav-btn');
  const headerTitle = document.getElementById('header-title');
  const listRoot = document.getElementById('habit-list');
  const messages = document.getElementById('messages');
  const chatInput = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');

  let state = loadState();
  
  // Основные функции
  function showView(id){
    views.forEach(v => v.classList.toggle('hidden', v.id !== id));
    navBtns.forEach(b => b.classList.toggle('active', b.dataset.view === id));
    
    if(id === 'view-habit') headerTitle.textContent = 'Привычки';
    else if(id === 'view-chat') headerTitle.textContent = 'Чат';
    else if(id === 'view-profile') headerTitle.textContent = 'Профиль';
  }

  function createHabit(name){
    const habit = {
      id: 'h' + Date.now(),
      name: name || 'Новая привычка',
      start: isoDate(new Date()),
      days: [],
      targetDays: 30
    };
    
    state.habits.unshift(habit);
    saveState(state);
    renderAll();
    return habit;
  }

  function renderAll(){
    if(!state.habits.length){
      listRoot.innerHTML = '<div class="sub">Нет привычек. Добавьте первую через чат!</div>';
      return;
    }

    listRoot.innerHTML = '';
    
    state.habits.forEach(habit => {
      const today = isoDate(new Date());
      const doneToday = habit.days.includes(today);
      const progress = Math.min(100, Math.round(habit.days.length / habit.targetDays * 100));
      
      const card = document.createElement('div');
      card.className = `habit-card ${doneToday ? 'done-today' : ''}`;
      card.innerHTML = `
        <div class="habit-title">
          <div style="flex:1">
            <div style="font-weight:700;font-size:16px">${habit.name}</div>
            <div class="sub">Срок: ${habit.targetDays} дн.</div>
          </div>
          <div style="text-align:right">
            <div class="sub">Прогресс</div>
            <div>${progress}%</div>
          </div>
        </div>
        <div class="progress">
          <div class="bar"><i style="width:${progress}%"></i></div>
          <div class="sub">${habit.days.length} / ${habit.targetDays} выполнено</div>
        </div>
        <div class="today-task">
          <div class="check today-check ${doneToday ? 'done' : ''}">✔</div>
          <div class="task-info">
            <div style="font-weight:700">${doneToday ? 'Выполнено сегодня!' : 'Отметить выполнение'}</div>
            <div class="sub">${habit.days.length} дней подряд</div>
          </div>
        </div>
      `;
      
      // Обработчик отметки выполнения
      const checkBtn = card.querySelector('.check');
      checkBtn.addEventListener('click', () => {
        if(habit.days.includes(today)){
          habit.days = habit.days.filter(d => d !== today);
        } else {
          habit.days.push(today);
        }
        saveState(state);
        renderAll();
      });
      
      listRoot.appendChild(card);
    });
  }

  function pushMsg(text, from = 'you'){
    const bubble = document.createElement('div');
    bubble.className = `bubble ${from}`;
    bubble.textContent = text;
    messages.appendChild(bubble);
    messages.scrollTop = messages.scrollHeight;
  }

  function sendMessage(){
    const text = chatInput.value.trim();
    if(!text) return;
    
    pushMsg(text, 'you');
    chatInput.value = '';
    
    // Простой бот-ответ
    setTimeout(() => {
      if(text.toLowerCase().includes('привыч') || text.includes('добав')){
        const habitName = text.replace(/[^a-zA-Zа-яА-ЯёЁ0-9\s]/g, '').trim();
        if(habitName.length > 2){
          createHabit(habitName);
          pushMsg(`Отлично! Добавил привычку "${habitName}". Отмечайте выполнение каждый день!`, 'bot');
        } else {
          pushMsg('Напишите название привычки, например: "Читать книгу"', 'bot');
        }
      } else {
        pushMsg('Напишите название привычки, которую хотите добавить', 'bot');
      }
    }, 1000);
  }

  // Инициализация
  function init(){
    // Навигация
    navBtns.forEach(btn => {
      btn.addEventListener('click', () => showView(btn.dataset.view));
    });
    
    // Чат
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', e => {
      if(e.key === 'Enter') sendMessage();
    });
    
    // Приветствие
    if(!sessionStorage.getItem('welcomed')){
      setTimeout(() => {
        pushMsg('Привет! Напишите название привычки, которую хотите отслеживать', 'bot');
      }, 500);
      sessionStorage.setItem('welcomed', 'true');
    }
    
    renderAll();
    showView('view-habit');
  }

  // Запуск при загрузке
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Fix для мобильных устройств
  function setVH(){
    document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
  }
  setVH();
  window.addEventListener('resize', setVH);
})();
</script>
</body>
</html>
