<!DOCTYPE html>
<html lang="ru">
<!-- === MOBILE ADAPTATION === -->
<meta name="theme-color" content="#0b0c0f">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  :root{
    /* dynamic viewport height fallback for iOS */
    --vh: 1vh;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
  }

  /* App container uses full screen height on phones */
  @media (max-width: 600px) {
    body{ background-attachment: fixed; }
    .app{
    max-width: 100% !important;
    width: 100% !important;
    height: calc(var(--vh, 1vh) * 100) !important;
    margin: 0 !important;
    border-radius: 0 !important;

    padding-top: calc(env(safe-area-inset-top, 20px) + 12px) !important;
}

    header{
      padding-top: calc(14px + var(--safe-top));
      padding-left: max(12px, var(--safe-left));
      padding-right: max(12px, var(--safe-right));
    }
    main{
      padding: 12px 12px 96px;
    }
    nav.bottom{
      height: auto;
      min-height: 66px;
      padding-bottom: calc(12px + var(--safe-bottom));
      padding-left: max(8px, var(--safe-left));
      padding-right: max(8px, var(--safe-right));
      gap: 14px;
    }
    .nav-btn{ font-size: 12px; }
    .nav-btn svg{ width: 22px; height: 22px; }
   .habit-card{
  padding: 12px;
  border-radius: 16px;
}

/* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è,
   —á—Ç–æ–±—ã –æ–Ω–æ –±—ã–ª–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ */
#habit-list > .habit-card:first-of-type{
  margin-top: 8px;
}
    .habit-title{ gap: 10px; }
    .color-dot{ width: 10px; height: 10px; border-radius: 4px; }
    .today-task{ gap: 10px; }
    .check{ width: 48px; height: 48px; } /* >=44px tap target */
    button.icon-btn{ padding: 10px 12px; border-radius: 12px; }
    input[type=text]{ padding: 12px; font-size: 16px; } /* avoid iOS zoom */
    .chat-input{ padding: 12px; }
    .messages{ padding: 8px; }
    .bubble{ font-size: 15px; }
    /* Calendar cells optimized for small screens */
    .cal-grid{ gap: 6px; }
    .cal-cell{ min-height: 44px; padding: 6px; }
    .cal-cell .day{ font-size: 13px; }
  }

  /* Extra small phones */
  @media (max-width: 360px) {
    .cal-cell{ min-height: 40px; }
    .check{ width: 44px; height: 44px; }
    .habit-card{ padding: 10px; }
    header h1{ font-size: 15px; }
  }

  /* Respect prefers-reduced-motion */
  @media (prefers-reduced-motion: reduce) {
    *{ animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: .01ms !important; scroll-behavior: auto !important; }
  }
</style>

<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫ ‚Äî —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞</title>
<style>
    :root{
      --bg:#0b0c0f;
      --panel:#0f1114;
      --muted:#9aa0a6;
      --accent:#ff6b3d; /* –æ—Ä–∞–Ω–∂–µ–≤–æ-–∫—Ä–∞—Å–Ω—ã–π */
      --accent-2:#ff3b30;
      --glass: rgba(255,255,255,0.03);
      --success:#59e391;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    body{
  margin:0;
  padding-top: env(safe-area-inset-top, 60px);  /* ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ö–£ */
  min-height:100vh;
  background:linear-gradient(180deg,var(--bg),#071014);
  color:#e6eef3;
  display:flex;
  align-items:stretch;
  justify-content:center;
  -webkit-font-smoothing:antialiased; 
  -moz-osx-font-smoothing:grayscale;
}

    .app{
      width:100%; max-width:420px; height:720px; margin:24px; border-radius:20px; overflow:hidden; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2)); box-shadow:0 8px 30px rgba(0,0,0,0.7);
      display:flex; flex-direction:column;
    }
    header{
      padding:18px 18px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
    }
    header h1{font-size:16px; margin:0}
    .top-actions{display:flex; gap:8px; align-items:center}
    button.icon-btn{background:var(--glass); border:1px solid rgba(255,255,255,0.03); color:var(--muted); padding:8px 10px; border-radius:10px; display:inline-flex; gap:8px; align-items:center; cursor:pointer}
    main{flex:1; overflow:auto; padding-bottom: 96px; flex:1; padding:16px; overflow:auto}

    /* Habit (task) cards */
    .habit-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); padding:14px; border-radius:14px; border:1px solid rgba(255,255,255,0.03); margin-bottom:12px}
    .habit-title{display:flex; align-items:center; gap:12px}
    .color-dot{width:12px; height:12px; border-radius:4px}
    .progress{margin-top:12px}
    .bar{height:12px; background:rgba(255,255,255,0.04); border-radius:8px; overflow:hidden}
    .bar > i{display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); width:0%}
    .sub{font-size:12px; color:var(--muted); margin-top:6px}

    /* Calendar */
    .calendar{margin-top:14px;}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .cal-cell{background:rgba(255,255,255,0.02); border-radius:8px; min-height:56px; padding:6px; display:flex; flex-direction:column; justify-content:space-between}
    .cal-cell .day{font-weight:600}
    .cal-cell.done{background:linear-gradient(180deg, rgba(89,227,145,0.08), rgba(0,0,0,0.04)); border:1px solid rgba(89,227,145,0.12)}
    .cal-head{display:flex; justify-content:space-between; align-items:center}

    /* Today's task */
    .today-task{margin-top:14px; display:flex; gap:10px; align-items:center}
    .check{width:48px; height:48px; border-radius:12px; display:grid; place-items:center; cursor:pointer; border:1px solid rgba(255,255,255,0.03); background:var(--panel)}
    .task-info{flex:1}
    .complete{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff}

   /* Chat */
.chat{
  display:flex;
  flex-direction:column;
  height:100%;
  min-height:0;              /* –≤–∞–∂–Ω–æ: –¥–∞—ë–º –±–ª–æ–∫—É –ø—Ä–∞–≤–æ —Å–∂–∏–º–∞—Ç—å—Å—è –ø—Ä–∏ –∫–ª–∞–≤–µ */
}
.messages{
  flex:1;
  min-height:0;              /* —á—Ç–æ–±—ã –∏–º–µ–Ω–Ω–æ messages —É–∂–∏–º–∞–ª–∏—Å—å, –∞ –Ω–µ –≤—ã—Ç–∞–ª–∫–∏–≤–∞–ª–∏ input */
  overflow-y:auto;
  padding:8px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.bubble{
  max-width:78%;
  padding:10px 12px;
  border-radius:12px;
}

    .bubble.bot{align-self:flex-start; background:rgba(255,255,255,0.03)}
    .bubble.you{align-self:flex-end; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#000}
    .chat-input{display:flex; gap:8px; padding:12px}
    input[type=text]{flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}

    /* Profile */
    .profile{display:flex; flex-direction:column; align-items:center; gap:12px}
    .avatar{width:120px; height:120px; border-radius:50%; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); display:grid; place-items:center; overflow:hidden; border:2px solid rgba(255,255,255,0.03)}
    .avatar img{width:100%; height:100%; object-fit:cover}
    .name{font-weight:700; font-size:18px}
    .streak{font-size:14px; color:var(--muted)}
    .medals{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; justify-content:center}
    .medal{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); border-radius:12px; padding:10px; width:120px; text-align:center; border:1px solid rgba(255,255,255,0.03)}
    .medal small{display:block; color:var(--muted); font-size:12px; margin-top:8px}

    /* Bottom nav */
    nav.bottom{position:sticky; bottom:0; z-index:100; pointer-events:auto; height:78px; display:flex; align-items:center; justify-content:space-around; gap:10px; padding:12px; border-top:1px solid rgba(255,255,255,0.02); background:linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.06))}
    .nav-btn{cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:6px; color:var(--muted); cursor:pointer; position:relative}
    .nav-btn.active{color:var(--accent)}
    .nav-badge{position:absolute; right:10px; top:4px; font-size:12px;}

    /* small helpers */
    .muted{color:var(--muted)}
    .hidden{display:none}
    .flex{display:flex}

    /* Highlight only the container behind the today checkmark */
    .today-check{
      transition: background 0.15s ease, box-shadow 0.15s ease;
      border-radius: 10px;
      padding: 6px 10px;
    }
    .today-check.done{
      background: #06d6a0;
      box-shadow: 0 2px 8px rgba(6,214,160,0.25);
    }

/* --- Hide scrollbar UI across browsers, keep scroll ability --- */
* { scrollbar-width: none; }            /* Firefox */
*::-webkit-scrollbar { width: 0; height: 0; display: none; } /* WebKit */
html, body { -ms-overflow-style: none; } /* IE/Edge legacy */


/* === STREAK TEXT VISIBILITY FIX === */
.series-chip-gold{ white-space:nowrap; }
.series-chip-gold .series-text{ display:inline !important; font-weight:800; font-size:13px; letter-spacing:.2px; color:#1a1400 !important; text-shadow:0 1px 0 rgba(255,255,255,.35); }
.series-chip-gold .flame{ font-size:16px; line-height:1; }

</style>
<style>
/* === STREAK TEXT HARD OVERRIDE === */
.series-chip-gold{
  font-size:13px !important;
  line-height:1.1 !important;
  min-height:28px;
  padding:6px 10px !important;
  display:inline-flex !important;
  align-items:center !important;
  gap:8px !important;
  white-space:nowrap !important;
}
.series-chip-gold *{
  font-size:13px !important;
  line-height:1.1 !important;
  color:#1a1400 !important;
}
.series-chip-gold .series-text{
  display:inline !important;
  visibility:visible !important;
  opacity:1 !important;
}
</style>
<style>
/* === Completed tasks styling (fully completed by reaching targetDays) === */
.habit-card.done-today, .habit-card.habit-done {
  opacity: 0.6;
  background: linear-gradient(180deg, rgba(89,227,145,0.08), rgba(0,0,0,0.05));
  border: 1px solid rgba(89,227,145,0.15);
  transition: all 0.3s ease;
}
.habit-card.done-today:hover, .habit-card.habit-done:hover {
  opacity: 0.9;
  transform: scale(1.02);
}

</style>
<style>
/* === Completed cards: compact view + always show calendar === */
.habit-done .today-task { display: none !important; }
</style>
<style>
/* === Badges: enforce number/label lines === */
.badge .value{ white-space: nowrap; display:block; }
.badge .label{ display:block; }

</style>
<style>.color-dot{display:none!important}</style>

<style>
/* === vFS: Fullscreen + Fixed Bottom Nav (mobile) === */
@media (max-width: 1024px){
  .app{
    max-width: 100% !important;
    width: 100% !important;
    height: calc(var(--vh, 1vh) * 100) !important;
    margin: 0 !important;
    border-radius: 0 !important;
    padding-top: calc(20px + var(--safe-top)) !important;
  }
  nav.bottom{
    position: fixed !important;
    left: 0; right: 0; bottom: 0;
    width: 100%;
    z-index: 1000;
    padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)) !important;
  }
  main{
    padding-bottom: calc(110px + env(safe-area-inset-bottom, 0px)) !important;
  }
}
</style>


<style>
/* === vFS: Bottom nav opaque and matching background === */
nav.bottom{
  background: linear-gradient(180deg, var(--bg), #071014) !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  border-top: 1px solid rgba(255,255,255,0.06) !important;
}
</style>


<style>
/* kbfix: body bg scroll */
@media (max-width: 900px){
  body{ background-attachment: scroll !important; }
  .app{ will-change: transform; transform: translateZ(0); }
  html, body { overscroll-behavior: contain; }
  @supports (height: 100dvh){
    .app{ height: 100dvh !important; }
  }
}
</style>


<style>
/* kbfix-2: ensure nav never overlays keyboard */
body.kb-open nav.bottom{
  position: fixed !important;
  left: 0; right: 0;
  /* pushed visually below keyboard, –Ω–æ –∫–ª–∏–∫–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º */
  bottom: calc(-1 * var(--kb, 0px)) !important;
  transform: translateY(110%);
  opacity: 0;
  /* pointer-events: none;  // –£–ë–†–ê–õ–ò, —á—Ç–æ–±—ã –Ω–µ ‚Äú—Å—ä–µ–¥–∞—Ç—å‚Äù –ø–µ—Ä–≤—ã–π —Ç–∞–ø */
}
</style>

</head>
<body data-avatar-ready="1">
<div class="app" role="application">
  <header>
    <h1 id="header-title">–ü—Ä–∏–≤—ã—á–∫–∏</h1>
  </header>
  <main>
    <!-- TASKS (ALL HABITS) VIEW -->
    <section class="view" id="view-habit">
      <div id="habit-list"></div>
      <div class="habit-card" id="trash-panel" style="display:none;">
        <div style="font-weight:700; margin-bottom:8px">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div class="sub" id="trash-list">–ü—É—Å—Ç–æ</div>
      </div>
    </section>

    <!-- CHAT VIEW -->
    <section class="view hidden" id="view-chat">
      <div class="chat" style="height:100%">
        <div class="messages" id="messages"></div>
        <div class="chat-input">
          <input autocomplete="off" id="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." type="text"/>
          <button class="icon-btn" id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="habit-card" id="trash-panel-chat" style="margin-top:12px; display:none;">
        <div style="font-weight:700; margin-bottom:8px">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div class="sub" id="trash-list-chat">–ü—É—Å—Ç–æ</div>
      </div>
    </section>

      <!-- PROFILE VIEW -->
    <section class="view hidden" id="view-profile">
      <div class="profile">
        <label class="avatar" id="avatar-label">
          <img alt="avatar" class="hidden" id="avatar-img" src=""/>
          <div id="avatar-placeholder">üë§</div>
          <input accept="image/*" id="avatar-input" style="display:none" type="file"/>
        </label>

        <div>
          <div style="text-align:center;">
            <div class="name" id="profile-name" style="margin:0 auto;">–ì–æ—Å—Ç—å</div>
          </div>

          <!-- –ú–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–≤—ã—á–µ–∫ -->
          <div class="rules-card">
            <div class="rules-title">–ú–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–≤—ã—á–µ–∫</div>
            <div class="rules-sub">–ü—Ä–∏–¥—É–º–∞–π —Å–≤–æ–∏ 2‚Äì3 –≥–ª–∞–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª–∞ ‚Äî –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è.</div>
            <div class="rules-lines">
              <div class="rule-line" contenteditable="true" data-rule-index="0">
                –ù–∞–ø—Ä–∏–º–µ—Ä: –Ω–∞—á–∏–Ω–∞—é —Å –º–∞–ª–µ–Ω—å–∫–∏—Ö —à–∞–≥–æ–≤
              </div>
              <div class="rule-line" contenteditable="true" data-rule-index="1">
                –ù–∞–ø—Ä–∏–º–µ—Ä: –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—é –¥–≤–∞ –¥–Ω—è –ø–æ–¥—Ä—è–¥
              </div>
              <div class="rule-line" contenteditable="true" data-rule-index="2">
                –ù–∞–ø—Ä–∏–º–µ—Ä: –≤–∞–∂–Ω–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, —á–µ–º –∏–¥–µ–∞–ª
              </div>
            </div>
          </div>

          <h3 style="margin-top:16px">–ù–∞–≥—Ä–∞–¥—ã</h3>
          <div class="medals" id="medals">
            <!-- medals injected -->
          </div>

          <!-- –ü–æ–ø-–∞–ø –¥–ª—è –Ω–∞–≥—Ä–∞–¥ -->
          <div class="reward-popup-backdrop hidden" id="reward-popup-backdrop">
            <div class="reward-popup">
              <div class="reward-popup-type" id="reward-popup-type"></div>
              <div class="reward-popup-title" id="reward-popup-title"></div>
              <div class="reward-popup-habit" id="reward-popup-habit"></div>
              <div class="reward-popup-meta" id="reward-popup-meta"></div>
              <button class="reward-popup-close" id="reward-popup-close">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <nav class="bottom">
    <div class="nav-btn active" data-view="view-habit" id="nav-1">
      <svg fill="none" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"></path><path d="M5 12h14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"></path></svg>
      <div style="font-size:12px">–ó–∞–¥–∞–Ω–∏—è</div>
      <span class="nav-badge">‚úì</span>
    </div>
    <div class="nav-btn" data-view="view-chat" id="nav-2">
      <svg fill="none" height="22" viewBox="0 0 24 24" width="22"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4"></path></svg>
      <div style="font-size:12px">–ß–∞—Ç</div>
    </div>
    <div class="nav-btn" data-view="view-profile" id="nav-3">
      <svg fill="none" height="22" viewBox="0 0 24 24" width="22"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4"></path><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.4"></circle></svg>
      <div style="font-size:12px">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>
  </nav>
</div>

<script>
(function(){
  const STORAGE_KEY = 'habit_traker_demo_v3';
  function isoDate(d){ const t=new Date(d.getFullYear(), d.getMonth(), d.getDate()); return t.toISOString().slice(0,10); }
  function daysBetween(a,b){ const ms = (new Date(b) - new Date(a)); return Math.max(0, Math.round(ms/86400000)+1); }

  const defaultState = {
    profile: {name:'–ì–æ—Å—Ç—å', avatar: '', streak:0},
    habits: [],
    trash: [],
    currentHabitId: null,
    creationLockUntil: null
  };

  function saveState(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){} }
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return JSON.parse(JSON.stringify(defaultState));
      const s = JSON.parse(raw);
      if(!('trash' in s)) s.trash = [];
      if(!('creationLockUntil' in s)) s.creationLockUntil = null;
      return s;
    }catch(e){ return JSON.parse(JSON.stringify(defaultState)); }
  }

  // DOM
  const views = Array.from(document.querySelectorAll('.view'));
  const navBtns = Array.from(document.querySelectorAll('.nav-btn'));
  const headerTitle = document.getElementById('header-title');
  const listRoot = document.getElementById('habit-list');
  const trashPanel = document.getElementById('trash-panel');
  const trashList = document.getElementById('trash-list');

  const sendBtn = document.getElementById('send-btn');
  const chatInput = document.getElementById('chat-input');
  const messages = document.getElementById('messages');

  const profileNameEl = document.getElementById('profile-name');
  const profileStreakEl = document.getElementById('profile-streak');
  const avatarImg = document.getElementById('avatar-img');
  const avatarPlaceholder = document.getElementById('avatar-placeholder');
  const avatarInput = document.getElementById('avatar-input');
  const avatarLabel = document.getElementById('avatar-label');


  let state = loadState();
  if(!('pending' in state)) state.pending = null;
function isCreationLocked(){
  const today = isoDate(new Date());
  return !!(state.creationLockUntil && today < state.creationLockUntil);
}


  const COLOR_PALETTE = ['#ff6b3d', '#ff3b30', '#59e391', '#4da3ff', '#c792ea', '#ffd166', '#06d6a0', '#f469a9'];
  function uid(){ return 'h' + Math.random().toString(36).slice(2,9); }
  function pickColor(){
    const used = state.habits.map(h=>h.color).filter(Boolean);
    for(const c of COLOR_PALETTE){ if(!used.includes(c)) return c; }
    return COLOR_PALETTE[Math.floor(Math.random()*COLOR_PALETTE.length)];
  }


function createHabit(name, unit, baseline){
  // 0) –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ, –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤—É–µ—Ç –∑–∞–º–æ–∫
  const today = isoDate(new Date());
  if (state.creationLockUntil && today < state.creationLockUntil) {
    try {
      const until = new Date(state.creationLockUntil).toLocaleDateString('ru-RU');
      pushMsg?.(`–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —Ä–∞–∑ –≤ 30 –¥–Ω–µ–π. –≠—Ç–æ —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —É—Å–≤–æ–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–∫–∏. –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å–Ω–æ–≤–∞ —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å–ª–µ ${until}. –£–¥–∞–ª–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –æ—á–∏—Å—Ç–∏—Ç–µ –∫–æ—Ä–∑–∏–Ω—É, —á—Ç–æ–±—ã —Å–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–Ω—å—à–µ.`, 'bot');
    } catch(e){}
    alert(`–°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–æ ${state.creationLockUntil}`);
    return null;
  }

  if(state.pending && state.pending.type==='duration') state.pending = null;
  const n = (name||'–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞').trim();

  const id = uid();
  const h = {
    id,
    name: n,
    color: pickColor(),
    start: isoDate(new Date()),
    days: [],
    unit: unit || null,
    baseline: baseline || null,
    targetDays: 50
  };

  state.habits.unshift(h);
  state.currentHabitId = id;

  // 1) –°—Ç–∞–≤–∏–º –∑–∞–º–æ–∫ –Ω–∞ 30 –¥–Ω–µ–π
  const lockUntilDate = new Date();
  lockUntilDate.setDate(lockUntilDate.getDate() + 30);
  state.creationLockUntil = isoDate(lockUntilDate);

  saveState(state);
  renderAll();
  return h;
}



   function showView(id){
  // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–µ–∫—Ü–∏–∏
  views.forEach(v => {
    if (v.id === id) v.classList.remove('hidden');
    else v.classList.add('hidden');
  });

  // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–∞–±–æ–≤
  navBtns.forEach(b => {
    if (b.dataset.view === id) b.classList.add('active');
    else b.classList.remove('active');
  });

  const mainEl = document.querySelector('main');

  // –∑–∞–≥–æ–ª–æ–≤–æ–∫ + —Å–ø–µ—Ü-–ª–æ–≥–∏–∫–∞ –¥–ª—è —á–∞—Ç–∞/–ø—Ä–æ—Ñ–∏–ª—è
  if (id === 'view-habit') {
    headerTitle.textContent = '–ü—Ä–∏–≤—ã—á–∫–∏';
    // —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–∫—Ä–æ–ª–ª main, –±–µ–∑ –¥–µ—Ä–≥–∞–Ω–∏—è –æ–∫–Ω–∞
    if (mainEl) mainEl.scrollTop = 0;
  } else if (id === 'view-chat') {
    headerTitle.textContent = '–ß–∞—Ç';

    setTimeout(() => {
      if (messages) {
        messages.scrollTop = messages.scrollHeight;
      }
      if (chatInput) {
        chatInput.focus();
      }
    }, 0);
  } else if (id === 'view-profile') {
    headerTitle.textContent = '–ü—Ä–æ—Ñ–∏–ª—å';
    // –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –≤–µ—Ä—Ö–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    if (mainEl) mainEl.scrollTop = 0;
  }
}



  // Calendar renderer for a given container & habit
  function renderCalendar(h, wrapper, ym){
    wrapper.innerHTML = '';
    const head = document.createElement('div'); head.className='cal-head';
    const monthLabel = document.createElement('div'); monthLabel.className='muted';
    const ctrls = document.createElement('div'); ctrls.style.display='flex'; ctrls.style.gap='8px';
    const prev = document.createElement('button'); prev.className='icon-btn'; prev.textContent='‚óÄ';
    const next = document.createElement('button'); next.className='icon-btn'; next.textContent='‚ñ∂';
    ctrls.appendChild(prev); ctrls.appendChild(next);
    head.appendChild(monthLabel); head.appendChild(ctrls);
    const grid = document.createElement('div'); grid.className='cal-grid';

    wrapper.appendChild(head); wrapper.appendChild(grid);

    const base = ym || { y:new Date().getFullYear(), m:new Date().getMonth() };
    let Y = base.y, M = base.m;

    function draw(y, m){
      grid.innerHTML='';
      const first = new Date(y,m,1);
      const last = new Date(y,m+1,0);
      monthLabel.textContent = first.toLocaleString('ru-RU', {month:'long', year:'numeric'});
      const wk=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
      wk.forEach(w=>{ const el=document.createElement('div'); el.className='cal-cell'; el.style.background='transparent'; el.style.minHeight='18px'; el.style.padding='6px 0'; el.style.display='flex'; el.style.alignItems='center'; el.style.justifyContent='center'; el.style.fontSize='12px'; el.textContent=w; grid.appendChild(el); });
      let startDay = first.getDay(); startDay = startDay===0?7:startDay;
      for(let i=1;i<startDay;i++){ const el=document.createElement('div'); el.className='cal-cell'; el.style.opacity=.1; grid.appendChild(el); }
      const todayKey = isoDate(new Date());
      for(let d=1; d<=last.getDate(); d++){
        const dateStr = isoDate(new Date(y,m,d));
        const cell=document.createElement('div'); cell.className='cal-cell';
        const top=document.createElement('div'); top.className='day'; top.textContent=d; cell.appendChild(top);
        const dot=document.createElement('div'); dot.style.height='8px'; dot.style.width='8px'; dot.style.borderRadius='6px'; dot.style.marginTop='6px';
        if(h.days.includes(dateStr)){ cell.classList.add('done'); dot.style.background='var(--success)'; } else { dot.style.background='transparent'; }
        cell.appendChild(dot);
        if(dateStr === todayKey){
          cell.style.cursor='pointer'; cell.title='–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è';
          cell.addEventListener('click', ()=>{
            if(h.days.includes(todayKey)){ h.days = h.days.filter(x=>x!==todayKey); } else { h.days.push(todayKey); }
            saveState(state);
            draw(y,m);
            renderAll();
          });
        } else {
          cell.style.pointerEvents='none'; cell.title='–ú–æ–∂–Ω–æ –æ—Ç–º–µ—á–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å'; cell.style.opacity = 0.85;
        }
        grid.appendChild(cell);
      }
    }
    draw(Y,M);
    prev.addEventListener('click', ()=>{ M--; if(M<0){M=11; Y--;} draw(Y,M); });
    next.addEventListener('click', ()=>{ M++; if(M>11){M=0; Y++;} draw(Y,M); });
  }


  // Compute streak as consecutive days with at least one habit completed (today, yesterday, ...)
  function computeStreak(){
    let streak = 0;
    if(!state.habits || state.habits.length === 0) return 0;
    const d = new Date();
    // Walk backwards day by day
    while(true){
      const key = isoDate(d);
      const anyDone = state.habits.some(h => Array.isArray(h.days) && h.days.includes(key));
      if(anyDone){ streak++; d.setDate(d.getDate()-1); } else { break; }
    }
    return streak;
  }

  function renderProfile(){
    try{
      // Name
      profileNameEl.textContent = state?.profile?.name || '–ì–æ—Å—Ç—å';
      // Avatar
      const src = state?.profile?.avatar || '';
      if(src){
        avatarImg.src = src;
        avatarImg.classList.remove('hidden');
        avatarPlaceholder.style.display = 'none';
      } else {
        avatarImg.src = '';
        avatarImg.classList.add('hidden');
        avatarPlaceholder.style.display = 'grid';
      }
      // Streak
      const s = computeStreak();
      state.profile.streak = s;
      saveState(state);
      profileStreakEl.textContent = 'Streak: ' + s;
    }catch(e){ /* noop */ }
  }
    // --- –ú–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–≤—ã—á–µ–∫ (3 —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ) ---
  (function(){
    const RULES_KEY = 'habit_traker_demo_v3_rules_v1';

    function loadRules(){
      try{
        const raw = localStorage.getItem(RULES_KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function saveRules(arr){
      try{
        localStorage.setItem(RULES_KEY, JSON.stringify(arr || []));
      }catch(e){}
    }

    function wireRules(){
      const lines = document.querySelectorAll('.rule-line[data-rule-index]');
      if(!lines.length) return;

      let saved = loadRules();

      lines.forEach(line=>{
        if(line.dataset.wired === '1') return;
        line.dataset.wired = '1';

        const idx = Number(line.dataset.ruleIndex || 0);
        const val = (saved[idx] || '').trim();
        if(val){
          line.textContent = val;
        }

        line.addEventListener('blur', ()=>{
          const current = (line.textContent || '').trim();
          saved = loadRules();
          saved[idx] = current;
          saveRules(saved);
        });

        line.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter'){
            e.preventDefault();
            line.blur();
          }
        });
      });
    }

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É renderProfile
    const origRenderProfile = window.renderProfile;
    window.renderProfile = function(){
      if(typeof origRenderProfile === 'function') origRenderProfile();
      try{ wireRules(); }catch(e){}
    };

    // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ profile —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω
    document.addEventListener('DOMContentLoaded', ()=>{
      try{ wireRules(); }catch(e){}
    });
  })();


  function computeProgress(h){
    const elapsed = Math.max(1, daysBetween(h.start, isoDate(new Date())));
    const total = h.targetDays ? Math.max(1, h.targetDays) : elapsed;
    const done = Math.min(h.days.length, total);
    const pct = Math.min(100, Math.round(done/total*100));
    return {elapsed, total, done, pct};
  }

  function setNavBadge(doneToday){
    const navBadge = document.querySelector('#nav-1 .nav-badge'); if(!navBadge) return;
    try{
      const today=isoDate(new Date());
      const lit = sessionStorage.getItem('badgeLitDate') === today;
      navBadge.style.display = (doneToday && lit) ? 'block' : 'none';
    } catch(e){
      navBadge.style.display = doneToday ? 'block' : 'none';
    }
  }

  function renderTrash(){
    if(!trashPanel || !trashList) return;
    if(!state.trash || state.trash.length===0){
      trashPanel.style.display='none';
      trashList.textContent='–ü—É—Å—Ç–æ';
      return;
    }
    trashPanel.style.display='block';
    trashList.innerHTML='';
    state.trash.forEach(h=>{
      const row = document.createElement('div');
      row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 0';
      const left = document.createElement('div'); left.textContent = h.name; left.className='sub';
      const btn = document.createElement('button'); btn.className='icon-btn'; btn.textContent='–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
      btn.addEventListener('click', ()=> restoreHabit(h.id));
      row.appendChild(left); row.appendChild(btn);
      trashList.appendChild(row);
    });
  }

// === –ú–∏–Ω–∏-–∫–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã ===
(function(){
  const trashPanel = document.getElementById('trash-panel');
  if(!trashPanel) return;

  const btn = document.createElement('button');
  btn.textContent = '–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É';
  btn.className = 'icon-btn';
  btn.style.marginTop = '8px';
  btn.style.fontSize = '13px';

  btn.addEventListener('click', ()=>{
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?')) return;
    try{
      const hadItems = Array.isArray(state.trash) && state.trash.length > 0;

      if (hadItems) {
        // –°–ù–ê–ß–ê–õ–ê –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–≥—Ä–∞–¥—ã –¥–ª—è –ø—Ä–∏–≤—ã—á–µ–∫ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
        try{
          const trashCopy = Array.isArray(state.trash) ? state.trash.slice() : [];
          trashCopy.forEach(h=>{
            if (!h || !h.id) return;

            const days = Array.isArray(h.days) ? h.days.length : 0;
            const target = typeof h.targetDays === 'number'
              ? Math.max(1, h.targetDays)
              : null;
            const completed = !!(target && days >= target);

            // –µ—Å–ª–∏ –ø—Ä–∏–≤—ã—á–∫–∞ –ù–ï –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî –Ω–∞–≥—Ä–∞–¥—ã –ø–æ –Ω–µ–π —É–¥–∞–ª—è–µ–º
            // –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî –Ω–∞–≥—Ä–∞–¥—ã –æ—Å—Ç–∞–≤–ª—è–µ–º (–∏—Å—Ç–æ—Ä–∏—è)
            if (typeof window.purgeHabitFromAwards === 'function') {
              window.purgeHabitFromAwards(h.id, completed);
            }
          });
        }catch(e){ console.warn(e); }

        // —Ç–µ–ø–µ—Ä—å —É–∂–µ —Ä–µ–∞–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
        state.trash = [];

        // —Å–Ω–∏–º–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
        state.creationLockUntil = null;
        saveState(state);
        renderTrash();
        renderAll();

        // —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–Ω—è—Ç–∏–∏ + —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –º–∞—Å—Ç–µ—Ä–∞ —Å –≤–æ–ø—Ä–æ—Å–æ–º –ø—Ä–æ –µ–¥–∏–Ω–∏—Ü—ã
        try {
          pushMsg?.('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏ —Å–Ω—è—Ç–æ.', 'bot');
          resetWizard?.();      // —Ç–æ–ª—å–∫–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
          startWizard?.();      // –æ—Ç–ø—Ä–∞–≤–∏—Ç: ¬´1/4. –í —á—ë–º –∏–∑–º–µ—Ä—è–µ–º —Ü–µ–ª—å? ‚Ä¶¬ª
          showView?.('view-chat');
        } catch(e){}
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–Ω—è—Ç–æ.');
      } else {
        // –∫–æ—Ä–∑–∏–Ω–∞ –±—ã–ª–∞ –ø—É—Å—Ç–æ–π ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ–º
        saveState(state);
        renderTrash();
        renderAll();

        try { pushMsg?.('–ö–æ—Ä–∑–∏–Ω–∞ –±—ã–ª–∞ –ø—É—Å—Ç–æ–π. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å.', 'bot'); } catch(e){}
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ.');
      }
    }catch(e){ console.warn(e); }
  });




  trashPanel.appendChild(btn);
})();


  function deleteHabit(id){
    const idx = state.habits.findIndex(h=>h.id===id);
    if(idx<0) return;
    const [removed] = state.habits.splice(idx,1);
    state.trash.unshift(removed);
    state.currentHabitId = state.habits.length ? state.habits[0].id : null;
    saveState(state);
    renderAll(); renderTrash();
  }
  function restoreHabit(id){
    const idx = state.trash.findIndex(h=>h.id===id);
    if(idx<0) return;
    const [restored] = state.trash.splice(idx,1);
    state.habits.unshift(restored);
    state.currentHabitId = restored.id;
    saveState(state);
    renderAll(); renderTrash();
  }

  // Render ALL habits
  function renderAll(){
    listRoot.innerHTML='';
    if(!state.habits.length){
      const empty = document.createElement('div');
      empty.className='sub';
      empty.textContent='–ù–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫. –î–æ–±–∞–≤—å—Ç–µ —á–µ—Ä–µ–∑ —á–∞—Ç –Ω–∏–∂–µ: –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∑–∞—Ç–µ–º —É–∫–∞–∂–∏—Ç–µ —Å—Ä–æ–∫ (–≤ –¥–Ω—è—Ö).';
      listRoot.appendChild(empty);
      setNavBadge(false);
      renderTrash();
      return;
    }

    let anyDoneToday = false;
    function isCompleted(h){
  return !!(h && typeof h.targetDays==='number' && Array.isArray(h.days) && h.days.length >= Math.max(1, h.targetDays));
}
const incomplete = state.habits.filter(h => !isCompleted(h));
const complete   = state.habits.filter(h =>  isCompleted(h));
// Render: incomplete first, then complete
[...incomplete, ...complete].forEach(h=>{
      const {total, done, pct} = computeProgress(h);
      const card = document.createElement('div'); card.className='habit-card';

      // Title row
      const title = document.createElement('div'); title.className='habit-title';
      const titleWrap = document.createElement('div'); titleWrap.style.flex='1';
      const nameEl = document.createElement('div'); nameEl.style.fontWeight='700'; nameEl.style.fontSize='16px'; nameEl.textContent = h.name;
      const durationEl = document.createElement('div'); durationEl.className='sub'; durationEl.textContent = `–°—Ä–æ–∫: ${total} –¥–Ω.`;
      titleWrap.appendChild(nameEl); titleWrap.appendChild(durationEl);

      const right = document.createElement('div'); right.style.textAlign='right';
      const subProg = document.createElement('div'); subProg.className='sub'; subProg.textContent='–ü—Ä–æ–≥—Ä–µ—Å—Å';
      const pctEl = document.createElement('div'); pctEl.className='sub'; pctEl.textContent = pct+'%';
      right.appendChild(subProg); right.appendChild(pctEl);

      const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.title='–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É'; delBtn.textContent='üóëÔ∏è';
      delBtn.style.marginLeft='8px';
      delBtn.addEventListener('click', ()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É –≤ –∫–æ—Ä–∑–∏–Ω—É?')) deleteHabit(h.id); });

      title.appendChild(titleWrap); title.appendChild(right); title.appendChild(delBtn);
      card.appendChild(title);

      // Progress
      const progress = document.createElement('div'); progress.className='progress';
      const bar = document.createElement('div'); bar.className='bar';
      const fill = document.createElement('i'); fill.style.width = pct+'%';
      bar.appendChild(fill);
      const sub = document.createElement('div'); sub.className='sub'; sub.textContent = `${done} / ${total} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`;
      progress.appendChild(bar); progress.appendChild(sub);
      card.appendChild(progress);

      // Today row
      const todayRow = document.createElement('div'); todayRow.className='today-task';
      const todayKey = isoDate(new Date());
      const doneToday = h.days.includes(todayKey); if(doneToday) anyDoneToday = true;
      
      if (typeof isCompleted==='function' ? isCompleted(h) : (h && h.targetDays && Array.isArray(h.days) && h.days.length >= Math.max(1, h.targetDays))) {
        card.classList.add('done-today');
        card.classList.add('habit-done');
      }
const check = document.createElement('div'); check.className='check today-check' + (doneToday ? ' done' : '');
      check.textContent = '‚úî';
      check.addEventListener('click', ()=>{
        if(h.days.includes(todayKey)){ h.days = h.days.filter(d=>d!==todayKey); } else { h.days.push(todayKey); }
        saveState(state); renderAll();
      });
      const ti = document.createElement('div'); ti.className='task-info';
      const tt = document.createElement('div'); tt.style.fontWeight='700'; tt.textContent = getTodayTaskTitle(h);
      const ts = document.createElement('div'); ts.className='sub'; ts.textContent = doneToday ? '–°–µ–≥–æ–¥–Ω—è ‚Äî ‚úî' : '–°–µ–≥–æ–¥–Ω—è ‚Äî ‚úñ';
      ti.appendChild(tt); ti.appendChild(ts);
      const muted = document.createElement('div'); muted.className='muted'; muted.textContent = doneToday ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ';
      todayRow.appendChild(check); todayRow.appendChild(ti); todayRow.appendChild(muted);
      card.appendChild(todayRow);

      // Toggle calendar button
      const toggleWrap = document.createElement('div'); toggleWrap.style.marginTop='10px'; toggleWrap.style.display='flex'; toggleWrap.style.gap='8px';
      const toggleBtn = document.createElement('button'); toggleBtn.className='icon-btn'; toggleBtn.textContent='–ö–∞–ª–µ–Ω–¥–∞—Ä—å';
      toggleWrap.appendChild(toggleBtn);
      card.appendChild(toggleWrap);

      // Calendar (hidden by default)
      const cal = document.createElement('div'); cal.className='calendar hidden';
      card.appendChild(cal);

      let calRendered = false;
      toggleBtn.addEventListener('click', ()=>{
        cal.classList.toggle('hidden');
        if(!calRendered){ renderCalendar(h, cal); calRendered = true; }
      });
listRoot.appendChild(card);
    });

    setNavBadge(anyDoneToday);
    renderTrash();
    renderProfile();
  }

  // === COMPACT PLAN ENGINE ===

// 2 —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏—è (–≤—Å–µ–≥–¥–∞ —Å–∞–º—ã–µ –ø–µ—Ä–≤—ã–µ)
const START_TASKS = [
  {type:'meta', title:'–ü–æ–¥–≥–æ—Ç–æ–≤—å—Å—è –º–µ–Ω—Ç–∞–ª—å–Ω–æ –∫ –ø—Ä–∏–≤—ã—á–∫–µ'},
  {type:'meta', title:'–í—ã–±–µ—Ä–∏ –º–µ—Å—Ç–æ –∏ –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–∏–≤—ã—á–∫–∏'}
];

// helpers: –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ —Ü–µ–ª–∏ + —Ñ–æ—Ä–º–∞—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞; –ª–∏—Ç—Ä—ã -> –º–ª
function capFirst(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : ''; }
function extractAction(unit, goalText){
  const t = (goalText||'').trim().toLowerCase();
  if(!t) return (unit==='–ª–∏—Ç—Ä—ã' ? '–ø–µ–π' : '–¥–µ–ª–∞–π');
  const cut = t.split(/[0-9]/)[0].trim();
  const w = (cut.split(/\s+/)[0] || '').replace(/[^\p{L}]/gu,'');
  return w || (unit==='–ª–∏—Ç—Ä—ã' ? '–ø–µ–π' : '–¥–µ–ª–∞–π');
}
function titleFor(unit, action, value){
  if(unit === '–ª–∏—Ç—Ä—ã'){
    const ml = Math.round((Number(value)||0)*1000);
    return `${capFirst(action)} ${ml} –º–ª`;
  }
  const min = Math.round(Number(value)||0);
  return `${capFirst(action)} ${min} –º–∏–Ω—É—Ç`;
}

// –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
function makePrep(unit, baseVal, targetVal, action){
  const out = [];
  if(unit === '–ª–∏—Ç—Ä—ã'){
    let cur = Math.max(0, baseVal);
    for(let i=0;i<10;i++){
      cur = Math.max(cur, (i+1)*0.02); // –∫ 10-–º—É –¥–Ω—é 0.2–ª
      out.push({type:'prep', value:+cur.toFixed(3), title: titleFor('–ª–∏—Ç—Ä—ã', action, cur)});
    }
    return out;
  }
  const needPrep = (targetVal>=50) || (baseVal<10);
  if(!needPrep) return [];
  const step = (baseVal>0 ? baseVal/10 : 1);
  let cur = Math.max(0, baseVal);
  for(let i=0;i<10;i++){
    cur = cur + step;
    out.push({type:'prep', value:Math.round(cur), title: titleFor('–º–∏–Ω—É—Ç—ã', action, cur)});
  }
  return out;
}

// —á–µ—Ç–≤–µ—Ä—Ç—å
function makeQuarter(unit, startVal, incPerDay, days, action){
  const out = []; let cur = startVal;
  for(let i=0;i<days;i++){
    cur += incPerDay;
    out.push({type:'q', value: unit==='–ª–∏—Ç—Ä—ã' ? +cur.toFixed(3) : Math.round(cur), title: titleFor(unit, action, cur)});
  }
  return out;
}

// –≤—Ä–µ–∑–∫–∏ ( (—Å—Ä–æ–∫-15)/14 —à—Ç—É–∫, –Ω–µ —á–∞—â–µ —Ä–∞–∑ –≤ 7 –¥–Ω–µ–π )
function injectRandoms(arr, totalDays){
  const count = Math.max(0, Math.floor((totalDays-15)/14));
  if(!count) return arr;
  const ideas = [
    '–°–¥–µ–ª–∞–π —Å–∫–æ–ª—å–∫–æ –∑–∞—Ö–æ—á–µ—à—å',
    '–†–∞–∑–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å: –ø—Ä–æ–≥—É–ª–∫–∞ 15 –º–∏–Ω',
    '–î–µ–ª–∞–π —Å–∫–æ–ª—å–∫–æ –ø–æ–∂–µ–ª–∞–µ—à—å',
    '–ó–∞–ø–∏—à–∏ 3 –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å',
    '–°–µ–≥–æ–¥–Ω—è –º–æ–∂–µ—à—å –æ—Ç–¥–æ—Ö–Ω—É—Ç—å'
  ];
  const taken = new Set();
  function canPlace(idx){
    if(idx<0 || idx>=arr.length) return false;
    for(const t of taken){ if(Math.abs(t-idx)<7) return false; }
    return true;
  }
  let placed=0, guard=1000;
  while(placed<count && guard--){
    const idx = Math.floor(Math.random()*arr.length);
    if(canPlace(idx)){
      taken.add(idx);
      arr[idx] = {type:'rnd', title: ideas[Math.floor(Math.random()*ideas.length)], value:null};
      placed++;
    }
  }
  return arr;
}

// —Å–æ–±—Ä–∞—Ç—å –ø–ª–∞–Ω
function generatePlan(unit, baseVal, targetVal, termDays, action){
  unit = unit || '–º–∏–Ω—É—Ç—ã';
  baseVal = Number(baseVal)||0;
  targetVal = Number(targetVal)||0;
  action = action || extractAction(unit, '');

  const prep = makePrep(unit, baseVal, targetVal, action);

  // —Å—Ç–∞—Ä—Ç –ø–æ—Å–ª–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
  let startAfterPrep = baseVal;
  if (prep.length){
    startAfterPrep = (unit === '–ª–∏—Ç—Ä—ã')
      ? Math.max(baseVal, 0.2)
      : Math.max(baseVal, prep[prep.length-1].value || baseVal);
  }

  // –í–ê–ñ–ù–û: –ø—Ä–∏—Ä–æ—Å—Ç —Å—á–∏—Ç–∞–µ–º –æ—Ç –∫–æ–Ω—Ü–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏, –∞ –Ω–µ –æ—Ç —Å—Ç–∞—Ä–æ–π –±–∞–∑—ã
  const rem = Math.max(0, targetVal - startAfterPrep);

  // –¥–ª–∏–Ω—ã —á–µ—Ç–≤–µ—Ä—Ç–µ–π: —Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–æ–π (—Å—Ä–æ–∫-12)//4, –±–µ–∑ ‚Äî (—Å—Ä–æ–∫-2)//4
  const cut = prep.length ? 12 : 2;
  const qTotal = Math.max(1, termDays - cut);
  const qLen = Math.max(1, Math.floor(qTotal/4));
  const qDays = [qLen, qLen, qLen, Math.max(1, qTotal - 3*qLen)];

  // –ø—Ä–∏—Ä–æ—Å—Ç—ã –ø–æ —á–µ—Ç–≤–µ—Ä—Ç—è–º:
  const qInc = [
    (rem - 0.80*rem) / qDays[0], // 20% REM / –¥–Ω–∏
    (rem - 0.75*rem) / qDays[1], // 25% REM / –¥–Ω–∏
    (rem - 0.70*rem) / qDays[2], // 30% REM / –¥–Ω–∏
    (rem - 0.75*rem) / qDays[3]  // 25% REM / –¥–Ω–∏
  ];

  let cur = startAfterPrep;
  const q1 = makeQuarter(unit, cur, qInc[0], qDays[0], action); cur = q1.length? q1[q1.length-1].value : cur;
  const q2 = makeQuarter(unit, cur, qInc[1], qDays[1], action); cur = q2.length? q2[q2.length-1].value : cur;
  const q3 = makeQuarter(unit, cur, qInc[2], qDays[2], action); cur = q3.length? q3[q3.length-1].value : cur;
  const q4 = makeQuarter(unit, cur, qInc[3], qDays[3], action);

  const body = [...prep, ...q1, ...q2, ...q3, ...q4];
  injectRandoms(body, termDays);
  return [...START_TASKS, ...body];
}


// —Ç–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ (–∏–∑ –ø–ª–∞–Ω–∞)
function getTodayTaskTitle(h){
  if(!h || !Array.isArray(h.plan) || !h.plan.length) return '–°–µ–≥–æ–¥–Ω—è';
  const i = Math.min(h.idx||0, h.plan.length-1);
  return h.plan[i]?.title || '–°–µ–≥–æ–¥–Ω—è';
}

// –Ω–æ—á–Ω–æ–π —Å–¥–≤–∏–≥ –∏–Ω–¥–µ–∫—Å–æ–≤: –µ—Å–ª–∏ –≤—á–µ—Ä–∞ –±—ã–ª–æ –æ—Ç–º–µ—á–µ–Ω–æ ‚Äî –¥–≤–∏–≥–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å
function rollDailyPointers(state){
  const today = isoDate(new Date());
  const y = new Date(); y.setDate(y.getDate()-1);
  const yesterday = isoDate(y);
  if(state.lastSeenDate === today) return;
  (state.habits||[]).forEach(h=>{
    if(Array.isArray(h.days) && h.days.includes(yesterday)){
      h.idx = Math.min((h.idx||0)+1, Math.max(0,(h.plan?.length||1)-1));
    }
  });
  state.lastSeenDate = today;
}


  // === Chat: –Ω–æ–≤—ã–π –ø–æ—à–∞–≥–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (—Ü–µ–ª—å ‚Üí –µ–¥–∏–Ω–∏—Ü—ã ‚Üí —É—Ä–æ–≤–µ–Ω—å ‚Üí —Å—Ä–æ–∫ ‚â• 60) ===
function pushMsg(text, from='you'){
  const b = document.createElement('div');
  b.className = from==='you' ? 'bubble you' : 'bubble bot';
  b.textContent = text;
  messages.appendChild(b);
  messages.scrollTop = messages.scrollHeight;
}

// –¶–µ–ª—å –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–∏—Ä–∏–ª–ª–∏—Ü—É + –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ß–ò–°–õ–û + —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –µ–¥–∏–Ω–∏—Ü—É
function isValidGoalWithNumber(s, unit){
  if(!s) return false;
  const t = s.trim();

  // –±–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
  if(t.length < 5 || t.length > 50) return false;
  if(!/[–ê-–Ø–∞-—è–Å—ë]/.test(t)) return false;            // –∫–∏—Ä–∏–ª–ª–∏—Ü–∞
  if(/^[^–ê-–Ø–∞-—è–Å—ë]+$/.test(t)) return false;         // –Ω–µ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã/—Å–∏–º–≤–æ–ª—ã
  if(!/[–∞–µ—ë–∏–æ—É—ã—ç—é—è]/i.test(t)) return false;        // —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –≥–ª–∞—Å–Ω–∞—è
  if(/(.)\1{3,}/.test(t)) return false;             // ¬´–º—É—Å–æ—Ä–Ω—ã–µ¬ª –ø–æ–≤—Ç–æ—Ä—ã

  // –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —á–∏—Å–ª–æ–≤–æ–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç
  if(!/\d+([.,]\d+)?/.test(t)) return false;

  // —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –µ–¥–∏–Ω–∏—Ü–∞
  const low = t.toLowerCase();
  if(unit === '–ª–∏—Ç—Ä—ã'){
    if(!/(?:\d[0-9.,]*)\s*(–ª|–ª–∏—Ç—Ä[–∞–æ—ã]?)/.test(low)) return false;
  } else if(unit === '–º–∏–Ω—É—Ç—ã'){
    if(!/(?:\d[0-9.,]*)\s*–º–∏–Ω(—É—Ç[—ã]?)?/.test(low)) return false;
  } else {
    return false;
  }

  return true;
}

// –ü–∞—Ä—Å–∏–Ω–≥ –µ–¥–∏–Ω–∏—Ü
function parseUnit(s){
  const t = s.trim().toLowerCase();
  if(/–ª–∏—Ç—Ä|–ª\b/.test(t))   return '–ª–∏—Ç—Ä—ã';
  if(/–º–∏–Ω—É—Ç|–º–∏–Ω\b/.test(t)) return '–º–∏–Ω—É—Ç—ã';
  return null;
}

// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ (–ª–∏—Ç—Ä—ã –∏–ª–∏ –º–∏–Ω—É—Ç—ã) –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –µ–¥–∏–Ω–∏—Ü–µ, –ª–∏–±–æ null
function parseBaselineValue(s, unit){
  if(!s) return null;
  const t = s.trim().toLowerCase().replace(',', '.');

  if(unit === '–ª–∏—Ç—Ä—ã'){
    // "0.5–ª", "0.5 –ª", –ª–∏–±–æ –ø—Ä–æ—Å—Ç–æ "0.5"
    let m = t.match(/^([\d.]+)\s*–ª/);
    if(!m) m = t.match(/^([\d.]+)$/);
    if(m){
      const liters = parseFloat(m[1]);
      if(!isNaN(liters)) return liters;
    }
    return null;
  }

  if(unit === '–º–∏–Ω—É—Ç—ã'){
    // "10 –º–∏–Ω", "10 –º–∏–Ω—É—Ç" –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ "10"
    let m = t.match(/^(\d+)\s*–º–∏–Ω/);
    if(!m) m = t.match(/^(\d+)\s*–º–∏–Ω—É—Ç/);
    if(!m) m = t.match(/^(\d+)$/);
    if(m){
      const minutes = parseInt(m[1], 10);
      if(!isNaN(minutes)) return minutes;
    }
    return null;
  }

  return null;
}

// –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ —á–∏—Å–ª—É –∏ unit
function formatBaseline(value, unit){
  if(unit === '–ª–∏—Ç—Ä—ã')  return `${value}–ª`;
  if(unit === '–º–∏–Ω—É—Ç—ã') return `${value} –º–∏–Ω—É—Ç`;
  return String(value);
}


// –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ä–æ–∫–∞: "x –¥–Ω–µ–π", –º–∏–Ω–∏–º—É–º 60
function parseTermDays(s){
  const m = s.match(/(\d{1,4})/);
  if(!m) return null;
  const n = Math.max(50, Math.min(365, parseInt(m[1], 10)));
  return n;
}

// --- –ù–û–í–û–ï: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–æ—Å—Ç–∞, –ø–æ—Ä–æ–≥–∏ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏ ---
// –ø–æ—Ç–æ–ª–∫–∏ –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤ –¥–µ–Ω—å –ø–æ —á–µ—Ç–≤–µ—Ä—Ç—è–º (1..4), –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–∞—è
const UNIT_PERDAY_CAPS = {
  '–º–∏–Ω—É—Ç—ã': [0.5, 0.75, 1.25, 1.5],   // 1-—è..4-—è —á–µ—Ç–≤–µ—Ä—Ç–∏
  '–ª–∏—Ç—Ä—ã' : [0.025, 0.03, 0.04, 0.045]
};

// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –ª–∏–º–∏—Ç–æ–≤ –ø–æ —Ç–∏–ø—É –µ–¥–∏–Ω–∏—Ü—ã
function getPerDayCaps(unit) {
  return UNIT_PERDAY_CAPS[unit] || UNIT_PERDAY_CAPS['–º–∏–Ω—É—Ç—ã'];
}

// –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –º–∏–Ω—É—Ç—ã –ò (—Ü–µ–ª—å < 30) –ò (–±–∞–∑–∞ < 10)
function shouldSkipPrep(unit, targetDaily, baseline){
  const u = (typeof normalizeUnit === 'function') ? normalizeUnit(unit) : (unit || '–º–∏–Ω—É—Ç—ã');
  const tgt = Number(targetDaily) || 0;
  const baseVal = Number(baseline) || 0;
  return (u === '–º–∏–Ω—É—Ç—ã') && (tgt > 0 && tgt < 50) && (baseVal < 10);
}

// –º–∏–Ω–∏–º—É–º—ã –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω–æ–π —á–∞—Å—Ç–∏
const MIN_PREP = { '–º–∏–Ω—É—Ç—ã': 10, '–ª–∏—Ç—Ä—ã': 0.2 };
// –¥–æ–ª–∏ ¬´–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –æ–±—ä—ë–º–∞¬ª (—Ü–µ–ª—å - –±–∞–∑–∞) –ø–æ —á–µ—Ç–≤–µ—Ä—Ç—è–º
const QUARTILE_PERCENTS = [0.20, 0.45, 0.75, 1.00];

// –∏–∑–≤–ª–µ–∫–∞–µ–º –ß–ò–°–õ–û –∏–∑ —Ü–µ–ª–∏: "–ß–∏—Ç–∞—Ç—å 30 –º–∏–Ω—É—Ç"/"–ü–∏—Ç—å 2–ª"
function parseGoalNumber(text, unit){
  if(!text) return null;
  const low = String(text).toLowerCase().replace(',', '.');
  if(unit === '–º–∏–Ω—É—Ç—ã'){
    // –±–µ—Ä—ë–º —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –º–∏–Ω—É—Ç –ø–µ—Ä–µ–¥ —Å–ª–æ–≤–æ–º "–º–∏–Ω—É—Ç/–º–∏–Ω", –∏–ª–∏ –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ
    let m = low.match(/(\d+)\s*–º–∏–Ω/);
    if(!m){ m = low.match(/(\d+)/); }
    return m ? Math.max(0, parseInt(m[1],10)) : null;
  }
  if(unit === '–ª–∏—Ç—Ä—ã'){
    // –¥–æ–ø—É—Å–∫–∞–µ–º "2–ª", "2 –ª", "2.5", "2,5"
    let m = low.match(/([\d.]+)\s*–ª/);
    if(!m){ m = low.match(/([\d.]+)/); }
    return m ? Math.max(0, parseFloat(m[1])) : null;
  }
  return null;
}

// –†–∞—Å—á—ë—Ç –æ—Å—Ç–∞—Ç–∫–∞ rem –∏ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ capacity –ø—Ä–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ 15 –¥–Ω–µ–π
function computeRemAndCapacity(baseline, targetDaily, eff, unit){
  unit = unit || '–º–∏–Ω—É—Ç—ã';

   // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: –µ—Å–ª–∏ –º–∏–Ω—É—Ç—ã –ò —Ü–µ–ª—å < 30 –ò –±–∞–∑–∞ < 10 ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
const skip = shouldSkipPrep(unit, targetDaily, baseline);
const prepDays = skip ? 0 : 10;

  // –ö–æ–Ω–µ—Ü –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏:
  //  - –ª–∏—Ç—Ä—ã: –ø–æ–ª 0.2 –≤—Å–µ–≥–¥–∞
  //  - –º–∏–Ω—É—Ç—ã: –µ—Å–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º ‚Äî –±–µ–∑ –ø–æ–ª–∞ (—Å—Ç–∞—Ä—Ç—É–µ–º —Å baseline), –∏–Ω–∞—á–µ –ø–æ–ª 10
  const floor = (unit === '–ª–∏—Ç—Ä—ã') ? 0.2 : (skip ? -Infinity : 10);
  const prepEnd = Math.max((baseline||0), floor);

  // –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
  const rem = Math.max(0, (targetDaily||0) - prepEnd);

  // –¥–Ω–∏ –ø–æ —á–µ—Ç–≤–µ—Ä—Ç—è–º
  const remain = Math.max(0, eff - prepDays);
  const qLen   = Math.max(1, Math.floor(remain/4));
  const qDays  = [qLen, qLen, qLen, Math.max(1, remain - 3*qLen)];

  // —Å—É–º–º–∞—Ä–Ω–∞—è –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ –∂—ë—Å—Ç–∫–∏–º –ª–∏–º–∏—Ç–∞–º "–≤ –¥–µ–Ω—å"
  const perDayCaps = getPerDayCaps(unit); // –º–∏–Ω—É—Ç—ã: [0.5,0.75,1.25,1.5], –ª–∏—Ç—Ä—ã: [0.025,0.03,0.04,0.045]
  const capacity = perDayCaps.reduce((sum, cap, i) => sum + cap*qDays[i], 0);

  return { rem, capacity, prepDays, prepEnd, qDays, perDayCaps };
}


// —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –¥–Ω–∏: –≤—ã—á–∏—Ç–∞–µ–º –∫–∞–∂–¥—É—é 7-—é –∏ –µ—â—ë 2 ¬´–±—É—Ñ–µ—Ä–∞¬ª
function computeEffectiveDays(totalDays){
  const t = Math.max(1, totalDays|0);
  return Math.max(1, t - Math.floor((t-15)/14) - 2);
}

// –ø–æ–º–æ—â–Ω–∏–∫: —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è –ª–µ—Å—Ç–Ω–∏—Ü–∞ –æ—Ç start –¥–æ end, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—è —Å—É—Ç–æ—á–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç capPerDay
function rampWithCap(daysCount, start, end, perDayCap){
  const out = [];
  if(daysCount<=0) return out;
  const needed = Math.max(0, end - start);
  if(needed===0){
    for(let i=0;i<daysCount;i++) out.push(start);
    return out;
  }
  // —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–π —à–∞–≥
  const rawStep = needed / daysCount;
  const step = Math.min(perDayCap, rawStep);
  let cur = start;
  for(let i=0;i<daysCount;i++){
    // –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å ‚Äî —Ç–æ—á–Ω–æ end (—á—Ç–æ–±—ã –≤—ã–π—Ç–∏ –Ω–∞ –ø–ª–∞–Ω)
    if(i === daysCount-1){
      cur = Math.min(end, cur + step);
      out.push(end);
    } else {
      cur = Math.min(end, cur + step);
      out.push(cur);
    }
  }
  return out;
}

// –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞–Ω –∏–∑ 5 —á–∞—Å—Ç–µ–π: 0) –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, 1-4) —á–µ—Ç–≤–µ—Ä—Ç–∏
function buildDailyPlan(baseline, targetDaily, totalDays, unit){
  const eff = computeEffectiveDays(totalDays);
  unit = unit || '–º–∏–Ω—É—Ç—ã';
  if (eff <= 0) return [];

  // —Å—Ä–µ–¥–Ω–∏–π –¥–Ω–µ–≤–Ω–æ–π –ø—Ä–∏—Ä–æ—Å—Ç –ø–æ –í–°–ï–ú —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º –¥–Ω—è–º
  const deltaTotal = Math.max(0, (targetDaily||0) - (baseline||0));
  const base = deltaTotal / eff;

  // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: –µ—Å–ª–∏ –º–∏–Ω—É—Ç—ã –∏ —Ü–µ–ª—å < 30 ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
const skip = shouldSkipPrep(unit, targetDaily);
const prepDays = skip ? 0 : 10;

// –ö–æ–Ω–µ—Ü –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
const floor = (unit === '–ª–∏—Ç—Ä—ã') ? 0.2 : (skip ? -Infinity : 10);
const prepEnd = Math.max((baseline||0), floor);


  const remain   = Math.max(0, eff - prepDays);
  const qLen     = Math.max(1, Math.floor(remain/4));
  const q1 = qLen, q2 = qLen, q3 = qLen, q4 = Math.max(1, remain - q1 - q2 - q3);

  

  const perDayCaps = getPerDayCaps(unit);
  const plan = [];
  const prepCap = perDayCaps[0]; // –≥–æ—Ç–æ–≤–∏–º—Å—è —Ç–µ–º –∂–µ –º—è–≥–∫–∏–º –ª–∏–º–∏—Ç–æ–º
  if (prepDays > 0) {
    plan.push(...rampWithCap(prepDays, baseline||0, prepEnd, prepCap));
  }

  // –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
  const rem = Math.max(0, (targetDaily||0) - prepEnd);

  // –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏ –ø–æ —á–µ—Ç–≤–µ—Ä—Ç—è–º –Ω–∞ –æ—Å—Ç–∞—Ç–∫–µ
  const qP = [0.20, 0.45, 0.75, 1.00]; // –ª–∏—Ç—Ä—ã –∏ –º–∏–Ω—É—Ç—ã ‚Äî –∫–∞–∫ —É —Ç–µ–±—è
  const qTargets = qP.map(p => prepEnd + p * rem);
  const lengths  = [q1, q2, q3, q4];

  // —Å—Ç—Ä–æ–∏–º –∫–∞–∂–¥—É—é —á–µ—Ç–≤–µ—Ä—Ç—å –ª–∏–Ω–µ–π–Ω–æ —Å —É—á—ë—Ç–æ–º ¬´–∂—ë—Å—Ç–∫–∏—Ö¬ª –ø–æ—Ç–æ–ª–∫–æ–≤/–¥–Ω–µ–π
  let cur = plan.length ? plan[plan.length-1] : prepEnd;
  
  // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å ‚Äî —Ç–æ—á–Ω–æ —Ü–µ–ª—å
  if (plan.length>0) plan[plan.length-1] = targetDaily;
  return plan;
}

// –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω –ª–∏ –ø–ª–∞–Ω –¥–ª—è –¥–∞–Ω–Ω—ã—Ö ¬´—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö¬ª –¥–Ω–µ–π: –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã—Ö–æ–¥ –∑–∞ cap –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–∏
function isOverloaded(baseline, targetDaily, totalDays, unit){
  const eff = computeEffectiveDays(totalDays);
  if (eff <= 0) return true;

  const { rem, capacity } = computeRemAndCapacity(baseline, targetDaily, eff, unit);

  // –£—Å–ª–æ–≤–∏–µ —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è: rem < capacity <= rem + 1
  if (capacity < rem) return true;       // –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ‚Äî –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–æ
  if (capacity > rem + 1) return true;   // –∏–∑–±—ã—Ç–æ—á–Ω—ã–π —Å—Ä–æ–∫ ‚Äî –º–æ–∂–Ω–æ —Å–æ–∫—Ä–∞—â–∞—Ç—å
  return false;                           // –æ–ø—Ç–∏–º—É–º
}



// –µ—Å–ª–∏ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–æ ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—Ä–æ–∫ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —à–∞–≥–∞–º–∏), –ø–æ–∫–∞ –Ω–µ –≤–ª–µ–∑–µ—Ç
function ensureNotOverloaded(baseline, targetDaily, initialDays, unit){
  let days = Math.max(50, initialDays|0);
  let guard = 365;
  let lastDirection = 1;
  while(guard-- > 0){
    const eff = computeEffectiveDays(days);
    const u = unit || '–º–∏–Ω—É—Ç—ã';

    // –ø–µ—Ä–µ—Å—á—ë—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    const floor = (u === '–ª–∏—Ç—Ä—ã') ? 0.2 : 10;
    const rem = Math.max(0, (targetDaily||0) - Math.max((baseline||0), floor));
    const perDayCaps = getPerDayCaps(u);
    const remain = Math.max(0, eff - 15);
    const qLen = Math.max(1, Math.floor(remain/4));
    const qDays = [qLen, qLen, qLen, Math.max(1, remain - 3*qLen)];
    const capacity = perDayCaps.reduce((s, c, i)=>s + c*qDays[i], 0);

    if (capacity >= rem && capacity <= rem + 1) break; // –æ–ø—Ç–∏–º—É–º –Ω–∞–π–¥–µ–Ω
    days += (capacity < rem) ? 1 : -1;
    if (days < 50) days = 50; // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ 60 –¥–Ω–µ–π
  }
  if (days < 50) days = 50; // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ 60 –¥–Ω–µ–π
  return days;
}



// –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞
function resetWizard(){
  state.pending = {
    type: 'wizard',
    step: 'unit', // 'goal' -> 'unit' -> 'baseline' -> 'term'
    draft: {
  name: null,
  unit: null,          // '–ª–∏—Ç—Ä—ã' | '–º–∏–Ω—É—Ç—ã'
  baseline: null,      // —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏: "0.5–ª" –∏–ª–∏ "10 –º–∏–Ω—É—Ç"
  baselineValue: null, // —á–∏—Å–ª–æ: 0.5 –ò–õ–ò 10 (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç unit)
  targetDays: 50,
  habitId: null
}


  };
  saveState(state);
}
function ensureWizard(){
  if(!state.pending || state.pending.type !== 'wizard'){
    resetWizard();
  }
}

function startWizard(){
  ensureWizard();
  pushMsg('1/4. –í —á—ë–º –∏–∑–º–µ—Ä—è–µ–º —Ü–µ–ª—å? –ù–∞–ø–∏—à–∏ ¬´–ª–∏—Ç—Ä—ã¬ª –∏–ª–∏ ¬´–º–∏–Ω—É—Ç—ã¬ª.', 'bot');
}


function botReply(textRaw){
  const text = (textRaw||'').trim();
  ensureWizard();
  const w = state.pending;

  // === –ö–æ–º–∞–Ω–¥–∞ "–Ω–∞–∑–∞–¥" ===
if(/^–Ω–∞–∑–∞–¥$/i.test(text)){
  const prev = {
    'unit': null,            // –Ω–µ–ª—å–∑—è –Ω–∞–∑–∞–¥
    'goal': 'unit',
    'baseline': 'goal',
    'term': 'baseline'
  }[w.step];

  if(!prev){
    pushMsg('–¢—ã —É–∂–µ –Ω–∞ –ø–µ—Ä–≤–æ–º —à–∞–≥–µ ‚Äî –¥–∞–ª—å—à–µ –Ω–µ–∫—É–¥–∞ üôÇ', 'bot');
    return;
  }

  w.step = prev;
  saveState(state);

  // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å
  switch(prev){
    case 'unit':
      pushMsg('1/4. –í —á—ë–º –∏–∑–º–µ—Ä—è–µ–º —Ü–µ–ª—å? –ù–∞–ø–∏—à–∏ ¬´–ª–∏—Ç—Ä—ã¬ª –∏–ª–∏ ¬´–º–∏–Ω—É—Ç—ã¬ª.', 'bot');
      break;
    case 'goal':
      pushMsg(
        w.draft.unit === '–ª–∏—Ç—Ä—ã'
          ? '2/4. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ü–µ–ª—å –∏ —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–∏—Ñ—Ä—É –≤ –ª–∏—Ç—Ä–∞—Ö. –ü—Ä–∏–º–µ—Ä: ¬´–ü–∏—Ç—å 2–ª –≤–æ–¥—ã¬ª. (–ò–ª–∏ –Ω–∞–ø–∏—à–∏ ¬´–Ω–∞–∑–∞–¥¬ª, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è).'
          : '2/4. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ü–µ–ª—å –∏ —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–∏—Ñ—Ä—É –≤ –º–∏–Ω—É—Ç–∞—Ö. –ü—Ä–∏–º–µ—Ä: ¬´–ß–∏—Ç–∞—Ç—å 20 –º–∏–Ω—É—Ç¬ª. (–ò–ª–∏ –Ω–∞–ø–∏—à–∏ ¬´–Ω–∞–∑–∞–¥¬ª, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è).',
        'bot'
      );
      break;
    case 'baseline':
      pushMsg(
        w.draft.unit === '–ª–∏—Ç—Ä—ã'
          ? '3/4. –£–∫–∞–∂–∏ —Ç–µ–∫—É—â–∏–π –¥–Ω–µ–≤–Ω–æ–π —É—Ä–æ–≤–µ–Ω—å –≤ –ª–∏—Ç—Ä–∞—Ö. –ü—Ä–∏–º–µ—Ä: ¬´0.5¬ª –∏–ª–∏ ¬´0.5–ª¬ª. (–ò–ª–∏ –Ω–∞–ø–∏—à–∏ ¬´–Ω–∞–∑–∞–¥¬ª, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è).'
          : '3/4. –£–∫–∞–∂–∏ —Ç–µ–∫—É—â–∏–π –¥–Ω–µ–≤–Ω–æ–π —É—Ä–æ–≤–µ–Ω—å –≤ –º–∏–Ω—É—Ç–∞—Ö. –ü—Ä–∏–º–µ—Ä: ¬´10¬ª –∏–ª–∏ ¬´10 –º–∏–Ω—É—Ç¬ª. (–ò–ª–∏ –Ω–∞–ø–∏—à–∏ ¬´–Ω–∞–∑–∞–¥¬ª, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è).',
        'bot'
      );
      break;
  }
  return;
}


  // –ú–∞—Ä—à—Ä—É—Ç –ø–æ —à–∞–≥–∞–º
  switch(w.step){
    case 'goal': {
  const u = w.draft.unit; // –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã —É–∂–µ –µ—Å—Ç—å –∏–∑ —à–∞–≥–∞ 1
  if(!isValidGoalWithNumber(text, u)){
    pushMsg(
      u === '–ª–∏—Ç—Ä—ã'
        ? '–¶–µ–ª—å –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–∏—Ñ—Ä—É –≤ –ª–∏—Ç—Ä–∞—Ö. –ü—Ä–∏–º–µ—Ä: ¬´–ü–∏—Ç—å 2–ª –≤–æ–¥—ã¬ª. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.'
        : '–¶–µ–ª—å –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–∏—Ñ—Ä—É –≤ –º–∏–Ω—É—Ç–∞—Ö. –ü—Ä–∏–º–µ—Ä: ¬´–ß–∏—Ç–∞—Ç—å 20 –º–∏–Ω—É—Ç¬ª. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.',
      'bot'
    );
    return;
  }

  // –ù–û–í–û–ï: —Å–æ—Ö—Ä–∞–Ω–∏–º —Ü–µ–ª–µ–≤–æ–µ –¥–Ω–µ–≤–Ω–æ–µ —á–∏—Å–ª–æ –∏–∑ —Ü–µ–ª–∏
  const goalValue = parseGoalNumber(text, u);
  w.draft.targetDaily = goalValue; // —á–∏—Å–ª–æ –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö

  // –ù–ò–ß–ï–ì–û –Ω–µ —Å–æ–∑–¥–∞—ë–º –∑–¥–µ—Å—å ‚Äî —Ç–æ–ª—å–∫–æ –ø–∏—à–µ–º –≤ –¥—Ä–∞—Ñ—Ç
w.draft.name = text;        // –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ = —Ü–µ–ª—å
// w.draft.targetDaily —É–∂–µ –∑–∞–ø–∏—Å–∞–ª–∏ –≤—ã—à–µ –∏–∑ parseGoalNumber(...)
saveState(state);


  // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —à–∞–≥ 3 ‚Äî –±–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (–æ–¥–Ω–æ —á–∏—Å–ª–æ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –µ–¥–∏–Ω–∏—Ü–µ)
  w.step = 'baseline';
  saveState(state);
  pushMsg(
    u === '–ª–∏—Ç—Ä—ã'
      ? '3/4. –£–∫–∞–∂–∏ —Å–≤–æ–π —Ç–µ–∫—É—â–∏–π –¥–Ω–µ–≤–Ω–æ–π —É—Ä–æ–≤–µ–Ω—å –≤ –ª–∏—Ç—Ä–∞—Ö. –ü—Ä–∏–º–µ—Ä: ¬´0.5¬ª –∏–ª–∏ ¬´0.5–ª¬ª. (–ò–ª–∏ –Ω–∞–ø–∏—à–∏ ¬´–Ω–∞–∑–∞–¥¬ª, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è).'
      : '3/4. –£–∫–∞–∂–∏ —Å–≤–æ–π —Ç–µ–∫—É—â–∏–π –¥–Ω–µ–≤–Ω–æ–π —É—Ä–æ–≤–µ–Ω—å –≤ –º–∏–Ω—É—Ç–∞—Ö. –ü—Ä–∏–º–µ—Ä: ¬´10¬ª –∏–ª–∏ ¬´10 –º–∏–Ω—É—Ç¬ª. (–ò–ª–∏ –Ω–∞–ø–∏—à–∏ ¬´–Ω–∞–∑–∞–¥¬ª, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è).',
    'bot'
  );
  return;
}


   case 'unit': {
  // –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–∏—Ç—Ä—ã –∏–ª–∏ –º–∏–Ω—É—Ç—ã
  const u = parseUnit(text);

  // üîπ –µ—Å–ª–∏ –≤–≤–æ–¥ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ò –ï–°–¢–¨ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Äî —Å–æ–æ–±—â–∞–µ–º –æ –Ω—ë–º
  if(!u && isCreationLocked()){
    const until = new Date(state.creationLockUntil).toLocaleDateString('ru-RU');
    pushMsg(`–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —Ä–∞–∑ –≤ 30 –¥–Ω–µ–π. –≠—Ç–æ —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —É—Å–≤–æ–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–∫–∏. –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å–Ω–æ–≤–∞ —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å–ª–µ ${until}. –£–¥–∞–ª–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –æ—á–∏—Å—Ç–∏—Ç–µ –∫–æ—Ä–∑–∏–Ω—É, —á—Ç–æ–±—ã —Å–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–Ω—å—à–µ.`, 'bot');
    state.pending = null;
    saveState(state);
    return;
  }

  // üîπ –µ—Å–ª–∏ –≤–≤–æ–¥ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–µ—Ç
  if(!u){
    pushMsg('–Ø –Ω–µ –ø–æ–Ω—è–ª. –ù–∞–ø–∏—à–∏ ¬´–ª–∏—Ç—Ä—ã¬ª –∏–ª–∏ ¬´–º–∏–Ω—É—Ç—ã¬ª.', 'bot');
    return;
  }

  // üîπ –µ—Å–ª–∏ –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ –≤–≤–µ–¥–µ–Ω–æ –ª–∏—Ç—Ä—ã/–º–∏–Ω—É—Ç—ã
  w.draft.unit = u;

  // –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –ø–æ—Å–ª–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–≤–æ–¥–∞
  if (isCreationLocked()){
    const until = new Date(state.creationLockUntil).toLocaleDateString('ru-RU');
    pushMsg(`–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —Ä–∞–∑ –≤ 30 –¥–Ω–µ–π. –≠—Ç–æ —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —É—Å–≤–æ–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–∫–∏. –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å–Ω–æ–≤–∞ —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å–ª–µ ${until}. –£–¥–∞–ª–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –æ—á–∏—Å—Ç–∏—Ç–µ –∫–æ—Ä–∑–∏–Ω—É, —á—Ç–æ–±—ã —Å–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–Ω—å—à–µ.`, 'bot');
    state.pending = null;
    saveState(state);
    return;
  }

  // –µ—Å–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä
  w.step = 'goal';
  saveState(state);
  pushMsg(
    w.draft.unit === '–ª–∏—Ç—Ä—ã'
      ? '2/4. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ü–µ–ª—å –∏ —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–∏—Ñ—Ä—É –≤ –ª–∏—Ç—Ä–∞—Ö. –ü—Ä–∏–º–µ—Ä—ã: ¬´–ü–∏—Ç—å 2–ª –≤–æ–¥—ã¬ª, ¬´–í—ã–ø–∏–≤–∞—Ç—å 1.5–ª –≤ –¥–µ–Ω—å¬ª. (–ò–ª–∏ –Ω–∞–ø–∏—à–∏ ¬´–Ω–∞–∑–∞–¥¬ª, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è).'
      : '2/4. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ü–µ–ª—å –∏ —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–∏—Ñ—Ä—É –≤ –º–∏–Ω—É—Ç–∞—Ö. –ü—Ä–∏–º–µ—Ä—ã: ¬´–ß–∏—Ç–∞—Ç—å 20 –º–∏–Ω—É—Ç¬ª, ¬´–ú–µ–¥–∏—Ç–∏—Ä–æ–≤–∞—Ç—å 15 –º–∏–Ω—É—Ç¬ª. (–ò–ª–∏ –Ω–∞–ø–∏—à–∏ ¬´–Ω–∞–∑–∞–¥¬ª, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è).',
    'bot'
  );
  return;
}

    case 'baseline': {
  const u = w.draft.unit; // '–ª–∏—Ç—Ä—ã' | '–º–∏–Ω—É—Ç—ã'
  const val = parseBaselineValue(text, u);
  if(val == null){
    pushMsg(
      u === '–ª–∏—Ç—Ä—ã'
        ? '–ù—É–∂–Ω–æ —á–∏—Å–ª–æ –≤ –ª–∏—Ç—Ä–∞—Ö. –ü—Ä–∏–º–µ—Ä: ¬´0.5–ª¬ª –∏–ª–∏ ¬´0.5¬ª.'
        : '–ù—É–∂–Ω–æ —á–∏—Å–ª–æ –≤ –º–∏–Ω—É—Ç–∞—Ö. –ü—Ä–∏–º–µ—Ä: ¬´10 –º–∏–Ω—É—Ç¬ª –∏–ª–∏ ¬´10¬ª.',
      'bot'
    );
    return;
  }

  w.draft.baselineValue = val;
  w.draft.baseline = formatBaseline(val, u);

  
  w.step = 'term';
  saveState(state);
  pushMsg('4/4. –ù–∞ –∫–∞–∫–æ–π —Å—Ä–æ–∫? –ù–∞–ø–∏—à–∏ ¬´X –¥–Ω–µ–π¬ª, –º–∏–Ω–∏–º—É–º 50. –ï—Å–ª–∏ –ø–æ—Å—á–∏—Ç–∞—é –ø—Ä–∏–≤—ã—á–∫—É –ø—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–æ–π —É–≤–µ–ª–∏—á—é —Å—Ä–æ–∫. ', 'bot');
  return;
}


   case 'term': {
  const dRaw = parseTermDays(text);
  if(!dRaw){
    pushMsg('–£–∫–∞–∂–∏ —á–∏—Å–ª–æ –¥–Ω–µ–π (–º–∏–Ω–∏–º—É–º 50). –ü—Ä–∏–º–µ—Ä: 90. –ï—Å–ª–∏ –ø–æ—Å—á–∏—Ç–∞—é –ø—Ä–∏–≤—ã—á–∫—É –ø—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–æ–π, —É–≤–µ–ª–∏—á—É —Å—Ä–æ–∫.', 'bot');
    return;
  }

  // –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏/–ø–ª–∞–Ω–∞
  const u      = w.draft.unit;                 // '–ª–∏—Ç—Ä—ã' | '–º–∏–Ω—É—Ç—ã'
  const base   = Number(w.draft.baselineValue) || 0;
  // —Ü–µ–ª—å (–¥–Ω–µ–≤–Ω–∞—è) –±–µ—Ä—ë–º –∏–∑ –∑–∞—Ä–∞–Ω–µ–µ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω–æ–π —Ü–µ–ª–∏; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å–µ–π—á–∞—Å
  let target   = Number(w.draft.targetDaily);
  if(!(target>0)) target = parseGoalNumber(w.draft.name, u) || 0;

  // –µ—Å–ª–∏ –±–∞–∑–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª–∞ ‚Äî –¥–æ–≤–æ–¥–∏–º –≤ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ –¥–æ –º–∏–Ω–∏–º—É–º–∞ (—ç—Ç–æ —É–∂–µ —É—á—Ç—ë—Ç buildDailyPlan)
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞
  const dAdj = ensureNotOverloaded(base, target, Math.max(50, dRaw), u);

  // –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–≤—ã—á–∫—É –¢–û–õ–¨–ö–û –Ω–∞ 4-–º —à–∞–≥–µ:
const h = createHabit(w.draft.name, u, w.draft.baseline);

// –ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (–≤–µ—Ä–Ω—É–ª–æ—Å—å null) ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã–π–¥–µ–º
if(!h){
  // createHabit —É–∂–µ –ø–æ–∫–∞–∑–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
  return;
}

// –î–æ–∫–∏–Ω–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –ø–æ–ª—è
h.targetDays  = dAdj;
try{ h.targetDaily = target; }catch(e){}

// –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ —Ü–µ–ª–∏ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞
const action = extractAction(u, w.draft.name) || (u==='–ª–∏—Ç—Ä—ã' ? '–ø–µ–π' : '–¥–µ–ª–∞–π');
h.action = action;
const plan = generatePlan(u, Number(w.draft.baselineValue)||0, Number(target)||0, dAdj, action);
h.plan = plan;
console.log('–°–û–ó–î–ê–ù–ù–´–ô –ü–õ–ê–ù –î–õ–Ø –ü–†–ò–í–´–ß–ö–ò:', {
  name: h.name,
  unit: u,
  baseline: base,
  targetDaily: target,
  termDays: dAdj,
  plan: plan
});

h.idx = 0;
state.lastSeenDate = isoDate(new Date());

saveState(state);
renderAll();


  // –°–æ–æ–±—â–∞–µ–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —É–≤–µ–ª–∏—á–∏–ª–∏ —Å—Ä–æ–∫
if(dAdj > Math.max(50, dRaw)){
  pushMsg(`–°—Ä–æ–∫ —É–≤–µ–ª–∏—á–µ–Ω –¥–æ ${dAdj} –¥–Ω–µ–π.`, 'bot');
}

// –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞
pushMsg(`–ì–æ—Ç–æ–≤–æ! ¬´${w.draft.name}¬ª. –ï–¥–∏–Ω–∏—Ü—ã: ${w.draft.unit}. –ë–∞–∑–∞: ${w.draft.baseline}. –°—Ä–æ–∫: ${dAdj} –¥–Ω–µ–π.`, 'bot');

// üí¨ –ò –≤–æ—Ç –¢–ï–ü–ï–†–¨ ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ (–ø–æ—Å–ª–µ ¬´–°—Ä–æ–∫ —É–≤–µ–ª–∏—á–µ–Ω‚Ä¶¬ª –∏ ¬´–ì–æ—Ç–æ–≤–æ!¬ª)
try {
  const untilHuman = new Date(state.creationLockUntil).toLocaleDateString('ru-RU');
  pushMsg(`–ü—Ä–∏–≤—ã—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∞. –°–ª–µ–¥—É—é—â—É—é –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å–ª–µ ${untilHuman}. –ß—Ç–æ–±—ã —Å–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–Ω—å—à–µ ‚Äî —É–¥–∞–ª–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –æ—á–∏—Å—Ç–∏—Ç–µ –∫–æ—Ä–∑–∏–Ω—É.`, 'bot');
} catch(e){}

state.pending = null;
saveState(state);
showView('view-habit');
return;

}

  }
}

// –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º –º–∞—Å—Ç–µ—Ä –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏)
document.addEventListener('DOMContentLoaded', ()=>{
  // –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  try { rollDailyPointers(state); saveState(state); } catch(e){}
  try { renderAll?.(); } catch(e){}



  if (isCreationLocked()){
    const untilHuman = new Date(state.creationLockUntil).toLocaleDateString('ru-RU');
    const txt = `–í—ã —É–∂–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏ –ø—Ä–∏–≤—ã—á–∫—É. –°–ª–µ–¥—É—é—â—É—é –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å–ª–µ ${untilHuman}. ` +
                `–ß—Ç–æ–±—ã —Å–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–Ω—å—à–µ ‚Äî —É–¥–∞–ª–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –æ—á–∏—Å—Ç–∏—Ç–µ –∫–æ—Ä–∑–∏–Ω—É.`;
    try { pushMsg?.(txt, 'bot'); } catch(e){}
    return; // –º–∞—Å—Ç–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º, –ø–æ–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç –ª–∏–º–∏—Ç
  }

  // –õ–∏–º–∏—Ç–∞ –Ω–µ—Ç ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –¢–í–û–ô —à—Ç–∞—Ç–Ω—ã–π 4-—à–∞–≥–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä
  try{
    resetWizard();
    pushMsg('–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π –Ω–∞—Å—Ç—Ä–æ–∏–º –Ω–æ–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É –≤ 4 —à–∞–≥–∞.', 'bot');
    startWizard();
  }catch(e){}
});




  function send(){
    const t = (chatInput?.value||'').trim();
    if(!t) return;
    pushMsg(t, 'you'); chatInput.value=''; botReply(t);
  }
  sendBtn?.addEventListener('click', send);
  chatInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });

  chatInput?.addEventListener('focus', () => {
  if (messages) {
    messages.scrollTop = messages.scrollHeight;
  }
});



  // Avatar upload handler
  if(avatarLabel && avatarInput){
    avatarLabel.addEventListener('click', ()=> avatarInput.click());
    avatarInput.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        try{
          state.profile.avatar = dataUrl;
          saveState(state);
        }catch(err){}
        renderProfile();
      };
      reader.readAsDataURL(file);
    });
  }

  function handleNavTap(ev){
    const navBtn = ev.target.closest('.nav-btn');
    if (!navBtn || !navBtn.dataset || !navBtn.dataset.view) return;

    // –ù–∞ –º–æ–±–∏–ª–∫–∞—Ö –ø–µ—Ä–≤—ã–π —Ç–∞–ø —á–∞—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä—è—á–µ—Ç –∫–ª–∞–≤—É –∏ –Ω–µ –¥–∞—ë—Ç click.
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞ touchstart, —á—Ç–æ–±—ã –≤—Å—ë —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞.
    if (ev.type === 'touchstart') {
      ev.preventDefault();   // —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –Ω–µ –ø—Ä–∏–ª–µ—Ç–µ–ª –≤—Ç–æ—Ä–æ–π "–ª–∏—à–Ω–∏–π" click
    }

    showView(navBtn.dataset.view);
  }

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è: –∏ click, –∏ touchstart
  document.addEventListener('click', handleNavTap);
  document.addEventListener('touchstart', handleNavTap, { passive: false });

  // Init
  renderAll();
  showView('view-habit');


  renderProfile();
  try{
    const askedKey = 'profile_name_asked_v1';
    const askedBefore = localStorage.getItem(askedKey) === '1';
    if(!askedBefore){
      const nm = prompt('–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?');
      if(nm && nm.trim()){
        state.profile.name = nm.trim();
        saveState(state);
      }
      localStorage.setItem(askedKey, '1');
      renderProfile();
    }
  }catch(e){}

  


})();

// --- Mobile-friendly avatar upload ---
(function(){
  // Try to detect an avatar <img> or clickable area
  const avatarImg = document.querySelector('.profile-avatar img, img#avatar, .avatar img, .user-avatar img') ||
                    document.querySelector('#avatar, .profile-avatar, .avatar, .user-avatar');

  const fileInput = document.getElementById('avatarFile');

  function loadSavedAvatar(){
    try {
      let saved = localStorage.getItem('profile.avatar');
      if(!saved){
        const raw = localStorage.getItem('habit_traker_demo_v3');
        if(raw){ try { const s = JSON.parse(raw); saved = s?.profile?.avatar || ''; } catch(e){} }
      }
      if(saved && avatarImg){
        if(avatarImg.tagName.toLowerCase()==='img'){
          avatarImg.src = saved;
          try{ avatarImg.classList.remove('hidden'); }catch(e){}
          try{ const ph=document.getElementById('avatar-placeholder'); if(ph) ph.style.display='none'; }catch(e){}
        } else {
          avatarImg.style.backgroundImage = 'url(' + saved + ')';
          avatarImg.style.backgroundSize = 'cover';
          avatarImg.style.backgroundPosition = 'center';
        }
      }
    } catch(e){ /* noop */ }
  }

  function dataURLFromFile(file, done){
    const reader = new FileReader();
    reader.onload = () => done(null, reader.result);
    reader.onerror = err => done(err);
    reader.readAsDataURL(file);
  }

  function resizeDataURL(dataURL, maxSize, cb){
    const img = new Image();
    img.onload = function(){
      let w = img.width, h = img.height;
      if(w <= maxSize && h <= maxSize){
        return cb(null, dataURL);
      }
      if(w > h){
        h = Math.round(h * (maxSize / w));
        w = maxSize;
      } else {
        w = Math.round(w * (maxSize / h));
        h = maxSize;
      }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      // Use JPEG to reduce size, fallback to PNG
      let out = canvas.toDataURL('image/jpeg', 0.85);
      if(!out) out = canvas.toDataURL('image/png');
      cb(null, out);
    };
    img.onerror = function(){ cb(new Error('image load failed')); };
    img.src = dataURL;
  }

  function setAvatar(src){
    try { localStorage.setItem('profile.avatar', src); } catch(e){ /* ignore */ }
    // Sync main app state storage so renderProfile() also sees it
    try {
      const k='habit_traker_demo_v3';
      const raw=localStorage.getItem(k);
      if(raw){
        const s=JSON.parse(raw);
        s.profile = s.profile || {};
        s.profile.avatar = src;
        localStorage.setItem(k, JSON.stringify(s));
      }
    } catch(e){ /* ignore */ }
    // Apply to DOM
    if(avatarImg){
      if(avatarImg.tagName.toLowerCase()==='img'){
        avatarImg.src = src;
        try{ avatarImg.classList.remove('hidden'); }catch(e){}
        try{ const ph=document.getElementById('avatar-placeholder'); if(ph) ph.style.display='none'; }catch(e){}
      } else {
        avatarImg.style.backgroundImage = 'url(' + src + ')';
        avatarImg.style.backgroundSize = 'cover';
        avatarImg.style.backgroundPosition = 'center';
      }
    }
  }

  function handleFiles(files){
    const f = files && files[0];
    if(!f) return;
    if(!/^image\\//i.test(f.type)) return;
    dataURLFromFile(f, function(err, dataURL){
      if(err) return;
      resizeDataURL(dataURL, 512, function(err2, resized){
        if(err2 || !resized) return;
        setAvatar(resized);
      });
    });
  }

  function init(){
    // If mobile file input missing, try to use existing #avatar-input
    const altInput = document.getElementById('avatar-input');
    if(!fileInput && !altInput) return;
    const effectiveInput = fileInput || altInput;
    // iOS requires user gesture: click on avatar should trigger file input
    if(avatarImg){
      const makeClickable = (el)=>{
        el.style.cursor = 'pointer';
        el.setAttribute('role','button');
        el.setAttribute('tabindex','0');
        const openPicker = ()=> effectiveInput && effectiveInput.click();
        el.addEventListener('click', openPicker, {passive:true});
        el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); openPicker(); } });
      };
      makeClickable(avatarImg);
    }
    effectiveInput.addEventListener('change', function(e){
      handleFiles(e.target.files);
      // Reset value so selecting the same file again still fires change
      e.target.value = '';
    }, {passive:true});

    // Restore saved avatar on load
    loadSavedAvatar();
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

</script>
<style>.bottom *{pointer-events:auto !important;}</style>

  <input type="file" id="avatarFile" accept="image/*" capture="user" style="position:absolute;left:-9999px;opacity:0;width:1px;height:1px;" aria-hidden="true">

<!-- === Gamified Badges Injection: start === -->
<style>
  /* Badges: gamified look */
  .badges-wrap{width:100%;}
  .badge{
    width:104px; height:120px;
    background: radial-gradient(120px 120px at 50% 0%, rgba(255,255,255,0.10), rgba(0,0,0,0.12));
    border:1px solid rgba(255,255,255,0.06);
    border-radius:16px; padding:10px 10px 12px;
    display:flex; flex-direction:column; align-items:center; justify-content:space-between;
    box-shadow: 0 8px 24px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.04);
    position:relative;
    transition: transform .18s ease, box-shadow .18s ease, filter .18s ease, opacity .18s ease;
  }
  .badge.locked{filter: grayscale(100%) brightness(0.8); opacity:0.55;}
  .badge.unlocked{animation: pop-in .5s ease both;}
  .badge .label{font-size:11px; color:var(--muted); margin-top:6px; text-transform:uppercase; letter-spacing:.03em}
  .badge .value{font-weight:800; font-size:18px; line-height:1.1}
    .badge-habit-name{
    margin-top:4px;
    font-size:11px;
    max-width:100%;
    text-align:center;
    color:var(--muted,#8f9bad);
    word-wrap:break-word;
  }

  .badge .aura{
    position:absolute; inset:-2px; border-radius:18px; pointer-events:none;
    background: conic-gradient(from 0deg, rgba(255,107,61,0.0), rgba(255,59,48,0.25), rgba(255,255,255,0.0));
    filter: blur(14px); opacity:0; transition: opacity .18s ease;
  }
  .badge.unlocked .aura{opacity:1;}
  @keyframes pop-in{ 0%{transform:scale(.7); opacity:0} 60%{transform:scale(1.08); opacity:1} 100%{transform:scale(1)} }
  .badge svg{display:block}
  .medals{gap:12px !important}
    /* –ú–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–≤—ã—á–µ–∫ */
  .rules-card{
    margin-top:16px;
    padding:12px 14px;
    border-radius:16px;
    background:rgba(4,12,18,0.9);
    border:1px solid rgba(255,255,255,0.06);
  }
  .rules-title{
    font-weight:700;
    font-size:14px;
    margin-bottom:4px;
  }
  .rules-sub{
    font-size:12px;
    color:var(--muted,#8f9bad);
    margin-bottom:8px;
  }
  .rules-lines{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .rule-line{
    padding:6px 8px;
    border-radius:10px;
    border:1px dashed rgba(255,255,255,0.08);
    min-height:22px;
    font-size:13px;
    outline:none;
  }
  .rule-line:focus{
    border-style:solid;
    border-color:rgba(255,215,120,0.7);
    background:rgba(255,215,120,0.04);
  }

  /* –ü–æ–ø-–∞–ø –Ω–∞–≥—Ä–∞–¥—ã (–±–µ–∑ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏, –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–π) */
  .reward-popup-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.78); /* —Ç–µ–º–Ω—ã–π –ø–ª–æ—Ç–Ω—ã–π —Ñ–æ–Ω */
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:2147483646;
  }
  .reward-popup-backdrop.hidden{
    display:none;
  }
  .reward-popup{
    width:90%;
    max-width:340px;
    border-radius:20px;
    padding:16px 18px;
    background:linear-gradient(180deg,#0b1118,#020309); /* —Å–ø–ª–æ—à–Ω–æ–π —Ç—ë–º–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
    box-shadow:0 18px 45px rgba(0,0,0,0.9);
    border:1px solid rgba(255,255,255,0.16);
  }
  .reward-popup-type{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--muted,#8f9bad);
    margin-bottom:4px;
  }
  .reward-popup-title{
    font-weight:700;
    font-size:15px;
    margin-bottom:4px;
  }
  .reward-popup-habit{
    font-size:13px;
    margin-bottom:4px;
  }
  .reward-popup-meta{
    font-size:12px;
    color:var(--muted,#8f9bad);
    margin-bottom:10px;
  }
  .reward-popup-close{
    width:100%;
    border-radius:999px;
    padding:8px 10px;
    border:none;
    font-size:13px;
    font-weight:600;
    background:linear-gradient(135deg,#ffef9a,#ffd166 50%,#f7b733 80%);
    color:#1a1400;
    cursor:pointer;
  }



  .toast{
    position:fixed; left:50%; bottom:100px; transform:translateX(-50%);
    background:linear-gradient(180deg, rgba(40,40,40,.9), rgba(0,0,0,.9));
    color:#fff; padding:14px 16px; border-radius:14px; border:1px solid rgba(255,255,255,0.08);
    box-shadow: 0 10px 24px rgba(0,0,0,0.45); z-index:99999; display:none; white-space:nowrap;
  }
  .toast.show{display:block; animation: pop-in .5s ease both;}
  .sparkles{position:fixed; inset:0; pointer-events:none; z-index:99998}
  .sparkles i{
    position:absolute; font-style:normal; opacity:0; animation: sparkle-fall 900ms ease-out forwards;
  }
  @keyframes sparkle-fall{
    0%{transform:translateY(0) rotate(0deg) scale(.8); opacity:0}
    15%{opacity:1}
    100%{transform:translateY(120px) rotate(120deg) scale(1); opacity:0}
  }
</style>
<script>
(function(){
  const BADGES = {
    streak:[7,14,21,30,45,60,75,90,100,120],
    mastered:[1,2,3,4,5]
  };

  // Create flame/trophy SVGs (gamified style)
  function badgeSVG(type, n){
    if(type==='streak'){
      return `
      <svg width="72" height="72" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" style="display:block;max-width:100%;height:auto">
        <defs>
          <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#ffd166"/>
            <stop offset="60%" stop-color="#ff6b3d"/>
            <stop offset="100%" stop-color="#ff3b30"/>
          </linearGradient>
        </defs>
        <g>
          <path d="M32 6 C38 14, 46 20, 46 29 c0 10-8 18-14 21-6-3-14-11-14-21 0-9 8-15 14-23z" fill="url(#g1)"></path>
          <circle cx="32" cy="32" r="10" fill="rgba(0,0,0,0.15)"></circle>
          <text x="32" y="36" text-anchor="middle" font-size="14" font-weight="800" fill="#0b0c0f">${n}</text>
        </g>
      </svg>`;
    } else {
      return `
      <svg width="72" height="72" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" style="display:block;max-width:100%;height:auto">
        <defs>
          <linearGradient id="g2" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#ffd166"/>
            <stop offset="60%" stop-color="#59e391"/>
            <stop offset="100%" stop-color="#4da3ff"/>
          </linearGradient>
        </defs>
        <g>
          <path d="M16 12h32l-3 16a17 17 0 0 1-26 0l-3-16z" fill="url(#g2)"></path>
          <rect x="26" y="40" width="12" height="6" rx="2" fill="#ffd166"></rect>
          <rect x="22" y="48" width="20" height="6" rx="3" fill="#ffd166"></rect>
          <text x="32" y="36" text-anchor="middle" font-size="14" font-weight="800" fill="#0b0c0f">${n}</text>
        </g>
      </svg>`;
    }
  }

  function ensureBadgeState(){
    try{
      const raw = localStorage.getItem('habit_traker_demo_v3');
      if(!raw) return null;
      const s = JSON.parse(raw);
      if(!s.profile) s.profile = {name:"–ì–æ—Å—Ç—å", avatar:"", streak:0};
      if(!s.profile.badges) s.profile.badges = { streak:[], mastered:[] };
      localStorage.setItem('habit_traker_demo_v3', JSON.stringify(s));
      return s;
    }catch(e){ return null; }
  }

  function computeMasteredCount(state){
    let c = 0;
    (state.habits||[]).forEach(h=>{
      if(h && h.targetDays && Array.isArray(h.days)){
        if(h.days.length >= Math.max(1, h.targetDays)) c++;
      }
    });
    return c;
  }

  // Simple sparkles & toast
  function showToast(msg){
    let el = document.getElementById('toast');
    if(!el){
      el = document.createElement('div');
      el.id = 'toast'; el.className = 'toast';
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'), 1600);
  }

  function sparkles(x, y){
    let wrap = document.getElementById('sparkles');
    if(!wrap){
      wrap = document.createElement('div'); wrap.id='sparkles'; wrap.className='sparkles';
      document.body.appendChild(wrap);
    }
    const glyphs = ['‚ú®','‚≠ê','üî•','üèÜ','üí•','üéâ'];
    for(let i=0;i<16;i++){
      const iEl = document.createElement('i');
      iEl.textContent = glyphs[Math.floor(Math.random()*glyphs.length)];
      iEl.style.left = (x + (Math.random()*120-60)) + 'px';
      iEl.style.top  = (y + (Math.random()*20-10)) + 'px';
      iEl.style.fontSize = (14 + Math.random()*10) + 'px';
      wrap.appendChild(iEl);
      setTimeout(()=> iEl.remove(), 950);
    }
  }

  // Render or update medals list
  function renderBadges(state){
    const box = document.getElementById('medals');
    if(!box) return;

    // Make sure badge arrays exist
    state.profile = state.profile || {};
    state.profile.badges = state.profile.badges || {streak:[], mastered:[]};

    const nowStreak = (state.profile && state.profile.streak) || 0;
    const masteredCount = computeMasteredCount(state);

    const prevStreakEarned = new Set(state.profile.badges.streak || []);
    const prevMasteredEarned = new Set(state.profile.badges.mastered || []);

    const newEarned = []; // for animations/toasts

    // Build fragment
    const frag = document.createDocumentFragment();

    // Streak chip next to profile streak
    const streakEl = document.getElementById('profile-streak');
    if(streakEl && !document.getElementById('streak-chip-el')){
      const chip = document.createElement('span');
      chip.id = 'streak-chip-el';
      chip.className = 'streak-chip';
      chip.innerHTML = 'üî• –°–µ—Ä–∏—è';
      chip.style.marginLeft = '8px';
      streakEl.after(chip);
    }

    // Add all badges (locked or unlocked)
    function createBadge(type, n, unlocked){
      const d = document.createElement('div');
      d.className = 'badge' + (unlocked ? ' unlocked' : ' locked');
      d.innerHTML = `<div class="aura"></div>${badgeSVG(type, n)}<div class="label">${type==='streak'?'—Å–µ—Ä–∏—è':'–ø—Ä–∏–≤—ã—á–∫–∏'}</div><div class="value">${type==='streak'? n : n}</div>`;
      return d;
    }

    // Evaluate unlocks & build UI
    BADGES.streak.forEach(n=>{
      const unlocked = nowStreak >= n;
      const el = createBadge('streak', n, unlocked);
      frag.appendChild(el);
      if(unlocked && !prevStreakEarned.has(n)){
        newEarned.push({type:'streak', n, node:el});
        prevStreakEarned.add(n);
      }
    });

    BADGES.mastered.forEach(n=>{
      const unlocked = masteredCount >= n;
      const el = createBadge('mastered', n, unlocked);
      frag.appendChild(el);
      if(unlocked && !prevMasteredEarned.has(n)){
        newEarned.push({type:'mastered', n, node:el});
        prevMasteredEarned.add(n);
      }
    });

    box.innerHTML='';
    box.appendChild(frag);

    // Persist earned
    state.profile.badges.streak   = Array.from(prevStreakEarned).sort((a,b)=>a-b);
    state.profile.badges.mastered = Array.from(prevMasteredEarned).sort((a,b)=>a-b);
    try{ localStorage.setItem('habit_traker_demo_v3', JSON.stringify(state)); }catch(e){}

    // Animate newly earned
    if(newEarned.length){
      const rect = box.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + 20;
      sparkles(cx, cy);
      const {type, n} = newEarned[newEarned.length-1];
      showToast(type==='streak' ? `–ù–æ–≤—ã–π —Å–µ—Ä–∏—è: ${n} –¥–Ω–µ–π!` : `–ù–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥–∞: ${n} –ø—Ä–∏–≤—ã—á${n===1?'–∫–∞':'–∫–∏'}`);
      // Emphasize last unlocked badge
      const b = newEarned[newEarned.length-1].node;
      b.style.boxShadow = '0 10px 30px rgba(255,107,61,.45), inset 0 1px 0 rgba(255,255,255,.08)';
      setTimeout(()=> b.style.boxShadow = '', 1200);
    }
  }

  // Hook into existing renderProfile (decorate)
  const origRenderProfile = window.renderProfile;
  window.renderProfile = function(){
    try{
      origRenderProfile && origRenderProfile();
    }catch(e){}
    const s = ensureBadgeState();
    if(s) renderBadges(s);
  };

  // Also re-render badges after any list re-render (progress changes)
  const origRenderAll = window.renderAll;
  window.renderAll = function(){
    origRenderAll && origRenderAll();
    const s = ensureBadgeState();
    if(s) renderBadges(s);
  };

  // First-time ensure & render (in case profile renders before we patch)
  document.addEventListener('DOMContentLoaded', ()=>{
    const s = ensureBadgeState();
    if(s) renderBadges(s);
  });
})();
</script>
<!-- === Gamified Badges Injection: end === -->


<script>
(function(){
  // Robust re-check loop to avoid missing unlocks
  function getState(){
    try{ return JSON.parse(localStorage.getItem('habit_traker_demo_v3')||'null'); }catch(e){ return null; }
  }
  function currentSnapshot(){
    const s = getState();
    if(!s) return {streak:0, mastered:0, badges:{streak:[], mastered:[]}};
    const streak = (s.profile && s.profile.streak) || 0;
    const mastered = (function(){
      let c=0; (s.habits||[]).forEach(h=>{ if(h && h.targetDays && Array.isArray(h.days) && h.days.length >= Math.max(1, h.targetDays)) c++; });
      return c;
    })();
    const b = (s.profile && s.profile.badges) || {streak:[], mastered:[]};
    return {streak, mastered, badges:b};
  }

  let last = currentSnapshot();

  function maybeUpdate(){
    const now = currentSnapshot();
    if(now.streak !== last.streak || now.mastered !== last.mastered ||
       JSON.stringify(now.badges) !== JSON.stringify(last.badges)){
      last = now;
      if(window.renderBadges){
        try{ window.renderBadges(getState()); }catch(e){}
      } else {
        // Fallback: dispatch event to our badge script if it listens
        document.dispatchEvent(new CustomEvent('badges:refresh'));
      }
    }
  }

  // Listen to clicks on day checkboxes to update quickly
  document.addEventListener('click', (e)=>{
    const t = e.target.closest('.today-check,.check');
    if(t){ setTimeout(maybeUpdate, 80); }
  }, {capture:true, passive:true});

  // Also listen to storage changes (other tabs)
  window.addEventListener('storage', (e)=>{
    if(e.key === 'habit_traker_demo_v3'){ maybeUpdate(); }
  });

  // Periodic sanity check
  setInterval(maybeUpdate, 1000);
})();
</script>


<!-- === PATCH: modal close + anti-duplicate rewards (streak & mastered) === -->
<style>
  .achv-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.60);display:none;align-items:center;justify-content:center;z-index:2147483647;backdrop-filter:blur(3px)}
  .achv-backdrop.show{display:flex}
  body.modal-open{overflow:hidden}
  .achv-modal{width:min(92vw,380px);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(0,0,0,.30));border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:18px 16px 16px;box-shadow:0 18px 50px rgba(0,0,0,.55);animation:achv-pop .45s ease both}
  @keyframes achv-pop{0%{transform:scale(.86);opacity:0}60%{transform:scale(1.04);opacity:1}100%{transform:scale(1)}}
  .achv-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .achv-icon{font-size:22px;line-height:1;background:radial-gradient(80% 140% at 20% 0%,#ffef9a,#ffd166 50%,#f7b733 80%);padding:8px;border-radius:14px;border:1px solid rgba(255,215,120,.85);box-shadow:0 8px 22px rgba(247,183,51,.35),inset 0 1px 0 rgba(255,255,255,.45)}
  .achv-title{font-weight:900;font-size:16px}
  .achv-body{color:var(--muted);font-size:14px;margin-bottom:12px}
  .achv-actions{display:flex;gap:8px;justify-content:flex-end}
  .btn{padding:10px 12px;border-radius:12px;cursor:pointer;border:1px solid rgba(255,255,255,.12);background:var(--panel);color:#e6eef3}
  .btn.primary{background:linear-gradient(90deg,#ffd166,#f7b733);color:#1a1400;font-weight:800;border-color:rgba(255,215,120,.85);box-shadow:0 10px 20px rgba(247,183,51,.35)}
  .series-chip-gold{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:800;font-size:13px;letter-spacing:.2px;color:#1a1400;background:radial-gradient(80% 140% at 20% 0%,#ffef9a,#ffd166 50%,#f7b733 80%);border:1px solid rgba(255,215,120,.85);box-shadow:0 6px 22px rgba(247,183,51,.35),inset 0 1px 0 rgba(255,255,255,.45),inset 0 -2px 8px rgba(179,112,0,.25)}
  #profile-streak{display:none!important;height:0!important;overflow:hidden!important}
</style>

<div class="achv-backdrop" id="achv-backdrop" aria-hidden="true" style="display:none">
  <div class="achv-modal" role="dialog" aria-modal="true" aria-labelledby="achv-title">
    <div class="achv-header">
      <div class="achv-icon">üèÜ</div>
      <div class="achv-title" id="achv-title">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ù–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ</div>
    </div>
    <div class="achv-body" id="achv-text">–í—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –Ω–∞–≥—Ä–∞–¥—É.</div>
    <div class="achv-actions">
      <button class="btn" id="achv-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn primary" id="achv-ok">–ö–ª–∞—Å—Å!</button>
    </div>
  </div>
</div>

<script>
(function(){
  // –ö–ª—é—á–∏ –∏ –ø–æ—Ä–æ–≥–∏
  const STORAGE_KEY = 'habit_traker_demo_v3';
  const LOG_KEY     = STORAGE_KEY + '_achvlog';
  const STREAK_STEPS   = [7,14,21,30,45,60,75,90,100,120];
  const MASTERED_STEPS = [1,2,3,4,5];

  // –£—Ç–∏–ª–∏—Ç—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è
  function getState(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null'); }
    catch(e){ return null; }
  }
  function setState(s){
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); } catch(e){}
  }
  function getLog(){
    try { return JSON.parse(localStorage.getItem(LOG_KEY) || '{"streak":{},"mastered":{}}'); }
    catch(e){ return {streak:{}, mastered:{}}; }
  }
  function setLog(l){
    try { localStorage.setItem(LOG_KEY, JSON.stringify(l)); } catch(e){}
  }

  // –°–ª—É–∂–µ–±–Ω—ã–µ
  function isoDate(d){ const t=new Date(d.getFullYear(),d.getMonth(),d.getDate()); return t.toISOString().slice(0,10); }
  // –°–∫–ª–æ–Ω–µ–Ω–∏—è: ['–¥–µ–Ω—å','–¥–Ω—è','–¥–Ω–µ–π'] –∏ —Ç.–ø.
  function decl(n, forms){
    n = Math.abs(n) % 100; const n1 = n % 10;
    if (n>10 && n<20) return forms[2];
    if (n1>1 && n1<5) return forms[1];
    if (n1===1) return forms[0];
    return forms[2];
  }

  function computeMasteredCount(state){
    if(!state || !Array.isArray(state.habits)) return 0;
    let c = 0;
    state.habits.forEach(h=>{
      if(h && typeof h.targetDays==='number' && Array.isArray(h.days)){
        if(h.days.length >= Math.max(1, h.targetDays)) c++;
      }
    });
    return c;
  }

  function currentSnapshot(){
    const s = getState();
    const streak   = (s && s.profile && typeof s.profile.streak==='number') ? s.profile.streak : 0;
    const mastered = computeMasteredCount(s);
    return { streak, mastered };
  }

  // –ú–æ–¥–∞–ª–∫–∞
  const backdrop = document.getElementById('achv-backdrop');
  const btnOk    = document.getElementById('achv-ok');
  const btnClose = document.getElementById('achv-close');
  const titleEl  = document.getElementById('achv-title');
  const textEl   = document.getElementById('achv-text');

  function openModal(title, text){
    try {
      if(titleEl) titleEl.textContent = title || '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ù–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ';
      if(textEl)  textEl.textContent  = text  || '–í—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –Ω–∞–≥—Ä–∞–¥—É.';
      if(backdrop){
        backdrop.classList.add('show');
        backdrop.style.display = 'flex';
        document.body.classList.add('modal-open');
      }
    } catch(e){}
  }
  function closeModal(){
    try {
      if(backdrop){
        backdrop.classList.remove('show');
        backdrop.style.display = 'none';
      }
      document.body.classList.remove('modal-open');
    } catch(e){}
  }
  btnOk   && btnOk.addEventListener('click', closeModal,  {passive:true});
  btnClose&& btnClose.addEventListener('click', closeModal, {passive:true});
  backdrop&& backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeModal(); }, {passive:true});

  // –¢–æ—Å—Ç/—Å–∞–ª—é—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑ –±–ª–æ–∫–∞ Badges)
  function tryToast(msg){ try{ if(typeof window.showToast==='function') window.showToast(msg); }catch(e){} }
  function trySparkles(){
    try{
      if(typeof window.sparkles==='function'){
        const box = document.getElementById('medals') || document.body;
        const r = box.getBoundingClientRect ? box.getBoundingClientRect() : {left:window.innerWidth/2, top:100, width:0};
        window.sparkles(r.left + (r.width||0)/2, r.top + 20);
      }
    }catch(e){}
  }
    // –î–µ–ª–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ —Å–∞–ª—é—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ (–Ω–∞–≥—Ä–∞–¥ –ø–æ –ø—Ä–∏–≤—ã—á–∫–∞–º)
  window.__habitAchvModal = openModal;
  window.__habitAchvSparkles = trySparkles;


  // –í—ã–¥–∞—á–∞ –Ω–∞–≥—Ä–∞–¥—ã + –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥ (–∞–Ω—Ç–∏-–¥—É–±–ª–∏–∫–∞—Ç)
  function award(type, n){
    const log = getLog();
    if(!log[type]) log[type] = {};
    if(log[type][n]) return; // —É–∂–µ –≤—ã–¥–∞–≤–∞–ª–∏

    // –¢–µ–∫—Å—Ç
    if(type === 'streak'){
      const title = 'üî• –ù–æ–≤–∞—è —Å–µ—Ä–∏—è!';
      const body  = `–ü–æ–¥—Ä—è–¥ ${n} ${decl(n,['–¥–µ–Ω—å','–¥–Ω—è','–¥–Ω–µ–π'])} ‚Äî –º–æ—â–Ω–æ!`;
      openModal(title, body);
      tryToast(`–ù–æ–≤–∞—è —Å–µ—Ä–∏—è: ${n} ${decl(n,['–¥–µ–Ω—å','–¥–Ω—è','–¥–Ω–µ–π'])}`);
    } else {
      const title = 'üèÜ –ù–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥–∞!';
      const body  = `–ó–∞–≤–µ—Ä—à–µ–Ω–æ –ø—Ä–∏–≤—ã—á–µ–∫: ${n}. –î–µ—Ä–∂–∏—à—å —Ç–µ–º–ø!`;
      openModal(title, body);
      tryToast(`–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –ø—Ä–∏–≤—ã—á–∫–∏: ${n}`);
    }
    trySparkles();

    // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –≤—ã–¥–∞–Ω–Ω—É—é
    log[type][n] = isoDate(new Date());
    setLog(log);
  }

  // –ü–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ª–æ–≥–∞
  function checkForNewRewards(){
    const {streak, mastered} = currentSnapshot();
    const log = getLog();

    // –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ù–ï–≤—ã–¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    const newStreaks   = STREAK_STEPS.filter(m => streak   >= m && !(log.streak   && log.streak[m]));
    const newMastereds = MASTERED_STEPS.filter(m => mastered>= m && !(log.mastered && log.mastered[m]));

    // –ï—Å–ª–∏ —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ ‚Äî –≤—ã–¥–∞—ë–º –ø–æ –æ–¥–Ω–æ–º—É –∑–∞ –ø—Ä–æ—Ö–æ–¥ (—á—Ç–æ–±—ã –º–æ–¥–∞–ª–∫–∏ –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–ª–∏—Å—å)
    if(newStreaks.length){
      award('streak', newStreaks[newStreaks.length-1]); // —Å–∞–º—ã–π –∫—Ä—É–ø–Ω—ã–π –ø–æ—Ä–æ–≥
      return true;
    }
    if(newMastereds.length){
      award('mastered', newMastereds[newMastereds.length-1]);
      return true;
    }
    return false;
  }

  // –¢—Ä–∏–≥–≥–µ—Ä—ã: –∫–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å
  // 1) –ö–ª–∏–∫ –ø–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –æ—Ç–º–µ—Ç–∫–µ
  document.addEventListener('click', (e)=>{
    const t = e.target.closest('.today-check,.check');
    if(t){
      // –î–∞–¥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –æ–±–Ω–æ–≤–∏—Ç—å state, –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä–∏–º
      setTimeout(checkForNewRewards, 120);
      // –¢–∞–∫–∂–µ –ø–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è ‚Äî –æ–±–Ω–æ–≤–∏–º streak –≤ –ø—Ä–æ—Ñ–∏–ª–µ (–µ—Å–ª–∏ –±–∞–∑–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ —É—Å–ø–µ–ª)
      setTimeout(()=>{ try{ if(typeof window.renderProfile==='function') window.renderProfile(); }catch(e){} }, 150);
    }
  }, {capture:true, passive:true});

  // 2) –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ localStorage –∏–∑ –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
  window.addEventListener('storage', (e)=>{
    if(e.key === STORAGE_KEY){
      setTimeout(checkForNewRewards, 80);
    }
  });

  // 3) –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)
  setInterval(checkForNewRewards, 1000);

  // 4) –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å—Ç–∞—Ä—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî —Å—Ä–∞–∑—É —Å–≤–µ—Ä–∏–º
  document.addEventListener('DOMContentLoaded', ()=>{ setTimeout(checkForNewRewards, 150); });

  // 5) –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∞ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è ‚Äî –ø—Ä–æ–≤–µ—Ä–∏–º –µ—â—ë —Ä–∞–∑ –ø–æ—Å–ª–µ –Ω–∏—Ö
  try{
    const origRenderAll = window.renderAll;
    window.renderAll = function(){
      if(typeof origRenderAll === 'function') origRenderAll();
      // –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á
      setTimeout(checkForNewRewards, 80);
    };
  }catch(e){}
})();
</script>



<!-- === PATCH: STREAK FIX ONLY (recompute + chip update) === -->
<script>
(function(){
  const STORAGE_KEY = 'habit_traker_demo_v3';

  function getState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); }catch(e){ return null; } }
  function setState(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){} }

  function isoDate(d){
    const t = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    return t.toISOString().slice(0,10);
  }
  function decl(n, forms){
    n = Math.abs(n) % 100; var n1 = n % 10;
    if (n>10 && n<20) return forms[2];
    if (n1>1 && n1<5) return forms[1];
    if (n1==1) return forms[0];
    return forms[2];
  }

  function computeStreakFromState(s){
    if(!s || !Array.isArray(s.habits) || s.habits.length===0) return 0;
    let streak = 0;
    const d = new Date();
    while(true){
      const key = isoDate(d);
      const anyDone = s.habits.some(h => Array.isArray(h.days) && h.days.includes(key));
      if(anyDone){ streak++; d.setDate(d.getDate()-1); } else { break; }
    }
    return streak;
  }

 // –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç "–∑–æ–ª–æ—Ç–æ–≥–æ —á–∏–ø–∞" –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
// –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å habitId; –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω ‚Äî –±–µ—Ä—ë–º –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
function updateGoldChipText(habitId){
  // –ë–µ—Ä—ë–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π state
  const s = (typeof getState === 'function' ? (getState() || {}) : {});
  const habits = Array.isArray(s.habits) ? s.habits : [];
  const id = habitId || s.currentHabitId || (habits[0] && habits[0].id);
  if(!id) return;

  const h = habits.find(x => x.id === id);
  if(!h) return;

  const { currentDay, total } = computeProgress(h);

  // –ò—â–µ–º —á–∏–ø –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø—Ä–∏–≤—ã—á–∫–∏; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ–±—â–∏–π fallback
  const card = document.querySelector(`[data-habit-id="${h.id}"]`) || document;
  const chip = card.querySelector('.gold-chip')
            || card.querySelector('.chip.gold')
            || document.querySelector('.gold-chip');
  if(!chip) return;

  chip.textContent = `${currentDay}/${total}`;
}


  function ensureGoldChip(){
    const profile = document.getElementById('view-profile');
    if(!profile) return;
    const name = profile.querySelector('.name');
    let holder = document.getElementById('series-chip-holder');
    if(!holder){
      holder = document.createElement('div');
      holder.id = 'series-chip-holder';
      holder.className = 'series-chip-place';
      if(name && name.parentElement){ name.parentElement.after(holder); } else { profile.prepend(holder); }
    }
    let chip = document.getElementById('series-chip-gold');
    if(!chip){
      chip = document.createElement('span');
      chip.id = 'series-chip-gold';
      chip.className = 'series-chip-gold';
      chip.innerHTML = '<span class="flame">üî•</span><span class="series-text">–°–µ—Ä–∏—è 0 –¥–Ω–µ–π</span>';
      holder.innerHTML = '';
      holder.appendChild(chip);
    }
  }

 function recomputeAndPersist(){
  const s = getState() || {};
  s.profile = s.profile || { streak: 0 };

  const v = computeStreakFromState(s);
  if (s.profile.streak !== v) s.profile.streak = v;

  setState(s);

  // 1) –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å DOM
  renderAll();

  // 2) –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç ¬´–∑–æ–ª–æ—Ç–æ–≥–æ —á–∏–ø–∞¬ª –ü–û–°–õ–ï —Ä–µ–Ω–¥–µ—Ä–∞
  // (requestAnimationFrame –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ DOM —É–∂–µ –Ω–∞ –º–µ—Å—Ç–µ)
  requestAnimationFrame(updateGoldChipText);
}


  document.addEventListener('DOMContentLoaded', function(){
    // Initial compute & render
    ensureGoldChip();
    recomputeAndPersist();

    // Recompute after toggling "–°–µ–≥–æ–¥–Ω—è"
    document.addEventListener('click', function(e){
      if(e.target.closest('.today-check,.check')){
        setTimeout(recomputeAndPersist, 120);
      }
    }, {capture:true, passive:true});
  });
})();
</script>
<!-- === /PATCH: STREAK FIX ONLY === -->


<script>
document.addEventListener('DOMContentLoaded', function(){
  var chip = document.getElementById('series-chip-gold');
  if(chip){
    var hasText = !!chip.querySelector('.series-text');
    if(!hasText){
      chip.innerHTML = '<span class="flame">üî•</span><span class="series-text">–°–µ—Ä–∏—è 0 –¥–Ω–µ–π</span>';
    }
  }
});
</script>


<!-- === v13: Consolidated Rewards + Streak + Congrats (self-contained) === -->
<style>
  /* Modal (ensures present and topmost) */
  .achv-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.60);display:none;align-items:center;justify-content:center;z-index:2147483647;backdrop-filter:blur(3px)}
  .achv-backdrop.show{display:flex}
  body.modal-open{overflow:hidden}
  .achv-modal{width:min(92vw,380px);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(0,0,0,.30));border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:18px 16px 16px;box-shadow:0 18px 50px rgba(0,0,0,.55);animation:achv-pop .45s ease both}
  @keyframes achv-pop{0%{transform:scale(.86);opacity:0}60%{transform:scale(1.04);opacity:1}100%{transform:scale(1)}}
  .achv-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .achv-icon{font-size:22px;line-height:1;background:radial-gradient(80% 140% at 20% 0%,#ffef9a,#ffd166 50%,#f7b733 80%);padding:8px;border-radius:14px;border:1px solid rgba(255,215,120,.85);box-shadow:0 8px 22px rgba(247,183,51,.35),inset 0 1px 0 rgba(255,255,255,.45)}
  .achv-title{font-weight:900;font-size:16px}
  .achv-body{color:var(--muted);font-size:14px;margin-bottom:12px}
  .achv-actions{display:flex;gap:8px;justify-content:flex-end}
  .btn{padding:10px 12px;border-radius:12px;cursor:pointer;border:1px solid rgba(255,255,255,.12);background:var(--panel);color:#e6eef3}
  .btn.primary{background:linear-gradient(90deg,#ffd166,#f7b733);color:#1a1400;font-weight:800;border-color:rgba(255,215,120,.85);box-shadow:0 10px 20px rgba(247,183,51,.35)}
  /* Chip visibility */
  #profile-streak{display:none!important;height:0!important;overflow:hidden!important}
  .series-chip-gold{display:inline-flex!important;align-items:center!important;gap:8px!important;padding:8px 12px!important;border-radius:999px;font-weight:800;font-size:13px;letter-spacing:.2px;color:#1a1400;background:radial-gradient(80% 140% at 20% 0%,#ffef9a,#ffd166 50%,#f7b733 80%);border:1px solid rgba(255,215,120,.85);box-shadow:0 6px 22px rgba(247,183,51,.35),inset 0 1px 0 rgba(255,255,255,.45),inset 0 -2px 8px rgba(179,112,0,.25);white-space:nowrap}
  .series-chip-gold .series-text{display:inline!important;visibility:visible!important;opacity:1!important;color:#1a1400!important;font-weight:800}
</style>

<!-- Ensure modal exists -->
<div class="achv-backdrop" id="achv-backdrop" aria-hidden="true" style="display:none">
  <div class="achv-modal" role="dialog" aria-modal="true" aria-labelledby="achv-title">
    <div class="achv-header">
      <div class="achv-icon">üèÜ</div>
      <div class="achv-title" id="achv-title">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ù–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ</div>
    </div>
    <div class="achv-body" id="achv-text">–í—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –Ω–∞–≥—Ä–∞–¥—É.</div>
    <div class="achv-actions">
      <button class="btn" id="achv-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn primary" id="achv-ok">–ö–ª–∞—Å—Å!</button>
    </div>
  </div>
</div>

<script>
(function(){
  const STORAGE_KEY='habit_traker_demo_v3';
  const LOG_KEY=STORAGE_KEY+'_achvlog';
  const STREAK_STEPS=[7,14,21,30,45,60,75,90,100,120];
  const MASTERED_STEPS=[1,2,3,4,5];

  /* ==== utils ==== */
  function getState(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');}catch(e){return null;}}
  function setState(s){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(s));}catch(e){}}
  function getLog(){try{return JSON.parse(localStorage.getItem(LOG_KEY)||'{"streak":{},"mastered":{}}');}catch(e){return{streak:{},mastered:{}};}}
  function setLog(l){try{localStorage.setItem(LOG_KEY,JSON.stringify(l));}catch(e){}}
  function isoDate(d){const t=new Date(d.getFullYear(),d.getMonth(),d.getDate());return t.toISOString().slice(0,10);}
  function decl(n,f){n=Math.abs(n)%100;const n1=n%10;if(n>10&&n<20)return f[2];if(n1>1&&n1<5)return f[1];if(n1==1)return f[0];return f[2];}
  function ensureFields(s){s.profile=s.profile||{name:'–ì–æ—Å—Ç—å',avatar:'',streak:0};s.profile.badges=s.profile.badges||{streak:[],mastered:[]};}
  function snapshotHabits(s){const m=new Map();(s?.habits||[]).forEach(h=>{const t=h?.targetDays?Math.max(1,h.targetDays):null;const set=new Set(Array.isArray(h?.days)?h.days.slice():[]);m.set(h.id,{target:t,set,count:set.size});});return m;}
  function masteredCount(snap){let c=0;snap.forEach(v=>{if(v.target&&v.count>=v.target)c++;});return c;}
  function computeStreakFromState(s){if(!s||!Array.isArray(s.habits)||s.habits.length===0)return 0;let streak=0;const d=new Date();while(true){const key=isoDate(d);const any=s.habits.some(h=>Array.isArray(h.days)&&h.days.includes(key));if(any){streak++;d.setDate(d.getDate()-1);}else{break;}}return streak;}

  /* ==== modal ==== */
  function openModal(m){const b=document.getElementById('achv-backdrop'),t=document.getElementById('achv-text');if(!b||!t)return;t.textContent=m||'–í—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –Ω–∞–≥—Ä–∞–¥—É.';b.style.display='flex';b.classList.add('show');document.body.classList.add('modal-open');}
  function closeModal(){const b=document.getElementById('achv-backdrop');if(!b)return;b.classList.remove('show');b.style.display='none';document.body.classList.remove('modal-open');}
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});
  document.getElementById('achv-ok')?.addEventListener('click',closeModal,{passive:true});
  document.getElementById('achv-close')?.addEventListener('click',closeModal,{passive:true});
  document.getElementById('achv-backdrop')?.addEventListener('click',e=>{if(e.target.id==='achv-backdrop')closeModal();},{passive:true});

  /* ==== chip ==== */
  function ensureChip(){const p=document.getElementById('view-profile');if(!p)return;const name=p.querySelector('.name');let holder=document.getElementById('series-chip-holder');if(!holder){holder=document.createElement('div');holder.id='series-chip-holder';holder.className='series-chip-place';if(name&&name.parentElement)name.parentElement.after(holder);else p.prepend(holder);}let chip=document.getElementById('series-chip-gold');if(!chip){chip=document.createElement('span');chip.id='series-chip-gold';chip.className='series-chip-gold';chip.innerHTML='<span class="flame">üî•</span><span class="series-text">–°–µ—Ä–∏—è 0 –¥–Ω–µ–π</span>';holder.innerHTML='';holder.appendChild(chip);}p.querySelectorAll('#streak-chip-el').forEach(n=>n.remove());holder.querySelectorAll('span').forEach(n=>{if(n.id!=='series-chip-gold')n.remove();});}
  function updateChip(){const s=getState()||{};ensureFields(s);const chip=document.getElementById('series-chip-gold');if(!chip)return;const v=s.profile.streak||0;const span=chip.querySelector('.series-text');if(span)span.textContent='–°–µ—Ä–∏—è '+v+' '+decl(v,['–¥–µ–Ω—å','–¥–Ω—è','–¥–Ω–µ–π']);}

  /* ==== medals render fallback (if window.renderBadges missing) ==== */
  function maybeRenderMedals(s){const box=document.getElementById('medals');if(!box) return; if(typeof window.renderBadges==='function'){try{window.renderBadges(s);}catch(_){}}}

  /* ==== recompute streak once on load ==== */
  document.addEventListener('DOMContentLoaded',function(){
    // initial recompute & chip
    let s=getState()||{}; ensureFields(s);
    const v=computeStreakFromState(s); if(s.profile.streak!==v){s.profile.streak=v; setState(s);}
    ensureChip(); updateChip();
  });

  /* ==== main click hook ==== */
  document.addEventListener('click',function(e){
    const today=!!e.target.closest('.today-check,.check');
    const nav=e.target.closest('.nav-btn'); if(!today && !(nav&&nav.dataset&&nav.dataset.view==='view-profile')) return;

    // snapshots before
    const date=isoDate(new Date());
    let prevSnap=null, prevMasteredBadges=null, prevStreakBadges=null;
    if(today){const sp=getState()||{}; ensureFields(sp); prevSnap=snapshotHabits(sp); prevMasteredBadges=new Set((sp.profile.badges?.mastered)||[]); prevStreakBadges=new Set((sp.profile.badges?.streak)||[]);}

    setTimeout(function(){
      let s=getState()||{}; ensureFields(s);

      // recompute streak (so it updates even if app didn't)
      const v=computeStreakFromState(s); if(s.profile.streak!==v){s.profile.streak=v; setState(s);}
      ensureChip(); updateChip();

      if(today){
        const nextSnap=snapshotHabits(s);
        const log=getLog(); log.mastered[date]=log.mastered[date]||{}; log.streak[date]=log.streak[date]||{};

        // exact last day completion
        let doneId=null;
        nextSnap.forEach((n,id)=>{
          const p=prevSnap.get(id); if(!p) return;
          const delta=n.count-p.count;
          const todayWas=p.set.has(date), todayNow=n.set.has(date);
          const hitsTargetNow=!!n.target && n.count===n.target;
          if(delta===1 && !todayWas && todayNow && hitsTargetNow && !log.mastered[date][id]) doneId=id;
        });
        if(doneId){
          log.mastered[date][doneId]=true; setLog(log);
          // thresholds for mastered (1..5)
          const pc=[...prevSnap.values()].filter(v=>v.target&&v.count>=v.target).length;
          const nc=[...nextSnap.values()].filter(v=>v.target&&v.count>=v.target).length;
          if(nc>pc){
            let add=0; for(const step of [1,2,3,4,5]){ if(nc>=step && !prevMasteredBadges.has(step)) add=step; }
            if(add){
              const setM=new Set(s.profile.badges.mastered||[]); setM.add(add);
              s.profile.badges.mastered=[...setM].sort((a,b)=>a-b); setState(s); maybeRenderMedals(s);
            }
          }
          openModal('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ü—Ä–∏–≤—ã—á–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ üéâ');
        }

        // streak thresholds
        const cur=s.profile.streak||0;
        let addS=0; for(const n of STREAK_STEPS){ if(cur>=n && !prevStreakBadges.has(n)) addS=n; }
        if(addS && !getLog().streak[date]?.[addS]){
          const log2=getLog(); log2.streak[date]=log2.streak[date]||{}; log2.streak[date][addS]=true; setLog(log2);
          const setS=new Set(s.profile.badges.streak||[]); setS.add(addS);
          s.profile.badges.streak=[...setS].sort((a,b)=>a-b); setState(s); maybeRenderMedals(s);
          openModal('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ù–æ–≤–∞—è —Å–µ—Ä–∏—è: '+addS+' '+decl(addS,['–¥–µ–Ω—å','–¥–Ω—è','–¥–Ω–µ–π']));
        }
      }

      if(nav && nav.dataset && nav.dataset.view==='view-profile'){ ensureChip(); updateChip(); }
    }, today?140:70);
  },{capture:true,passive:true});
})();
</script>
<!-- === /v13 === -->


<!-- === PATCH: Yandex fix ‚Äî remove streak before awards + inline editable name (no observers) === -->
<style>
  /* Hide streak chip in awards region */
  #series-chip-holder, #series-chip-gold { display: none !important; }
 /* editable name: subtle affordance */
#view-profile .name,
#profile-name {
  cursor: text;
  border-bottom: 1px dashed rgba(255,255,255,.25);
  display: inline-block;
  padding: 0 4px;
  margin: 0 auto;
}

</style>
<script>
(function(){
  try{
    var STORAGE_KEY = 'habit_traker_demo_v3';
    function getState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null'); }catch(e){ return null; } }
    function setState(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){} }

    function wireEditableName(){
      var profile = document.getElementById('view-profile') || document.body;
      if(!profile) return;
      var nameEl = profile.querySelector('#profile-name') || profile.querySelector('.name');
      if(!nameEl) return;

      // hydrate from storage once
      var s = getState() || {};
      if(s && s.profile && s.profile.name){
        nameEl.textContent = s.profile.name;
      }

      if(nameEl.getAttribute('data-editable') === '1') return;
      nameEl.setAttribute('data-editable', '1');
      nameEl.title = '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è';

      nameEl.addEventListener('click', function onClick(){
        if(nameEl.querySelector('input')) return;
        var current = (nameEl.textContent || '').trim();
        var input = document.createElement('input');
        input.type = 'text';
        input.value = current;
        input.maxLength = 40;
        input.style.width = Math.max(140, (current.length||1)*10) + 'px';
        input.style.font = 'inherit';
        input.style.color = 'inherit';
        input.style.background = 'transparent';
        input.style.border = '1px solid rgba(255,255,255,.3)';
        input.style.borderRadius = '8px';
        input.style.padding = '4px 8px';
        input.style.outline = 'none';

        nameEl.innerHTML = '';
        nameEl.appendChild(input);
        input.focus(); input.select();

        function commit(save){
          var newName = (input.value || '').trim() || current;
          nameEl.innerHTML = '';
          nameEl.textContent = save ? newName : current;
          if(save){
            var st = getState() || {};
            if(!st) st = {};
            st.profile = st.profile || {};
            st.profile.name = newName;
            setState(st);
            var mirrors = document.querySelectorAll('[data-profile-name]');
            for(var i=0;i<mirrors.length;i++){ mirrors[i].textContent = newName; }
          }
          // re-arm click
          setTimeout(function(){ nameEl.addEventListener('click', onClick, { once: true }); }, 0);
        }

        input.addEventListener('keydown', function(e){
          if(e.key === 'Enter'){ commit(true); }
          else if(e.key === 'Escape'){ commit(false); }
        });
        input.addEventListener('blur', function(){ commit(true); }, { once: true });

        nameEl.removeEventListener('click', onClick);
      }, { once: true });
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', wireEditableName);
    } else {
      wireEditableName();
    }

    // Also wire when user clicks nav to profile (without MutationObserver)
    document.addEventListener('click', function(e){
      var nav = e.target && e.target.closest ? e.target.closest('.nav-btn') : null;
      if(nav && nav.dataset && nav.dataset.view === 'view-profile'){
        setTimeout(wireEditableName, 60);
      }
    }, true);
  }catch(e){
    // swallow to avoid blocking load in strict browsers
    try{ console.warn('Yandex patch error:', e); }catch(_){}
  }
})();
</script>
<!-- === /PATCH: Yandex fix === -->


<script>
/* kbfix: visualViewport */
(function(){
  function setVH(){
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setVH();
  window.addEventListener('resize', setVH, {passive:true});
  window.addEventListener('orientationchange', setVH, {passive:true});

  function isInput(el){
    return el && (el.tagName==='INPUT' || el.tagName==='TEXTAREA' || el.isContentEditable);
  }
 function toggleKB(open){
  document.body.classList.toggle('kb-open', !!open);
  if(open){
    try{
      // –°–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç
      var chatView = document.getElementById('view-chat');
      if (chatView && !chatView.classList.contains('hidden')) {
        var messages = document.getElementById('messages');
        if (messages) {
          messages.scrollTop = messages.scrollHeight;
        }
      }
    }catch(e){}
  }
}

  var vv = window.visualViewport;
  function updateKB(){
    if(!vv){ return; }
    var kb = Math.max(0, window.innerHeight - (vv.height + vv.offsetTop));
    document.documentElement.style.setProperty('--kb', kb + 'px');
    toggleKB(kb > 0);
  }
  if(vv){
    vv.addEventListener('resize', updateKB, {passive:true});
    vv.addEventListener('scroll', updateKB, {passive:true});
    updateKB();
  }

  document.addEventListener('focusin', function(e){
    if(isInput(e.target)){ setTimeout(updateKB, 50); setTimeout(updateKB, 250); }
  }, {passive:true});
  document.addEventListener('focusout', function(e){
    if(isInput(e.target)){ setTimeout(updateKB, 50); setTimeout(updateKB, 250); }
  }, {passive:true});
})();
</script>


<script>
// boot-awards: recompute streak & awards on startup
(function(){
  const STORAGE_KEY = 'habit_traker_demo_v3';
  function getState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); }catch(e){ return null; } }
  function setState(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){} }
  function isoDate(d){ const t = new Date(d.getFullYear(), d.getMonth(), d.getDate()); return t.toISOString().slice(0,10); }
  function computeStreakFromState(s){
    try{
      let streak = 0;
      const d = new Date();
      while(true){
        const key = isoDate(d);
        const anyDone = (s?.habits||[]).some(h => Array.isArray(h?.days) && h.days.includes(key));
        if(anyDone){ streak++; d.setDate(d.getDate()-1); } else { break; }
      }
      return streak;
    }catch(e){ return 0; }
  }
  try{
    const s = getState() || {profile:{}, habits:[]};
    s.profile = s.profile || {};
    const newStreak = computeStreakFromState(s);
    if(typeof newStreak === 'number' && newStreak >= 0){
      s.profile.streak = newStreak;
      setState(s);
    }
  }catch(e){}

  // Trigger UI/badges re-render ASAP
  try{
    if(typeof window.renderAll === 'function'){ window.renderAll(); }
    if(typeof window.renderProfile === 'function'){ window.renderProfile(); }
    // Fallback notify
    document.dispatchEvent(new CustomEvent('badges:refresh'));
  }catch(e){}
})();
</script>

  <script>
(function(){
  const STORAGE_KEY = 'habit_traker_demo_v3';
  const AWARDS_KEY  = STORAGE_KEY + '_habitAwards_v1';
  const STREAK_STEPS = [7,14,21,30,45,60,75,90,100,120];

  function isoDate(d){
    const t = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    return t.toISOString().slice(0,10);
  }

  function getState(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null'); }
    catch(e){ return null; }
  }

  function loadAwards(){
    try{
      const raw = localStorage.getItem(AWARDS_KEY);
      const d = raw ? JSON.parse(raw) : null;
      if(!d || typeof d !== 'object') return { streak:{}, complete:{} };
      if(!d.streak) d.streak = {};
      if(!d.complete) d.complete = {};
      return d;
    }catch(e){
      return { streak:{}, complete:{} };
    }
  }

  function saveAwards(a){
    try{ localStorage.setItem(AWARDS_KEY, JSON.stringify(a || {streak:{}, complete:{}})); }
    catch(e){}
  }
    // –£–¥–∞–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø—Ä–∏–≤—ã—á–∫–æ–π
  // keepIfCompleted === true  ‚Üí –ø—Ä–∏–≤—ã—á–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ù–ò–ß–ï–ì–û –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
  function purgeHabitFromAwards(habitId, keepIfCompleted){
    if(!habitId) return;
    const a = loadAwards();
    if(!a) return;

    if (keepIfCompleted) {
      // –ü—Ä–∏–≤—ã—á–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî –≤—Å–µ –µ—ë –Ω–∞–≥—Ä–∞–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è
      saveAwards(a);
      return;
    }

    // –ü—Ä–∏–≤—ã—á–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî —á–∏—Å—Ç–∏–º –≤—Å–µ –µ—ë –Ω–∞–≥—Ä–∞–¥—ã
    if (a.streak && a.streak[habitId]) {
      delete a.streak[habitId];
    }
    if (a.complete && a.complete[habitId]) {
      delete a.complete[habitId];
    }

    saveAwards(a);
  }

  // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–∞—Ç—á–µ–π
  window.purgeHabitFromAwards = purgeHabitFromAwards;


  // –°–µ—Ä–∏—è –ö–û–ù–ö–†–ï–¢–ù–û–ô –ø—Ä–∏–≤—ã—á–∫–∏ (—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ —É –Ω–µ—ë –µ—Å—Ç—å –æ—Ç–º–µ—Ç–∫–∞)
  function computeHabitStreak(h){
    const arr = Array.isArray(h && h.days) ? h.days : [];
    if(!arr.length) return 0;
    const set = new Set(arr);
    let d = new Date();
    let streak = 0;
    while(true){
      const key = isoDate(d);
      if(set.has(key)){
        streak++;
        d.setDate(d.getDate() - 1);
      } else {
        break;
      }
    }
    return streak;
  }

 function scanAwards(){
  const s = getState();
  if(!s || !Array.isArray(s.habits)) {
    renderAwardsUI({habits:[]}, loadAwards());
    return;
  }

  const awards = loadAwards();
  let changed = false;
  const todayIso = isoDate(new Date());
  const created = []; // —Å—é–¥–∞ —Å–∫–ª–∞–¥—ã–≤–∞–µ–º –ù–û–í–´–ï –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ —ç—Ç–æ—Ç –ø—Ä–æ—Ö–æ–¥

  (s.habits || []).forEach(h=>{
    if(!h || !h.id) return;
    const hid  = h.id;
    const name = (h.name || '–ü—Ä–∏–≤—ã—á–∫–∞').trim();

    // --- –°–µ—Ä–∏—è –ø–æ –ø—Ä–∏–≤—ã—á–∫–µ ---
    const curStreak = computeHabitStreak(h);
    if(!awards.streak[hid]) awards.streak[hid] = {}; // map: –ø–æ—Ä–æ–≥ -> –¥–∞—Ç–∞

    STREAK_STEPS.forEach(step=>{
      const already = !!awards.streak[hid][step];
      if(curStreak >= step && !already){
        awards.streak[hid][step] = todayIso;
        changed = true;
        created.push({kind:'streak', habitName:name, step, date:todayIso});
        try{
          if(typeof window.showToast === 'function'){
            window.showToast(`–ù–æ–≤–∞—è —Å–µ—Ä–∏—è –ø–æ "${name}": ${step} –¥–Ω–µ–π!`);
          }
        }catch(e){}
      }
    });

    // --- –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ ---
    const days   = Array.isArray(h.days) ? h.days.length : 0;
    const target = typeof h.targetDays === 'number'
      ? Math.max(1, h.targetDays)
      : null;

    if(target && days >= target){
      if(!awards.complete[hid]){
        awards.complete[hid] = todayIso;
        changed = true;
        created.push({kind:'complete', habitName:name, date:todayIso});
        try{
          if(typeof window.showToast === 'function'){
            window.showToast(`–ü—Ä–∏–≤—ã—á–∫–∞ "${name}" –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!`);
          }
        }catch(e){}
      }
    }
  });

  if(changed) saveAwards(awards);
  renderAwardsUI(s, awards);

  // –ï—Å–ª–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ –Ω–∞–≥—Ä–∞–¥—ã ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ü–õ–ê–®–ö–£ —Å –∫—É–±–∫–æ–º + –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
  if(created.length){
    const last = created[created.length - 1]; // –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–≥—Ä–∞–¥–∞
    try{
      if(typeof window.__habitAchvModal === 'function'){
        if(last.kind === 'streak'){
          const title = 'üî• –ù–æ–≤–∞—è —Å–µ—Ä–∏—è –ø–æ –ø—Ä–∏–≤—ã—á–∫–µ';
          const body  = `–ü–æ –ø—Ä–∏–≤—ã—á–∫–µ ¬´${last.habitName}¬ª ‚Äî ${last.step} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥. –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!`;
          window.__habitAchvModal(title, body);
        } else {
          const title = 'üèÜ –ü—Ä–∏–≤—ã—á–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞';
          const body  = `–ü—Ä–∏–≤—ã—á–∫–∞ ¬´${last.habitName}¬ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –≠—Ç–æ —Å–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!`;
          window.__habitAchvModal(title, body);
        }
      }
      if(typeof window.__habitAchvSparkles === 'function'){
        window.__habitAchvSparkles();
      }
    }catch(e){}
  }
}


  // –†–µ–Ω–¥–µ—Ä –±–ª–æ–∫–∞ –Ω–∞–≥—Ä–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
  function renderAwardsUI(state, awards){
    const box = document.getElementById('medals');
    if(!box) return;
    awards = awards || loadAwards();

    const habits = Array.isArray(state && state.habits) ? state.habits : [];
    const byId = new Map();
    habits.forEach(h=>{ if(h && h.id) byId.set(h.id, h); });

    const list = [];

    // –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –Ω–∞–≥—Ä–∞–¥–∞–º –∏ —Å–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫
    Object.keys(awards.streak || {}).forEach(hid=>{
      const streakMap = awards.streak[hid] || {};
      const h = byId.get(hid);
      const habitName = (h && h.name) ? h.name : '–ü—Ä–∏–≤—ã—á–∫–∞';

      Object.keys(streakMap).forEach(stepStr=>{
        const step = Number(stepStr);
        list.push({
          type: 'streak',
          step,
          date: streakMap[stepStr],
          habitName
        });
      });
    });

    Object.keys(awards.complete || {}).forEach(hid=>{
      const h = byId.get(hid);
      const habitName = (h && h.name) ? h.name : '–ü—Ä–∏–≤—ã—á–∫–∞';
      list.push({
        type: 'complete',
        step: null,
        date: awards.complete[hid],
        habitName
      });
    });

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–≤–µ–∂–∏–µ –≤—ã—à–µ, –≤–Ω—É—Ç—Ä–∏ ‚Äî –ø–æ —Ç–∏–ø—É/–∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–Ω–µ–π
    list.sort((a,b)=>{
      if(a.date === b.date){
        if(a.type === b.type){
          return (b.step || 0) - (a.step || 0);
        }
        // –ø–æ–ª–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —á—É—Ç—å –≤—ã—à–µ
        return a.type === 'complete' ? -1 : 1;
      }
      return a.date < b.date ? 1 : -1; // —Å–≤–µ–∂–∏–µ —Å–Ω–∞—á–∞–ª–∞
    });

    box.innerHTML = '';

    if(!list.length){
      const empty = document.createElement('div');
      empty.className = 'sub';
      empty.textContent = '–ù–∞–≥—Ä–∞–¥ –ø–æ–∫–∞ –Ω–µ—Ç. –î–µ–ª–∞–π –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –∏ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è ‚ú®';
      box.appendChild(empty);
      return;
    }

    list.forEach(aw=>{
      const card = document.createElement('div');
      card.className = 'badge unlocked';
      card.dataset.awType  = aw.type;
      card.dataset.awStep  = aw.step || '';
      card.dataset.awHabit = aw.habitName || '–ü—Ä–∏–≤—ã—á–∫–∞';
      card.dataset.awDate  = aw.date || '';

      const labelType = aw.type === 'streak' ? '–°–µ—Ä–∏—è' : '–ü—Ä–∏–≤—ã—á–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞';
      const valueText = aw.type === 'streak' ? `${aw.step} –¥–Ω–µ–π` : '';
      const icon = aw.type === 'streak' ? 'üî•' : 'üèÜ';

      card.innerHTML = `
        <div class="aura"></div>
        <div class="badge-icon">${icon}</div>
        <div class="label">${labelType}</div>
        <div class="value">${valueText}</div>
        <div class="badge-habit-name">${aw.habitName || ''}</div>
      `;

      box.appendChild(card);
    });

    wireAwardPopups();
  }

  // –ü–æ–ø-–∞–ø –ø–æ –∫–ª–∏–∫—É –Ω–∞ –Ω–∞–≥—Ä–∞–¥—É
  function wireAwardPopups(){
    const backdrop = document.getElementById('reward-popup-backdrop');
    const closeBtn = document.getElementById('reward-popup-close');
    if(!backdrop) return;

    const typeEl  = document.getElementById('reward-popup-type');
    const titleEl = document.getElementById('reward-popup-title');
    const habitEl = document.getElementById('reward-popup-habit');
    const metaEl  = document.getElementById('reward-popup-meta');

    function close(){
      backdrop.classList.add('hidden');
    }

    if(closeBtn && !closeBtn._wired){
      closeBtn._wired = true;
      closeBtn.addEventListener('click', close);
    }
    if(!backdrop._wired){
      backdrop._wired = true;
      backdrop.addEventListener('click', (e)=>{
        if(e.target === backdrop) close();
      });
    }

    const box = document.getElementById('medals');
    if(!box) return;

    box.querySelectorAll('.badge.unlocked').forEach(card=>{
      if(card._wiredPop) return;
      card._wiredPop = true;
      card.addEventListener('click', ()=>{
        const type  = card.dataset.awType;
        const step  = card.dataset.awStep;
        const habit = card.dataset.awHabit || '–ü—Ä–∏–≤—ã—á–∫–∞';
        const date  = card.dataset.awDate;
        let dateHuman = '';
        try{
          if(date){
            dateHuman = new Date(date).toLocaleDateString('ru-RU');
          }
        }catch(e){}

        typeEl.textContent = type === 'streak'
          ? '–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ —Å–µ—Ä–∏—é'
          : '–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é –ø—Ä–∏–≤—ã—á–∫—É';

        titleEl.textContent = type === 'streak'
          ? `${step} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥`
          : '–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞';

        habitEl.textContent = `–ü—Ä–∏–≤—ã—á–∫–∞: ${habit}`;
        metaEl.textContent  = dateHuman ? `–ü–æ–ª—É—á–µ–Ω–æ: ${dateHuman}` : '';

        backdrop.classList.remove('hidden');
      });
    });
  }

  // –î–µ–ª–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –ø–∞—Ç—á–∏ –º–æ–≥–ª–∏ –≤—ã–∑–≤–∞—Ç—å –Ω–∞—à —Ä–µ–Ω–¥–µ—Ä
  window.renderBadges = function(){
    const s = getState() || {habits:[]};
    renderAwardsUI(s, loadAwards());
  };

  // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ renderProfile, —á—Ç–æ–±—ã –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—è—Ç—å –Ω–∞–≥—Ä–∞–¥—ã
  (function hookProfile(){
    const orig = window.renderProfile;
    window.renderProfile = function(){
      if(typeof orig === 'function') orig();
      scanAwards();
    };
  })();

  // –†–µ–∞–∫—Ü–∏—è –Ω–∞ –∫–ª–∏–∫–∏ –ø–æ —á–µ–∫–±–æ–∫—Å–∞–º (–æ—Ç–º–µ—Ç–∫–∞/—Å–Ω—è—Ç–∏–µ ¬´—Å–µ–≥–æ–¥–Ω—è¬ª)
  document.addEventListener('click', (e)=>{
    const t = e.target.closest('.today-check,.check');
    if(t){
      setTimeout(scanAwards, 120);
    }
  }, {capture:true, passive:true});

  // –ü–µ—Ä–≤—ã–π —Å—Ç–∞—Ä—Ç
  document.addEventListener('DOMContentLoaded', ()=>{
    scanAwards();
  });

})();
</script>



  <script>


let tg = window.Telegram.WebApp;
tg.requestFullscreen();

});
</script>

</body>
</html>
